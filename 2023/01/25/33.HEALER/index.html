<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>论文Healer分析和复现 | Ron's Blog</title><meta name="keywords" content="Fuzz,Healer,Syzkaller"><meta name="author" content="Ron"><meta name="copyright" content="Ron"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="对文章Healer的分析和开源代码的环境搭建">
<meta property="og:type" content="article">
<meta property="og:title" content="论文Healer分析和复现">
<meta property="og:url" content="https://lucxer.tech/2023/01/25/33.HEALER/index.html">
<meta property="og:site_name" content="Ron&#39;s Blog">
<meta property="og:description" content="对文章Healer的分析和开源代码的环境搭建">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://kiprey.github.io/2021/11/healer/image-20211129200131315.png">
<meta property="article:published_time" content="2023-01-25T14:12:12.000Z">
<meta property="article:modified_time" content="2024-07-09T14:20:28.217Z">
<meta property="article:author" content="Ron">
<meta property="article:tag" content="Fuzz">
<meta property="article:tag" content="Healer">
<meta property="article:tag" content="Syzkaller">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://kiprey.github.io/2021/11/healer/image-20211129200131315.png"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://lucxer.tech/2023/01/25/33.HEALER/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="preconnect" href="//zz.bdstatic.com"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.js" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"KUPKZYGXJZ","apiKey":"c694052eee4849f0ddc6a25bc8e40d6c","indexName":"blog","hits":{"per_page":6},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isanchor: true
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}

// https://stackoverflow.com/questions/16839698/jquery-getscript-alternative-in-native-javascript
const getScript = url => new Promise((resolve, reject) => {
  const script = document.createElement('script')
  script.src = url
  script.async = true
  script.onerror = reject
  script.onload = script.onreadystatechange = function() {
    const loadState = this.readyState
    if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
    script.onload = script.onreadystatechange = null
    resolve()
  }
  document.head.appendChild(script)
})</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2024-07-09 22:20:28'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = '1'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}const fontSizeVal = saveToLocal.get('global-font-size')
if (fontSizeVal !== undefined) {
  document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
}})()</script><meta name="generator" content="Hexo 5.4.2"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" data-lazy-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">39</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">68</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://kiprey.github.io/2021/11/healer/image-20211129200131315.png)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Ron's Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">论文Healer分析和复现</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-01-25T14:12:12.000Z" title="发表于 2023-01-25 22:12:12">2023-01-25</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-07-09T14:20:28.217Z" title="更新于 2024-07-09 22:20:28">2024-07-09</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%A8%A1%E7%B3%8A%E6%B5%8B%E8%AF%95/">模糊测试</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">12.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>55分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="0x00-写在前面"><a href="#0x00-写在前面" class="headerlink" title="0x00 写在前面"></a>0x00 写在前面</h2><p>本文主要是阅读了文章 <a target="_blank" rel="noopener" href="http://www.wingtecher.com/themes/WingTecherResearch/assets/papers/healer-sosp21.pdf">Healer</a> 后，对文章的内容进行理解，然后基于作者维护的开源工具 <a target="_blank" rel="noopener" href="https://github.com/SunHao-0/healer">Healer</a> 进行一个环境搭建和复现。希望以此记录学习过程。</p>
<h2 id="0x01-方法原理"><a href="#0x01-方法原理" class="headerlink" title="0x01 方法原理"></a>0x01 方法原理</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>考虑到 Syzkaller 在产生（generation&amp;mutation）系统调用序列（program）的过程中，系统调用（syscall）是按照系统调用描述（syscall discriptions）和选择表（choice table）来添加的。这使得同一个输入中相邻两个系统调用之间可能没有影响关系，从而生成大量无意义或者等价的输入，降低模糊测试的效率。Healer 在 Syzkaller 的启发下，也使用了 Syzkaller 所提供的 syscall 信息来生成确认参数结构约束和部分语义约束的系统调用序列，并通过不断执行生成的调用序列来发现内核错误，导致内核崩溃。与 Syzkaller 不同的是，Healer 不使用 choice table，而是通过动态移除最小化调用序列中的系统调用并观察覆盖范围变化来检测不同系统调用之间的内部关系，并通过利用系统调用之间的关系来指导系统调用序列的生成和变异。</p>
<p>确认系统调用间的关系，选择有效的序列并建立有效的探索路径具有重要价值：</p>
<ol>
<li>排除无效序列有助于提升fuzzing的效率。Linux拥有接近400个不同的系统调用，穷举组合的时间开销巨大。</li>
<li>通过建立有效的状态路径助于探索内核的深层逻辑</li>
</ol>
<blockquote>
<p>这个出发点是很好理解的，例如，在一个输入 $program=syscall_1, syscall_2, \cdots , syscall_n$ 中，如果前一个系统调用 $syscall_i$ 的执行对其后紧接着的下一个系统调用 $syscall_j$ 的执行毫无影响，则这个输入中，系统调用 $syscall_i$ 的存在将没有什么意义，即移除该系统调用后得到的新输入是等效的。而通过对关系的学习，可以在输入生成阶段有效避免生成这种等效的输入，进而提高模糊测试的效率。</p>
</blockquote>
<h3 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h3><p><del>我不想再开启图床，也不想再发送这个文件的过程中还需要打包一份图片，于是选择了使用网图的方式嵌入图片，这个后期可以进行等效处理的，问题不大</del>。</p>
<p>Healer 使用了 14919 行 Rust 语言来实现，其工作流程如下图所示。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://kiprey.github.io/2021/11/healer/image-20211129200131315.png" alt="Healer 工作流程图"></p>
<p>Healer 从读取系统调用描述（System call Description）和输入语料库（programs corpus）的数据，然后通过其关系学习模块（Relation Leaning）进行分析，获取不同系统调用之间的内部影响关系，生成一个系统调用关系表（Relation Table）。而随着模糊测试过程的继续，输入语料库也会不断进行更新，使得系统调用关系表也会进行同步更新，于是 Healer 将会得到更多的系统调用之间的影响关系。而得到的系统调用关系表将会用于指导后续的输入生成和变异。</p>
<p>Healer 中的关系（Relation）即指的是两个系统调用间是否存在影响，如果一个系统调用 $syscall<em>i$ 的执行可以影响到另一个系统调用 $syscall_j$ 的执行路径（例如， $syscall_i$  修改了 $syscall_j$ 将要依赖的内核内部状态），则称系统调用 $syscall_i$ 对系统调用 $syscall_j$ 产生了影响。此时将会在系统关系调用表 $R(\N \times \N)$ （$\N$ 表示系统调用个数）中记录 $R</em>{i,j}=1$ 。</p>
<ul>
<li>Healer 主体架构运行在主机上，负责多任务执行、虚拟机驱动、执行驱动、种子生产和变异、虚拟机状态同步操作。通过共享内存和 socket 与被 fuzz 的多个 QEMU 虚拟机实例进行通信。</li>
<li>被 fuzz 的每个内核都会运行在一个自己的 QEMU 虚拟机上，通过 socket 与主体通信，通过共享内存获取测试数据。</li>
</ul>
<h3 id="关系学习模块"><a href="#关系学习模块" class="headerlink" title="关系学习模块"></a>关系学习模块</h3><p>关系学习模块（Relation Learning）部分主要分为静态学习（Static Learning）和动态学习（Dynamic Learning）两个部分。通过这两个部分的学习，Healer 能成功通过覆盖范围信息来指导建立起系统调用之间的内部关系信息。</p>
<h4 id="静态学习"><a href="#静态学习" class="headerlink" title="静态学习"></a>静态学习</h4><p>初始时，Healer 根据系统调用描述提供的信息来初始化系统调用关系表，而静态分析主要关注其中的参数类型和返回值类型。</p>
<p>对于任意两个系统调用 $syscall_i$ 和 $syscall_j$ 如果满足下面两个条件：</p>
<ol>
<li>$syscall_i$ 的返回值是一种 <code>resource</code> 类型 $r$ 或者 $syscall_i$ 的任何参数时一个具有向外数据流方向的指针时。（很显然此时 $syscall_i$ 具有向外输出数据流的能力。</li>
<li>$syscall_j$ 中至少有一个参数的类型是具有向内的数据流的 <code>resource</code> 类型 $r$ 或者与 $r$ 兼容的类型 $r’$ 时（例如继承）。（很显然此时 $syscall_j$ 具有被这种数据流影响的可能性。</li>
</ol>
<p>则此时我们可以很容易通过静态分析得知， $syscall<em>i$ 对 $syscall_j$ 是有影响的，所以此时记录 $R</em>{i,j}=1$ 。</p>
<h4 id="动态学习"><a href="#动态学习" class="headerlink" title="动态学习"></a>动态学习</h4><p>通过在运行中实际测试覆盖率的变化可以获得更多静态学习无法学到的影响关系，用于更新和细化关系表，以便生成高质量的测试用例。</p>
<p>在进行动态学习之前，Healer 会先统计每个系统调用的覆盖范围，并存储其触发的基本块和边，以便于在后续的测试中发现新的覆盖范围信息。</p>
<p>之后会调用 minimization 算法，将触发新的覆盖率的系统调用序列进行最小化处理，以便得到尽可能小的覆盖范围不变的系统调用序列。minimization 算法则是通过反向遍历待处理的系统调用序列，通过尝试性移除某个系统调用，若移除后执行得到的覆盖率没有发生变化，则当前的移除的系统调用是无用的，可以直接丢弃，反之则不能丢弃。最终得到的就是最小化之后的系统调用序列。</p>
<p>再完成 minimization 之后，动态学习部分则会在最小化的系统调用序列中逐渐地移除单个系统调用并检测对下一个系统调用的影响。假设 $syscall<em>i$ 和 $syscall_j$ 是最小化系统调用中紧邻的两个系统调用， $syscall_i$ 是 $syscall_j$ 的前一个系统调用，如果移除了 $syscall_i$ 后对 $syscall_j$ 的覆盖范围信息造成了影响，则说明 $syscall_i$ 是对 $syscall_j$ 有影响的，此时可以设置 $R</em>{i,j}=1$ 。</p>
<h3 id="变异规则"><a href="#变异规则" class="headerlink" title="变异规则"></a>变异规则</h3><p>通过上述的关系学习模块可以得到系统调用关系表，而后，Healer 将使用这个信息来指导输入的变异和生成。在 Healer 中变异的方式一共有：插入系统调用（insert_calls）、变异系统调用参数（mutate_call_args）、拼接系统调用（splice）和移除系统调用（remove_call）四种。其中后三种方式是常规的变异方式，只有插入系统调用会使用到系统调用关系表来指导变异。</p>
<p>具体变异规则为，当 Healer 从语料库中随机选择了一个系统调用序列后，它会在该序列中随机选择一个位置作为插入点，然后将插入点前面的子序列作为变异算法（Guided Call Selection）的输入，然后将变异算法输出得到的系统调用插入在选中的地方。该变异算法的工作流程为：</p>
<ol>
<li>以一个与 $\alpha$ 相关的随机概率返回一个随机的系统调用。</li>
<li>否则遍历输入的系统调用子序列中的每个系统调用，为其所有能影响的系统调用增加一个权重。遍历完毕之后会依据每个系统调用的权重返回一个与权重有关的随机选择。</li>
</ol>
<p>伪代码如下图所示：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://kiprey.github.io/2021/11/healer/image-20211129211440619.png" alt="Guided Call Selection 伪代码"></p>
<p>值得注意的是，上述参数 $\alpha$ 是一个可以调控的参数。在模糊测试进程开始之初，系统调用关系表中的信息并不是很多，如果过度从中选取系统调用将会导致整个生成的种子库多样性降低；而随着后期动态学习不断更新系统关系调用表，通过使用其中的信息来指导生成系统调用序列可以增加生成输入的有效性。因此通过调控这个参数，并在模糊测试过程中不断增大这个值，可以使得 Healer 在模糊测试初期和后期都能取得比较不错的效果。 </p>
<h2 id="0x02-环境配置"><a href="#0x02-环境配置" class="headerlink" title="0x02 环境配置"></a>0x02 环境配置</h2><p>为了能对 Linux 内核进行模糊测试，我们需要进行下列的步骤：</p>
<ol>
<li>选择一个合适的主机以便在其上进行实验。这里本文选择的是 Ubuntu 20.04 x86-64。</li>
<li>下载想 fuzz 的 Linux 内核的源码，然后开启配置选项后，在主机上对该 Linux 内核的源码进行编译并制作 image。</li>
<li>在主机上安装 QEMU启动待测试的 Linux 内核。</li>
<li>在主机上编译并配置好 fuzzer 。</li>
</ol>
<p>为了便于管理和识别本次实验的环境，建议在某个位置开始新建一个本次实验相关的文件夹。</p>
<p>在实验机汇总打开一个终端（terminal），输入下面的命令，然后键入 <kbd>Enter &crarr;</kbd> 。 这个命令会在当前位置创建一个名为“healer” 的文件夹，用于存储与本次实验相关的文件。请记住该文件夹的位置。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> HEALER</span><br></pre></td></tr></table></figure>
<h3 id="依赖库安装"><a href="#依赖库安装" class="headerlink" title="依赖库安装"></a>依赖库安装</h3><p>该部分主要参考了 <a target="_blank" rel="noopener" href="https://github.com/google/syzkaller/blob/master/docs/linux/setup.md">Syzkaller set up</a> 中对环境配置的描述，这里本次实验的主机是 Ubuntu，架构属于 x86-64，选择使用 QEMU 来启动待测试的内核，所以选择了对应的参考文档： <a target="_blank" rel="noopener" href="https://github.com/google/syzkaller/blob/master/docs/linux/setup_ubuntu-host_qemu-vm_x86-64-kernel.md">Setup: Ubuntu host, QEMU vm, x86-64 kernel</a>。</p>
<blockquote>
<p>注意不同的选择情况下的安装过程有些许区别，但是仔细看教程中的步骤做，也是可以的。</p>
</blockquote>
<h4 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h4><p>为了编译 Linux 的内核，需要在主机上先安装一些必要的依赖库。</p>
<p>首先进行软件包的更新，在实验主机上打开一个终端，输入下面的命令，然后键入 <kbd>Enter &crarr;</kbd> 。 </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> apt update</span><br></pre></td></tr></table></figure>
<blockquote>
<p>可能会出现下面的情况：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> apt update</span><br><span class="line">[<span class="built_in">sudo</span>] password <span class="keyword">for</span> [username]: </span><br></pre></td></tr></table></figure>
<p>这时别慌，在当前终端中输入你此时登陆的用户的密码，（此时终端中可能没有出现你输入的密码，窗口中也不会有什么变化，不过别担心，这是为了安全的考虑。）</p>
<p>在输入完密码之后，然后键入 <kbd>Enter &crarr;</kbd> 。 </p>
<p>之后就可以正常执行这个命令了。</p>
</blockquote>
<p>然后进行依赖库的安装，在终端中输入下面的命令，然后键入 <kbd>Enter &crarr;</kbd> 。 </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> apt install make gcc flex bison libncurses-dev libelf-dev libssl-dev</span><br></pre></td></tr></table></figure>
<h4 id="Kernel"><a href="#Kernel" class="headerlink" title="Kernel"></a>Kernel</h4><p>这个部分将进行内核源码的下载和内核的编译。</p>
<h5 id="Linux-内核源码下载"><a href="#Linux-内核源码下载" class="headerlink" title="Linux 内核源码下载"></a>Linux 内核源码下载</h5><p>在实验机器中，<code>HEALER</code> 文件夹中打开一个终端，输入下面的命令，然后键入 <kbd>Enter &crarr;</kbd> 。 </p>
<p>下载完成时间与网络速度有关，请耐心等待命令执行完毕。</p>
<blockquote>
<p>注意执行这个命令的位置，他会自动将 <code>linux</code> 文件夹保存在执行命令的位置。本实例中下载的位置是: <code>/SOME_PATH/HEALER/linux</code> 。 请根据自己的实际情况替换 SOME_PATH 的值。</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> git <span class="built_in">clone</span> --branch v5.11 git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git <span class="variable">$KERNEL</span></span><br><span class="line">[<span class="built_in">sudo</span>] password <span class="keyword">for</span> username: </span><br><span class="line">Cloning into <span class="string">&#x27;linux&#x27;</span>...</span><br><span class="line">remote: Enumerating objects: 68, <span class="keyword">done</span>.</span><br><span class="line">remote: Counting objects: 100% (68/68), <span class="keyword">done</span>.</span><br><span class="line">remote: Compressing objects: 100% (14/14), <span class="keyword">done</span>.</span><br><span class="line">remote: Total 9098039 (delta 59), reused 56 (delta 54), pack-reused 9097971</span><br><span class="line">Receiving objects: 100% (9098039/9098039), 2.48 GiB | 1.32 MiB/s, <span class="keyword">done</span>.</span><br><span class="line">Resolving deltas: 100% (7458781/7458781), <span class="keyword">done</span>.</span><br><span class="line">Note: switching to <span class="string">&#x27;f40ddce88593482919761f74910f42f4b84c004b&#x27;</span>.</span><br><span class="line"></span><br><span class="line">You are <span class="keyword">in</span> <span class="string">&#x27;detached HEAD&#x27;</span> state. You can look around, make experimental</span><br><span class="line">changes and commit them, and you can discard any commits you make <span class="keyword">in</span> this</span><br><span class="line">state without impacting any branches by switching back to a branch.</span><br><span class="line"></span><br><span class="line">If you want to create a new branch to retain commits you create, you may</span><br><span class="line"><span class="keyword">do</span> so (now or later) by using -c with the switch <span class="built_in">command</span>. Example:</span><br><span class="line"></span><br><span class="line">  git switch -c &lt;new-branch-name&gt;</span><br><span class="line"></span><br><span class="line">Or undo this operation with:</span><br><span class="line"></span><br><span class="line">  git switch -</span><br><span class="line"></span><br><span class="line">Turn off this advice by setting config variable advice.detachedHead to <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">Updating files: 100% (71277/71277), <span class="keyword">done</span>.</span><br></pre></td></tr></table></figure>
<h5 id="生成默认配置文件"><a href="#生成默认配置文件" class="headerlink" title="生成默认配置文件"></a>生成默认配置文件</h5><p>在刚才下载的文件夹 <code>linux</code> 中打开一个终端，或者也可以在任意一个终端中输入下面的命令，然后键入 <kbd>Enter &crarr;</kbd> 。 </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /SOME_PATH/HEALER/linux</span><br></pre></td></tr></table></figure>
<p>然后在 <code>linux</code> 文件夹的终端中输入下面的命令，然后键入 <kbd>Enter &crarr;</kbd> 。 该命令会自动生成一个与系统相关的默认配置文件 <code>.config</code>。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> make defconfig</span><br><span class="line">  HOSTCC  scripts/basic/fixdep</span><br><span class="line">  HOSTCC  scripts/kconfig/conf.o</span><br><span class="line">  HOSTCC  scripts/kconfig/confdata.o</span><br><span class="line">  HOSTCC  scripts/kconfig/expr.o</span><br><span class="line">  LEX     scripts/kconfig/lexer.lex.c</span><br><span class="line">  YACC    scripts/kconfig/parser.tab.[ch]</span><br><span class="line">  HOSTCC  scripts/kconfig/lexer.lex.o</span><br><span class="line">  HOSTCC  scripts/kconfig/parser.tab.o</span><br><span class="line">  HOSTCC  scripts/kconfig/preprocess.o</span><br><span class="line">  HOSTCC  scripts/kconfig/symbol.o</span><br><span class="line">  HOSTCC  scripts/kconfig/util.o</span><br><span class="line">  HOSTLD  scripts/kconfig/conf</span><br><span class="line">*** Default configuration is based on <span class="string">&#x27;x86_64_defconfig&#x27;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># configuration written to .config</span></span><br><span class="line"><span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p>耐心等待上面的命令执行完毕后之后，接着输入下面的命令，然后键入 <kbd>Enter &crarr;</kbd> 。 该命令会再次生成一些配置信息并合并后写入到配置文件 <code>.config</code> 中。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> make kvm_guest.config</span><br><span class="line">Using .config as base</span><br><span class="line">Merging ./kernel/configs/kvm_guest.config</span><br><span class="line">Value of CONFIG_HYPERVISOR_GUEST is redefined by fragment ./kernel/configs/kvm_guest.config:</span><br><span class="line">Previous value: <span class="comment"># CONFIG_HYPERVISOR_GUEST is not set</span></span><br><span class="line">New value: CONFIG_HYPERVISOR_GUEST=y</span><br><span class="line"></span><br><span class="line">Value of CONFIG_VIRTIO_PCI is redefined by fragment ./kernel/configs/kvm_guest.config:</span><br><span class="line">Previous value: <span class="comment"># CONFIG_VIRTIO_PCI is not set</span></span><br><span class="line">New value: CONFIG_VIRTIO_PCI=y</span><br><span class="line"></span><br><span class="line">Value of CONFIG_VIRTIO_CONSOLE is redefined by fragment ./kernel/configs/kvm_guest.config:</span><br><span class="line">Previous value: <span class="comment"># CONFIG_VIRTIO_CONSOLE is not set</span></span><br><span class="line">New value: CONFIG_VIRTIO_CONSOLE=y</span><br><span class="line"></span><br><span class="line">Value of CONFIG_NET_9P is redefined by fragment ./kernel/configs/kvm_guest.config:</span><br><span class="line">Previous value: <span class="comment"># CONFIG_NET_9P is not set</span></span><br><span class="line">New value: CONFIG_NET_9P=y</span><br><span class="line"></span><br><span class="line">Value of CONFIG_SCSI_LOWLEVEL is redefined by fragment ./kernel/configs/kvm_guest.config:</span><br><span class="line">Previous value: <span class="comment"># CONFIG_SCSI_LOWLEVEL is not set</span></span><br><span class="line">New value: CONFIG_SCSI_LOWLEVEL=y</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># merged configuration written to .config (needs make)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># configuration written to .config</span></span><br><span class="line"><span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h5 id="打开需要的配置选项"><a href="#打开需要的配置选项" class="headerlink" title="打开需要的配置选项"></a>打开需要的配置选项</h5><p>我发现了一个更简单更方便，也确实理论上也本来就应该有这么一个方式，通过命令行的方式修改配置文件的选项信息，不然太傻了。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> ./scripts/config \</span><br><span class="line">-e CONFIG_KCOV \</span><br><span class="line">-e CONFIG_DEBUG_INFO \</span><br><span class="line">-e CONFIG_KASAN \</span><br><span class="line">-e CONFIG_KASAN_INLINE \</span><br><span class="line">-e CONFIG_CONFIGFS_FS \</span><br><span class="line">-e CONFIG_SECURITYFS</span><br></pre></td></tr></table></figure>
<p>以下是傻傻的旧方法</p>
<p>在 <code>/SOME_PATH/HEALER/linux</code>  目录下打开一个终端，输入下面的命令，然后键入 <kbd>Enter &crarr;</kbd> 。 该命令会打开配置文件 <code>.config</code> 并在终端中显示。</p>
<blockquote>
<p>也可以通过文本编辑器打开该文件修改下面对应的字段后保存。使用这个方法则可以跳过下面修改的这一步。</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> vim .config</span><br></pre></td></tr></table></figure>
<p>终端中会显示出生成的配置选项信息，找到下面列举的几项后，修改后的配置文件中的相关参数与下列一致。</p>
<blockquote>
<p>在 vim 命令模式下，键入  <kbd>i</kbd> 可以进入插入模式，然后就可以修改对应的内容。</p>
<p>修改完毕后，键入  <kbd>Esc</kbd> 可以退出插入模式，返回命令模式。</p>
<p>在确认所有配置项都修改完毕后，在命令模式下键入  <kbd>shift</kbd> +<kbd>;</kbd> （即键入 <kbd>:</kbd>） 。然后再键入 <kbd>w</kbd> + <kbd>q</kbd> 可以进行保存并退出。</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Coverage collection.</span></span><br><span class="line">CONFIG_KCOV=y</span><br><span class="line"></span><br><span class="line"><span class="comment"># Debug info for symbolization.</span></span><br><span class="line">CONFIG_DEBUG_INFO=y</span><br><span class="line"></span><br><span class="line"><span class="comment"># Memory bug detector</span></span><br><span class="line">CONFIG_KASAN=y</span><br><span class="line">CONFIG_KASAN_INLINE=y</span><br><span class="line"></span><br><span class="line"><span class="comment"># Required for Debian Stretch</span></span><br><span class="line">CONFIG_CONFIGFS_FS=y</span><br><span class="line">CONFIG_SECURITYFS=y</span><br></pre></td></tr></table></figure>
<p>在修改 <code>.config</code> 并保存之后， 再进行重新编译配置文件。输入下面的命令，然后键入 <kbd>Enter &crarr;</kbd> 。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> make olddefconfig</span><br><span class="line">.config:4089:warning: override: reassigning to symbol CONFIGFS_FS</span><br><span class="line">.config:4212:warning: override: reassigning to symbol SECURITYFS</span><br><span class="line">.config:4604:warning: override: reassigning to symbol DEBUG_INFO</span><br><span class="line">.config:4671:warning: override: reassigning to symbol KASAN</span><br><span class="line">.config:4845:warning: override: reassigning to symbol KCOV</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># configuration written to .config</span></span><br><span class="line"><span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h5 id="构建内核"><a href="#构建内核" class="headerlink" title="构建内核"></a>构建内核</h5><p>在完成配置文件的修改后，输入下面的命令，然后键入 <kbd>Enter &crarr;</kbd> 。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> make -j`<span class="built_in">nproc</span>`</span><br></pre></td></tr></table></figure>
<p>编译的过程会比较旧，取决于实验环境的机器的性能，在终端中会打印很多和编译相关的日志。下面是部分节选:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  GZIP    <span class="built_in">arch</span>/x86/boot/compressed/vmlinux.bin.gz</span><br><span class="line">  MKPIGGY <span class="built_in">arch</span>/x86/boot/compressed/piggy.S</span><br><span class="line">  AS      <span class="built_in">arch</span>/x86/boot/compressed/piggy.o</span><br><span class="line">  LD      <span class="built_in">arch</span>/x86/boot/compressed/vmlinux</span><br><span class="line">  ZOFFSET <span class="built_in">arch</span>/x86/boot/zoffset.h</span><br><span class="line">  OBJCOPY <span class="built_in">arch</span>/x86/boot/vmlinux.bin</span><br><span class="line">  AS      <span class="built_in">arch</span>/x86/boot/header.o</span><br><span class="line">  LD      <span class="built_in">arch</span>/x86/boot/setup.elf</span><br><span class="line">  OBJCOPY <span class="built_in">arch</span>/x86/boot/setup.bin</span><br><span class="line">  BUILD   <span class="built_in">arch</span>/x86/boot/bzImage</span><br><span class="line">Kernel: <span class="built_in">arch</span>/x86/boot/bzImage is ready  (#1)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Now you should have <code>vmlinux</code> (kernel binary) and <code>bzImage</code> (packed kernel image)。</p>
</blockquote>
<p> 到这里，如果看到终端停止打印日志，且最后一个日志显示为：“Kernel: arch/x86/boot/bzImage is ready  (#1)” 则现在已经成功完成了内核的编译了。</p>
<p>现在，输入下面的命令，然后键入 <kbd>Enter &crarr;</kbd> ，应该可以看到文件 <code>vmlinux</code> 的存在。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ls</span> /SOME_PATH/HEALER/linux/vmlinux</span><br><span class="line">/SOME_PATH/HEALER/linux/vmlinux</span><br></pre></td></tr></table></figure>
<p>同理，输入下面的命令，然后键入 <kbd>Enter &crarr;</kbd> ，应该可以看到文件 <code>bzImage</code> 的存在。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ls</span> /SOME_PATH/HEALER/linux/arch/x86/boot/bzImage</span><br><span class="line">/SOME_PATH/HEALER/linux/arch/x86/boot/bzImage</span><br></pre></td></tr></table></figure>
<h4 id="Image"><a href="#Image" class="headerlink" title="Image"></a>Image</h4><h5 id="安装-debootstrap"><a href="#安装-debootstrap" class="headerlink" title="安装 debootstrap"></a>安装 debootstrap</h5><p>输入下面的命令，然后键入 <kbd>Enter &crarr;</kbd> 。该命令可以完成安装 debootstrap。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> apt install debootstrap</span><br></pre></td></tr></table></figure>
<h5 id="创建-Debian-Stretch-Linux-image"><a href="#创建-Debian-Stretch-Linux-image" class="headerlink" title="创建 Debian Stretch Linux image"></a>创建 Debian Stretch Linux image</h5><blockquote>
<p>教程中有两种一种是: Create Debian Buster Linux image 另一种是 Create Debian Stretch Linux image</p>
<p>我查了一下就是选择要制作的 debian 的版本不同，一个是旧一点的稳定版，一个是更旧的版本。</p>
</blockquote>
<p>在 <code>/SOME_PATH/HEALER</code>  目录下打开一个终端，输入下面的命令，然后键入 <kbd>Enter &crarr;</kbd> 。 该命令会创建一个文件目录 <code>disk_img</code> 与 <code>linux</code> 同级，同时会切换到 <code>disk_img</code> 目录下。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> disk_img &amp;&amp; <span class="built_in">cd</span> disk_img</span><br></pre></td></tr></table></figure>
<p>然后在当前终端中，输入下面的命令，然后键入 <kbd>Enter &crarr;</kbd> 。 </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> <span class="variable">$IMAGE</span> &amp;&amp; <span class="built_in">cd</span> <span class="variable">$IMAGE</span>/</span><br></pre></td></tr></table></figure>
<p>然后在当前终端中，输入下面的命令，然后键入 <kbd>Enter &crarr;</kbd> 。 该命令会下载一个文件 <code>create-image.sh</code> 。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://raw.githubusercontent.com/google/syzkaller/master/tools/create-image.sh -O create-image.sh</span><br></pre></td></tr></table></figure>
<p>使用文本编辑器打开 <code>./create-image.sh</code> 在第 147 行附近按照下面的内容进行修改后保存。本次修改将进行换源，这里切换为使用清华源。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># before</span></span><br><span class="line"><span class="built_in">sudo</span> debootstrap <span class="variable">$DEBOOTSTRAP_PARAMS</span> </span><br><span class="line"><span class="comment"># after </span></span><br><span class="line"><span class="built_in">sudo</span> debootstrap <span class="variable">$DEBOOTSTRAP_PARAMS</span> <span class="string">&quot;https://mirrors.tuna.tsinghua.edu.cn/debian/&quot;</span></span><br></pre></td></tr></table></figure>
<p>然后在当前终端中，输入下面的命令，然后键入 <kbd>Enter &crarr;</kbd> 。 该命令会为文件 <code>create-image.sh</code> 添加执行权限。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">chmod</span> +x create-image.sh</span><br></pre></td></tr></table></figure>
<p>然后在当前终端中，输入下面的命令，然后键入 <kbd>Enter &crarr;</kbd> 。 该命令会执行文件 <code>create-image.sh</code> 。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./create-image.sh</span><br></pre></td></tr></table></figure>
<p>然后稍等片刻，运行时间取决于实验机器。</p>
<p>等待运行完毕后，在当前终端中输入 <code>ls</code> 命令，可以看到文件  <code>stretch.img</code> 。 </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ls</span></span><br><span class="line"><span class="built_in">chroot</span>  create-image.sh  stretch.id_rsa  stretch.id_rsa.pub  stretch.img</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里代理的问题还卡了我挺久，一直构建不成功，前面的下载慢我们还可以本地下载了再传上去，但是最后这个脚本执行的时候会从 debian 官方去下载文件，这下就头大了，分好几次，跑了好久都失败了（重复试、terminal 走本地局域网代理等）</p>
<p>然后都失败了，通过查看失败的位置，查看 <code>create-image.sh</code> 脚本代码，结合日志定位了是其中下面这个命令执行的时候太慢了，请求不到：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> debootstrap --<span class="built_in">arch</span>=amd64 --include=openssh-server,curl,tar,gcc,libc6-dev,time,strace,<span class="built_in">sudo</span>,less,psmisc,selinux-utils,policycoreutils,checkpolicy,selinux-policy-default,firmware-atheros,debian-ports-archive-keyring --components=main,contrib,non-free stretch <span class="built_in">chroot</span></span><br></pre></td></tr></table></figure>
<p>觉得肯定是 <del>特色 Nation</del> 于是尝试换源解决，但是搜出来的 <code>debootstrap</code> 换源别人都是讲的换 <code>apt</code> 那种的意思，不是这样的。（虽然确实是同一个源，但是就是跑这个代码不会走换的源还是官方源。</p>
<p>于是加双引号终于搜到一个答案：<a target="_blank" rel="noopener" href="https://blog.csdn.net/jack240541595/article/details/90203299">【Linux学习笔记】debootstrap的使用技巧</a></p>
<p>在使用开发板厂家系统构建脚本时，系统构建过程非常慢，多次尝试也容易出现构建过程中因为包获取失败而中断的情况；</p>
<p>1.首先尝试为虚拟机设置梯子，主机上开启SSR，设置本地端口，虚拟机中开启代理，实测无明显改善。</p>
<p>2.尝试分析脚本提前下载所需文件，能改善镜像下载阶段的速度，但获取软件包过程依然无改善。</p>
<p>3.继续捋脚本发现软件包的获取及安装过程实际是debootstrap的执行过程，查询其使用说明</p>
<p>常用方式为:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">debootstrap stable /stable-chroot http://deb.debian.org/debian/</span><br></pre></td></tr></table></figure>
<p>虽然没看懂，但是我受到了启发，就是往执行命令后面添加一个 url 作为我们想指定的源，于是我随便选择了个清华源，在命令行单独试了一下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> debootstrap --<span class="built_in">arch</span>=amd64 --include=openssh-server,curl,tar,gcc,libc6-dev,time,strace,<span class="built_in">sudo</span>,less,psmisc,selinux-utils,policycoreutils,checkpolicy,selinux-policy-default,firmware-atheros,debian-ports-archive-keyring --components=main,contrib,non-free stretch <span class="built_in">chroot</span> https://mirrors.tuna.tsinghua.edu.cn/debian/</span><br></pre></td></tr></table></figure>
<p>结果一会会这个命令就完美跑通了</p>
<p>所以，我们就可以定位文件 <code>./create-image.sh</code> 中，执行上述命令相关的位置 (line:147) 进行一个简单修改:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># before</span></span><br><span class="line"><span class="built_in">sudo</span> debootstrap <span class="variable">$DEBOOTSTRAP_PARAMS</span> </span><br><span class="line"><span class="comment"># after </span></span><br><span class="line"><span class="built_in">sudo</span> debootstrap <span class="variable">$DEBOOTSTRAP_PARAMS</span> <span class="string">&quot;https://mirrors.tuna.tsinghua.edu.cn/debian/&quot;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="QEMU"><a href="#QEMU" class="headerlink" title="QEMU"></a>QEMU</h3><h4 id="安装-QEMU"><a href="#安装-QEMU" class="headerlink" title="安装 QEMU"></a>安装 QEMU</h4><p> 在终端中输入下面的命令，然后键入 <kbd>Enter &crarr;</kbd> 。 该命令会安装 QEMU。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install qemu-system-x86</span><br></pre></td></tr></table></figure>
<h4 id="验证测试"><a href="#验证测试" class="headerlink" title="验证测试"></a>验证测试</h4><p>本部分将完成对 kernel boot 和 sshd 的有效性进行验证。</p>
<p> 在终端中输入下面的命令，然后键入 <kbd>Enter &crarr;</kbd> 。 该命令会使用 QEMU 去启动刚才编译得到的内核。</p>
<blockquote>
<p>注意修改 <code>/SOME_PATH</code> 为文件的实际真实位置。</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> qemu-system-x86_64 \</span><br><span class="line">	-m 2G \</span><br><span class="line">	-smp 2 \</span><br><span class="line">	-kernel /SOME_PATH/HEALER/linux/arch/x86/boot/ \</span><br><span class="line">	-append <span class="string">&quot;console=ttyS0 root=/dev/sda earlyprintk=serial net.ifnames=0&quot;</span> \</span><br><span class="line">	-drive file=/SOME_PATH/HEALER/disk_img/stretch.img,format=raw \</span><br><span class="line">	-net user,host=10.0.2.10,hostfwd=tcp:127.0.0.1:10021-:22 \</span><br><span class="line">	-net nic,model=e1000 \</span><br><span class="line">	-enable-kvm \</span><br><span class="line">	-nographic \</span><br><span class="line">	-pidfile vm.pid \</span><br><span class="line">	2&gt;&amp;1 | <span class="built_in">tee</span> vm.log</span><br></pre></td></tr></table></figure>
<p>执行上述命令后，稍等片刻，终端中会打印很多相关日志，等待日志停止打印后，会出现一个等待输入的提示。大约如下所示：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">[  OK  ] Started Serial Getty on ttyS0.</span><br><span class="line">[  OK  ] Started Getty on tty1.</span><br><span class="line">[  OK  ] Started Getty on tty3.</span><br><span class="line">[  OK  ] Started Getty on tty5.</span><br><span class="line">[  OK  ] Started Getty on tty4.</span><br><span class="line">[  OK  ] Started Getty on tty6.</span><br><span class="line">[  OK  ] Reached target Login Prompts.</span><br><span class="line">[  OK  ] Started OpenBSD Secure Shell server.</span><br><span class="line">[  OK  ] Reached target Multi-User System.</span><br><span class="line">[  OK  ] Reached target Graphical Interface.</span><br><span class="line">         Starting Update UTMP about System Runlevel Changes...</span><br><span class="line">[  OK  ] Started Update UTMP about System Runlevel Changes.</span><br><span class="line"></span><br><span class="line">Debian GNU/Linux 9 syzkaller ttyS0</span><br><span class="line"></span><br><span class="line">syzkaller login: </span><br></pre></td></tr></table></figure>
<p>此时在当前终端中输入 <code>root</code> ，然后键入 <kbd>Enter &crarr;</kbd> 。 表明将以 root 的身份进行登录。然后终端就会进入刚才编译得到的内核中（给出了一个内核的命令行接口）。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">syzkaller login: root</span><br><span class="line">Unable to get valid context <span class="keyword">for</span> root</span><br><span class="line">Linux syzkaller 5.11.0 <span class="comment">#1 SMP Sun Nov 6 20:44:59 CST 2022 x86_64</span></span><br><span class="line"></span><br><span class="line">The programs included with the Debian GNU/Linux system are free software;</span><br><span class="line">the exact distribution terms <span class="keyword">for</span> each program are described <span class="keyword">in</span> the</span><br><span class="line">individual files <span class="keyword">in</span> /usr/share/doc/*/copyright.</span><br><span class="line"></span><br><span class="line">Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent</span><br><span class="line">permitted by applicable law.</span><br><span class="line">root@syzkaller:~# </span><br></pre></td></tr></table></figure>
<p><del>但是喵喵的没法退出了呢。。。。</del>  好像是要 <code>ctrl-a</code> + <code>x</code>  。 </p>
<h4 id="连接到一个-QEMU-实例中"><a href="#连接到一个-QEMU-实例中" class="headerlink" title="连接到一个 QEMU 实例中"></a>连接到一个 QEMU 实例中</h4><p>在实验机中重新打开一个新的终端，输入下面的命令，然后键入 <kbd>Enter &crarr;</kbd> 。注意修改下方 <code>SOME_PATH</code> 为实际路径。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> ssh -i /SOME_PATH/HEALER/disk_img/stretch.id_rsa -p 10021 -o <span class="string">&quot;StrictHostKeyChecking no&quot;</span> root@localhost</span><br></pre></td></tr></table></figure>
<p>稍等片刻，当前终端中会显示如下信息，表明通过 ssh 连接到 QEMU 实例通过。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Warning: Permanently added <span class="string">&#x27;[localhost]:10021&#x27;</span> (ECDSA) to the list of known hosts.</span><br><span class="line">Linux syzkaller 5.11.0 <span class="comment">#1 SMP Sun Nov 6 20:44:59 CST 2022 x86_64</span></span><br><span class="line"></span><br><span class="line">The programs included with the Debian GNU/Linux system are free software;</span><br><span class="line">the exact distribution terms <span class="keyword">for</span> each program are described <span class="keyword">in</span> the</span><br><span class="line">individual files <span class="keyword">in</span> /usr/share/doc/*/copyright.</span><br><span class="line"></span><br><span class="line">Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent</span><br><span class="line">permitted by applicable law.</span><br><span class="line">Unable to get valid context <span class="keyword">for</span> root</span><br><span class="line">Last login: Mon Jan  23 02:02:21 2023</span><br><span class="line">root@syzkaller:~# </span><br></pre></td></tr></table></figure>
<h3 id="Healer"><a href="#Healer" class="headerlink" title="Healer"></a>Healer</h3><p>Healer 是使用 <a target="_blank" rel="noopener" href="https://www.rust-lang.org/">Rust</a> 语言进行编写的，要编译该工具首先要配置 Rust 的编译环境。</p>
<h4 id="Rust-安装"><a href="#Rust-安装" class="headerlink" title="Rust 安装"></a>Rust 安装</h4><p>在 Linux 终端中输入下面的命令，然后键入 <kbd>Enter &crarr;</kbd> 。 </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ curl --proto <span class="string">&#x27;=https&#x27;</span> --tlsv1.2 -sSf https://sh.rustup.rs | sh</span><br><span class="line">(enter)</span><br></pre></td></tr></table></figure>
<p>安装过程取决于网速和机器，稍等片刻。然后在 Linux 终端中输入下面的命令后，然后键入 <kbd>Enter &crarr;</kbd> 。 如果你看到了类似下面的输入显示了 “rustc x.xx.x” 的版本号则为安装好了。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ rustc --version <span class="comment"># check install</span></span><br><span class="line">rustc 1.65.0 (897e37553 2022-11-02)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>请注意提示，如果想要在当前终端中使相关环境变量生效，则你需要运行命令 <code>source &quot;$HOME/.cargo/env&quot;</code> ，然后键入 <kbd>Enter &crarr;</kbd> 。 </p>
</blockquote>
<h4 id="编译-Healer"><a href="#编译-Healer" class="headerlink" title="编译 Healer"></a>编译 Healer</h4><p>在实验机中的 <code>HEALER</code> 文件夹中打开一个终端，并在终端中输入下面的命令，然后键入 <kbd>Enter &crarr;</kbd> 。该命令会自动下载 Healer 到 <code>SOME_PATH/HEALER/healer/</code> 。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/SunHao-0/healer.git</span><br><span class="line">Cloning into <span class="string">&#x27;healer&#x27;</span>...</span><br><span class="line">remote: Enumerating objects: 4543, <span class="keyword">done</span>.</span><br><span class="line">remote: Counting objects: 100% (129/129), <span class="keyword">done</span>.</span><br><span class="line">remote: Compressing objects: 100% (26/26), <span class="keyword">done</span>.</span><br><span class="line">remote: Total 4543 (delta 109), reused 103 (delta 103), pack-reused 4414</span><br><span class="line">Receiving objects: 100% (4543/4543), 16.16 MiB | 4.33 MiB/s, <span class="keyword">done</span>.</span><br><span class="line">Resolving deltas: 100% (2422/2422), <span class="keyword">done</span>.</span><br></pre></td></tr></table></figure>
<p>然后切换到刚才下载的 healer 的所在目录。在当前终端执行下面的命令，然后键入 <kbd>Enter &crarr;</kbd> 。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> healer</span><br></pre></td></tr></table></figure>
<p>然后在当前终端执行下面的命令，然后键入 <kbd>Enter &crarr;</kbd> 。该命令会开始进行 Healer 的编译。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cargo build --release</span><br><span class="line">  Updating crates.io index</span><br><span class="line">  Downloaded autocfg v1.0.1</span><br><span class="line">  Downloaded num-traits v0.2.14</span><br><span class="line">  Downloaded unicode-xid v0.2.2</span><br><span class="line">  Downloaded strsim v0.8.0</span><br><span class="line">  ...</span><br><span class="line">   Compiling mutate_prog v0.1.0 (/SOME_PATH/HEALER/Healer/tools/mutate_prog)</span><br><span class="line">   Finished release [optimized] target(s) <span class="keyword">in</span> 3m 54s</span><br></pre></td></tr></table></figure>
<p>当命令执行完毕后， Healer 编译成功。此时，如下所示，在对应 <code>target/release/</code> 下可以看到编译之后的文件： <code>healer</code> , <code>syz-bin</code> 。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">pwd</span></span><br><span class="line">/SOME_PATH/HEALER/Healer</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">ls</span> ./target/release </span><br><span class="line">healer ...</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">ls</span> ./target/release/syz-bin      </span><br><span class="line">linux_amd64  syz-repro  syz-symbolize  syz-sysgen</span><br></pre></td></tr></table></figure>
<h3 id="开始-Fuzz-Linux-Kernel"><a href="#开始-Fuzz-Linux-Kernel" class="headerlink" title="开始 Fuzz Linux Kernel"></a>开始 Fuzz Linux Kernel</h3><h4 id="工作目录准备"><a href="#工作目录准备" class="headerlink" title="工作目录准备"></a>工作目录准备</h4><p>开始进行 fuzz 之前，需要确保所有的必须的文件都准备妥当了。建议将这些可执行文件都放到同一个工作目录下，如按照如下的目录进行:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> -p /SOME_PATH/HEALER/work_dir</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> /SOME_PATH/HEALER/work_dir &amp;&amp; <span class="built_in">ls</span> </span><br><span class="line">bin  bzImage  stretch.id_rsa  stretch.img</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">ls</span> ./bin</span><br><span class="line">healer linux_amd64  syz-repro  syz-symbolize  syz-sysgen</span><br></pre></td></tr></table></figure>
<p>在本次实验中，在完成前面的编译之后，所有必须的文件的情况如下表所示：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>文件名</th>
<th>原始位置</th>
<th>新位置</th>
</tr>
</thead>
<tbody>
<tr>
<td>bzImage</td>
<td>..HEALER/linux/arch/x86/boot/bzImage</td>
<td>/SOME_PATH/HEALER/work_dir/bzImage</td>
</tr>
<tr>
<td>stretch.id_rsa</td>
<td>..HEALER/disk_img/stretch.id_rsa</td>
<td>/SOME_PATH/HEALER/work_dir/stretch.id_rsa</td>
</tr>
<tr>
<td>stretch.img</td>
<td>..HEALER/disk_img/stretch.img</td>
<td>/SOME_PATH/HEALER/work_dir/stretch.img</td>
</tr>
<tr>
<td>healer</td>
<td>..HEALER/Healer/target/release/healer</td>
<td>/SOME_PATH/HEALER/work_dir/bin/healer</td>
</tr>
<tr>
<td>linux_amd64</td>
<td>..HEALER/Healer/target/release/syz-bin/linux_amd64</td>
<td>/SOME_PATH/HEALER/work_dir/bin/linux_amd64</td>
</tr>
<tr>
<td>syz-repro</td>
<td>..HEALER/Healer/target/release/syz-bin/syz-repro</td>
<td>/SOME_PATH/HEALER/work_dir/bin/syz-repro</td>
</tr>
<tr>
<td>syz-symbolize</td>
<td>..HEALER/Healer/target/release/syz-bin/syz-symbolize</td>
<td>/SOME_PATH/HEALER/work_dir/bin/syz-symbolize</td>
</tr>
<tr>
<td>syz-sysgen</td>
<td>..HEALER/Healer/target/release/syz-bin/syz-sysgen</td>
<td>/SOME_PATH/HEALER/work_dir/bin/syz-sysgen</td>
</tr>
</tbody>
</table>
</div>
<p>新打开一个终端，依次输入下面的命令，并逐一键入  <kbd>Enter &crarr;</kbd> 。通过执行下面的命令可以实现对上表中的相关文件进行复制。注意修改下方 <code>SOME_PATH</code> 为实际路径。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># midir /SOME_PATH/HEALER/work_dir</span></span><br><span class="line">$ <span class="built_in">mkdir</span> work_dir</span><br><span class="line"></span><br><span class="line"><span class="comment"># cd &amp;&amp; mkdir bin</span></span><br><span class="line">$ <span class="built_in">cd</span> /SOME_PATH/HEALER/work_dir &amp;&amp; <span class="built_in">mkdir</span> bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># bzImage</span></span><br><span class="line">$ <span class="built_in">sudo</span> <span class="built_in">cp</span> /SOME_PATH/HEALER/linux/arch/x86/boot/bzImage /SOME_PATH/HEALER/work_dir/</span><br><span class="line"></span><br><span class="line"><span class="comment"># stretch.id_rsa</span></span><br><span class="line">$ <span class="built_in">sudo</span> <span class="built_in">cp</span> /SOME_PATH/HEALER/disk_img/stretch.id_rsa /SOME_PATH/HEALER/work_dir/</span><br><span class="line"></span><br><span class="line"><span class="comment"># stretch.img</span></span><br><span class="line">$ <span class="built_in">sudo</span> <span class="built_in">cp</span> /SOME_PATH/HEALER/disk_img/stretch.img /SOME_PATH/HEALER/work_dir/</span><br><span class="line"></span><br><span class="line"><span class="comment"># healer</span></span><br><span class="line">$ <span class="built_in">sudo</span> <span class="built_in">cp</span> /SOME_PATH/HEALER/Healer/target/release/healer /SOME_PATH/HEALER/work_dir/bin/</span><br><span class="line"></span><br><span class="line"><span class="comment"># linux_amd64</span></span><br><span class="line">$ <span class="built_in">sudo</span> <span class="built_in">cp</span> -r /SOME_PATH/HEALER/Healer/target/release/syz-bin/linux_amd64 /SOME_PATH/HEALER/work_dir/bin/</span><br><span class="line"></span><br><span class="line"><span class="comment"># syz-repro</span></span><br><span class="line">$ <span class="built_in">sudo</span> <span class="built_in">cp</span> /SOME_PATH/HEALER/Healer/target/release/syz-bin/syz-repro /SOME_PATH/HEALER/work_dir/bin/</span><br><span class="line"></span><br><span class="line"><span class="comment"># syz-symbolize</span></span><br><span class="line">$ <span class="built_in">sudo</span> <span class="built_in">cp</span> /SOME_PATH/HEALER/Healer/target/release/syz-bin/syz-symbolize /SOME_PATH/HEALER/work_dir/bin/</span><br><span class="line"></span><br><span class="line"><span class="comment"># syz-sysgen</span></span><br><span class="line">$ <span class="built_in">sudo</span> <span class="built_in">cp</span> /SOME_PATH/HEALER/Healer/target/release/syz-bin/syz-sysgen /SOME_PATH/HEALER/work_dir/bin/</span><br></pre></td></tr></table></figure>
<p>执行完毕上述复制之后，执行下面的命令以检查是否所有二进制文件都拷贝到了正确的位置。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">pwd</span></span><br><span class="line">/SOME_PATH/HEALER/work_dir/</span><br><span class="line">$ <span class="built_in">ls</span></span><br><span class="line">bin  bzImage  stretch.id_rsa  stretch.img</span><br><span class="line">$ <span class="built_in">cd</span> bin</span><br><span class="line">$ <span class="built_in">ls</span></span><br><span class="line">healer  linux_amd64  syz-repro  syz-symbolize  syz-sysgen</span><br></pre></td></tr></table></figure>
<h4 id="开始-fuzz"><a href="#开始-fuzz" class="headerlink" title="开始 fuzz"></a>开始 fuzz</h4><blockquote>
<p>-d path to disk image</p>
<p>-k path to kernel image</p>
<p>—ssh-key path to ssh key</p>
</blockquote>
<p>打开一个终端，并切换到工作目录下。在当前终端执行下面的命令，然后键入 <kbd>Enter &crarr;</kbd> 。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /SOME_PATH/HEALER/work_dir/</span><br></pre></td></tr></table></figure>
<p>在当前终端执行下面的命令，然后键入 <kbd>Enter &crarr;</kbd> 。该命令将使用 Healer 对刚才编译的 Linux 内核进行 fuzz。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> ./bin/healer -d stretch.img --ssh-key stretch.id_rsa -k bzImage</span><br></pre></td></tr></table></figure>
<p>在执行命令之后， Healer 会在当前终端打印其 banner ，然后开始输入和 fuzz 相关的一些日志信息。这个过程将会一直持续下去，一直对目标进行模糊测试。</p>
<p>当想停止进行 fuzz 时，可以在当前终端中键入: <kbd>Ctrl</kbd> + <kbd>C</kbd> 。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> ./bin/healer -d stretch.img --ssh-key stretch.id_rsa -k bzImage</span><br><span class="line"></span><br><span class="line"> ___   ___   ______   ________   __       ______   ______</span><br><span class="line">/__/\ /__/\ /_____/\ /_______/\ /_/\     /_____/\ /_____/\</span><br><span class="line">\::\ \\  \ \\::::_\/_\::: _  \ \\:\ \    \::::_\/_\:::_ \ \</span><br><span class="line"> \::\/_\ .\ \\:\/___/\\::(_)  \ \\:\ \    \:\/___/\\:(_) ) )_</span><br><span class="line">  \:: ___::\ \\::___\/_\:: __  \ \\:\ \____\::___\/_\: __ `\ \</span><br><span class="line">   \: \ \\::\ \\:\____/\\:.\ \  \ \\:\/___/\\:\____/\\ \ `\ \ \</span><br><span class="line">    \__\/ \::\/ \_____\/ \__\/\__\/ \_____\/ \_____\/ \_\/ \_\/</span><br><span class="line"></span><br><span class="line">[2023-01-23T02:44:46Z INFO ] loading target linux/amd64...</span><br><span class="line">[2023-01-23T02:44:49Z INFO ] pre-booting one vm...</span><br><span class="line">[2023-01-23T02:44:59Z INFO ] boot cost around 10s</span><br><span class="line">[2023-01-23T02:45:00Z INFO ] detecting features...</span><br><span class="line">[2023-01-23T02:45:00Z INFO ] code coverage               : enabled</span><br><span class="line">[2023-01-23T02:45:00Z INFO ] setuid sandbox              : enabled</span><br><span class="line">[2023-01-23T02:45:00Z INFO ] Android sandbox             : enabled</span><br><span class="line">[2023-01-23T02:45:00Z INFO ] net device setup            : enabled</span><br><span class="line">[2023-01-23T02:45:00Z INFO ] pre-setup one executor...</span><br><span class="line">[2023-01-23T02:45:01Z INFO ] ok, fuzzer-0 should be ready</span><br><span class="line">[2023-01-23T02:45:01Z INFO ] fuzzer-0: online</span><br><span class="line">[2023-01-23T02:45:11Z INFO ] <span class="built_in">exec</span>: 502, fuzz/repro 1/0, <span class="built_in">uniq</span>/total crashes 0/0, cal/max cover 5835/5836, corpus: 48</span><br><span class="line">[2023-01-23T02:45:13Z INFO ] fuzzer-1: online</span><br><span class="line">[2023-01-23T02:45:18Z INFO ] fuzzer-2: online</span><br><span class="line">[2023-01-23T02:45:21Z INFO ] <span class="built_in">exec</span>: 999, fuzz/repro 3/0, <span class="built_in">uniq</span>/total crashes 0/0, cal/max cover 8326/8921, corpus: 96</span><br><span class="line">[2023-01-23T02:45:23Z INFO ] fuzzer-3: online</span><br><span class="line">[2023-01-23T02:45:31Z INFO ] <span class="built_in">exec</span>: 1089, fuzz/repro 4/0, <span class="built_in">uniq</span>/total crashes 0/0, cal/max cover 8529/9173, corpus: 102</span><br><span class="line">[2023-01-23T02:45:41Z INFO ] <span class="built_in">exec</span>: 1501, fuzz/repro 4/0, <span class="built_in">uniq</span>/total crashes 0/0, cal/max cover 9223/9809, corpus: 138</span><br><span class="line">[2023-01-23T02:45:51Z INFO ] <span class="built_in">exec</span>: 1512, fuzz/repro 4/0, <span class="built_in">uniq</span>/total crashes 0/0, cal/max cover 9223/9809, corpus: 138</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h4 id="fuzzing"><a href="#fuzzing" class="headerlink" title="fuzzing"></a>fuzzing</h4><p>在经过一定的时间之后，终端中输出了一些和 crash 相关的日志。并打印出了执行的系统调用序列。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[2023-01-23T03:10:01Z INFO ] <span class="built_in">exec</span>: 70947, fuzz/repro 4/0, <span class="built_in">uniq</span>/total crashes 0/0, cal/max cover 50366/52583, corpus: 2656</span><br><span class="line">[2023-01-23T03:10:06Z WARN ] fuzzer-1: QEMU not alive, kernel maybe crashed, last executed prog:</span><br><span class="line">    r0 = syz_init_net_socket<span class="variable">$nl_generic</span>(0x10, 0x3, 0x10)</span><br><span class="line">    r1 = syz_genetlink_get_family_id<span class="variable">$netlbl_unlabel</span>(&amp;(0x7f0000000000)=<span class="string">&#x27;NLBL_UNLBL\x00&#x27;</span>, r0)</span><br><span class="line">    sendmsg<span class="variable">$NLBL_UNLABEL_C_STATICADDDEF</span>(r0, &amp;(0x7f0000000040)=&#123;&amp;(0x7f0000000080)=&#123;0x10, 0x0, 0x0, 0x4000&#125;, 0xc, &amp;(0x7f00000000c0)=&#123;&amp;(0x7f0000000100)=&#123;0x14, r1, 0x20, 0x70bd2d, 0x25dfdbff&#125;, 0x14&#125;, 0x1, 0x0, 0x0, 0x80&#125;, 0x2004c094)</span><br><span class="line">    r2 = syz_init_net_socket<span class="variable">$nl_generic</span>(0x10, 0x3, 0x10)</span><br><span class="line">    r3 = syz_genetlink_get_family_id<span class="variable">$netlbl_unlabel</span>(&amp;(0x7f0000000140)=<span class="string">&#x27;NLBL_UNLBL\x00&#x27;</span>, r0)</span><br><span class="line">    r4 = syz_genetlink_get_family_id<span class="variable">$netlbl_mgmt</span>(&amp;(0x7f0000000180)=<span class="string">&#x27;NLBL_MGMT\x00&#x27;</span>, r0)</span><br><span class="line">    sendmsg<span class="variable">$NLBL_MGMT_C_REMOVEDEF</span>(r0, &amp;(0x7f00000001c0)=&#123;&amp;(0x7f0000000200)=&#123;0x10, 0x0, 0x0, 0x20&#125;, 0xc, &amp;(0x7f0000000240)=&#123;&amp;(0x7f0000000280)=&#123;0x14, r4, 0x1, 0x70bd25, 0x25dfdbfb, &#123;&#125;, [@NLBL_MGMT_A_CLPDOI=&#123;0x8&#125;, @NLBL_MGMT_A_IPV4ADDR=&#123;0x8, 0x7, @multicast1&#125;, @NLBL_MGMT_A_FAMILY=&#123;0x6, 0xb, 0x1d&#125;, @NLBL_MGMT_A_IPV6ADDR=&#123;0x14, 0x5, @private0=&#123;0xfc, 0x0, <span class="string">&#x27;\x00&#x27;</span>, 0x1&#125;&#125;, @NLBL_MGMT_A_IPV4MASK=&#123;0x8, 0x8, @loopback&#125;, @NLBL_MGMT_A_IPV6ADDR=&#123;0x14, 0x5, @private1=&#123;0xfc, 0x1, <span class="string">&#x27;\x00&#x27;</span>, 0x1&#125;&#125;, @NLBL_MGMT_A_DOMAIN=&#123;0x11, 0x1, <span class="string">&#x27;NLBL_CIPSOv4\x00&#x27;</span>&#125;, @NLBL_MGMT_A_CLPDOI=&#123;0x8, 0xc, 0x3&#125;]&#125;, 0x14&#125;, 0x1, 0x0, 0x0, 0x20000024&#125;, 0x40004)</span><br><span class="line">    r5 = syz_genetlink_get_family_id<span class="variable">$netlbl_cipso</span>(&amp;(0x7f00000002c0)=<span class="string">&#x27;NLBL_CIPSOv4\x00&#x27;</span>, r0)</span><br><span class="line">    </span><br><span class="line">[2023-01-23T03:10:11Z INFO ] <span class="built_in">exec</span>: 70964, fuzz/repro 4/0, <span class="built_in">uniq</span>/total crashes 0/0, cal/max cover 50366/52583, corpus: 2656</span><br><span class="line">[2023-01-23T03:10:21Z INFO ] <span class="built_in">exec</span>: 70964, fuzz/repro 4/0, <span class="built_in">uniq</span>/total crashes 0/1, cal/max cover 50366/52583, corpus: 2656</span><br><span class="line">[2023-01-23T03:10:31Z INFO ] <span class="built_in">exec</span>: 71115, fuzz/repro 4/0, <span class="built_in">uniq</span>/total crashes 0/1, cal/max cover 50408/52658, corpus: 2660</span><br><span class="line">[2023-01-23T03:10:36Z WARN ] fuzzer-1: QEMU not alive, kernel maybe crashed, last executed prog:</span><br><span class="line">    r0 = syz_init_net_socket<span class="variable">$nl_generic</span>(0x10, 0x3, 0x10)</span><br><span class="line">    r1 = syz_genetlink_get_family_id<span class="variable">$netlbl_unlabel</span>(&amp;(0x7f0000000000)=<span class="string">&#x27;NLBL_UNLBL\x00&#x27;</span>, r0)</span><br><span class="line">    sendmsg<span class="variable">$NLBL_UNLABEL_C_STATICADDDEF</span>(r0, &amp;(0x7f0000000040)=&#123;&amp;(0x7f0000000080)=&#123;0x10, 0x0, 0x0, 0x4000&#125;, 0xc, &amp;(0x7f00000000c0)=&#123;&amp;(0x7f0000000100)=&#123;0x14, r1, 0x20, 0x70bd2d, 0x25dfdbff&#125;, 0x14&#125;, 0x1, 0x0, 0x0, 0x80&#125;, 0x2004c094)</span><br><span class="line">    r2 = syz_init_net_socket<span class="variable">$nl_generic</span>(0x10, 0x3, 0x10)</span><br><span class="line">    r3 = syz_genetlink_get_family_id<span class="variable">$netlbl_unlabel</span>(&amp;(0x7f0000000140)=<span class="string">&#x27;NLBL_UNLBL\x00&#x27;</span>, r0)</span><br><span class="line">    r4 = syz_genetlink_get_family_id<span class="variable">$netlbl_mgmt</span>(&amp;(0x7f0000000180)=<span class="string">&#x27;NLBL_MGMT\x00&#x27;</span>, r0)</span><br><span class="line">    sendmsg<span class="variable">$NLBL_MGMT_C_REMOVEDEF</span>(r0, &amp;(0x7f00000001c0)=&#123;&amp;(0x7f0000000200)=&#123;0x10, 0x0, 0x0, 0x20&#125;, 0xc, &amp;(0x7f0000000240)=&#123;&amp;(0x7f0000000280)=&#123;0x14, r4, 0x1, 0x70bd25, 0x25dfdbfb, &#123;&#125;, [@NLBL_MGMT_A_CLPDOI=&#123;0x8&#125;, @NLBL_MGMT_A_IPV4ADDR=&#123;0x8, 0x7, @multicast1&#125;, @NLBL_MGMT_A_FAMILY=&#123;0x6, 0xb, 0x1d&#125;, @NLBL_MGMT_A_IPV6ADDR=&#123;0x14, 0x5, @private0=&#123;0xfc, 0x0, <span class="string">&#x27;\x00&#x27;</span>, 0x1&#125;&#125;, @NLBL_MGMT_A_IPV4MASK=&#123;0x8, 0x8, @loopback&#125;, @NLBL_MGMT_A_IPV6ADDR=&#123;0x14, 0x5, @private1=&#123;0xfc, 0x1, <span class="string">&#x27;\x00&#x27;</span>, 0x1&#125;&#125;, @NLBL_MGMT_A_DOMAIN=&#123;0x11, 0x1, <span class="string">&#x27;NLBL_CIPSOv4\x00&#x27;</span>&#125;, @NLBL_MGMT_A_CLPDOI=&#123;0x8, 0xc, 0x3&#125;]&#125;, 0x14&#125;, 0x1, 0x0, 0x0, 0x20000024&#125;, 0x40004)</span><br><span class="line">    r5 = syz_genetlink_get_family_id<span class="variable">$netlbl_cipso</span>(&amp;(0x7f00000002c0)=<span class="string">&#x27;NLBL_CIPSOv4\x00&#x27;</span>, r0)</span><br></pre></td></tr></table></figure>
<h4 id="corpus"><a href="#corpus" class="headerlink" title="corpus"></a>corpus</h4><p>在 Healer 的 corpus 中会保存 fuzz 过程中出现 crash 的输入，以便分析人员进行进一步分析，以确定是否是漏洞。</p>
<p>input1</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> crash-01.txt</span><br><span class="line">fcntl<span class="variable">$getflags</span>(0x0, 0xb)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>input2</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> crash-02.txt</span><br><span class="line">pipe(&amp;(0x7f0000000000)=&#123;&lt;r0=&gt;0xffffffffffffffff, &lt;r1=&gt;0xffffffffffffffff&#125;)</span><br><span class="line">fcntl<span class="variable">$setlease</span>(r0, 0x400, 0x0)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>input3</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> crash-03.txt</span><br><span class="line">r0 = syz_open_dev<span class="variable">$tty1</span>(0xc, 0x4, 0x1)</span><br><span class="line">ioctl<span class="variable">$GIO_FONTX</span>(r0, 0x4b6b, &amp;(0x7f0000000000)=&#123;0x19e, 0x14, &amp;(0x7f0000000040)=<span class="string">&quot;&quot;</span>/1024&#125;)</span><br><span class="line">r1 = io_uring_setup(0x6169, &amp;(0x7f0000000440)=&#123;0x0, 0xb690, 0x2, 0x0, 0x158&#125;)</span><br><span class="line">r4 = syz_io_uring_setup(0x64c5, &amp;(0x7f00000004c0)=&#123;0x0, 0xe348, 0x1, 0x0, 0x2fc, 0x0, r1&#125;, &amp;(0x7f0000ffc000/0x1000)=nil, &amp;(0x7f0000ffb000/0x1000)=nil, &amp;(0x7f0000000540)=&lt;r2=&gt;0x0, &amp;(0x7f0000000580)=&lt;r3=&gt;0x0)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>input4</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> crash-04.txt</span><br><span class="line">r0 = syz_mount_image<span class="variable">$iso9660</span>(&amp;(0x7f0000000000)=<span class="string">&#x27;iso9660\x00&#x27;</span>, &amp;(0x7f0000000040)=<span class="string">&#x27;&#x27;</span>, 0x1, 0xd8, &amp;(0x7f0000000040)=[&#123;&amp;(0x7f0000000140)=<span class="string">&quot;e55ca9626ea5c0d6aaf9f799a44d38ddebf5677b13d1d3f0c9560881bde576e0af6afdc4f8b02de5fb2969c78a9868139052d99e919eff4de6aca6cbfe143f56d24e4e0717881507bdec6656d6469ec6a0348c1e61f2dfe28420762a21dd4271f56b8f84211dd440ec8a0afa1e84c8dfc67c88bb8beaa08844f767586a98e315c5ea00ae6cd8952bd69c961e83043f63a70c4e6049d842431ea18ec8b08c46bd4eda31907bb958311073a563e95dc25a1f9ffbc4269ed56a88ae605d864ac5e2de9ad32555f9d5e3569484a72782bac0705775efa90d35ffcf1f2efb9aab2a57c9ff31768b06ad56e16ff4db106f2360a16bee97e3aa00b02593ec21fca3e0e9c356b0fff64bd1a8a847d16dfe46bd72c63a60ad1c70242c7434986f22e5a8e68207fe6bf4e0b27c8f77159170657a31a36b545470114cec8a9a3364b0c1075b9ccdff52b9bc62881755c40dde474c03859cf3833ec2e48781f1bc86ab728d31ee88d7ef7c6c7916f9c3569a21131009f87844cdf749225fd90a0f7f796d615b5551acfaa5f109814ec7db7c7ba880eb9486a062322571382d7ca956101be3429877cbaee83a669358bde7482eaac532c77840c16a042c764ccf4671b249b9d0588c22e45a13101c399d4cd1a03944a9ccb5eadf9b69fd4a1c79087279941ed5785ed1f86225e3752ab516305d4235da60b12542251654eb159aa1986382088810753b0d882df62576d4fff475be6a16538599abec19a0108c22eb3c3e691cc03984354d6f3851958454c58fa77f457d9772cbde2a27d3fe1d47e20aaaa750c0d85c7059d43364b634a84aae17262d267c0f28cc818e6253c59b4951b3ab3180fd67c8a68491e1c7d3c115cda3373fd74aac00d7610acc524d3565e7dc39b7a451c72f332e53114e5822bf99b7a8741f3b0f4dce59cc15196739037f87d8e91146899bf7e31b60c57641c3ca54f543b80516e489a4396074dead09f0c1b104664e324c7eaf44819247ceaa71c08c547e717adad55223699ba6b923f93454eb690a8872308a8b2cc33f3b3ccc1250cea1c39b13dbb1d9f043356b902b7a4cf9019151e392588a798ffe72b5658e6773bb2db47971766f4da163dd7b2b1aef67bb4a1740ae2f029655c17543b3f8a8fba3c1549ee4f9da0e67f9094e9fc091a83c8347af05d5c842c64e7d2fe3cf1c06d02dd57336ffef9149863033d7cb99b7cb697ed98385331e2f748ba6051bff3cecbd8077917590816bc2eae0886d7ab93958b1ca65056d3fabedd852c490f138f730bc660dba840a9abf81f7a55e9fc97c0013a27bf5cf09e8caf940c9294aa6bc0866e1d6cb64227f2e56ed9c11943ddc150f02280b71a72d8583714ef6b24077b227ff087d48de0c675d2d15e1622f49d6a6c3508fd4ec19efb04ac7d4d1829e9935188744923e519be462363182a4c314aec33a08e7dd5d5739efc2bce8e94f2d72147534b695c5fba8ec250f183f131d16eb89cb4740b97b35472159d48a28c5e6c75445fa86983d2765758dcc54dde4a2117b560a9a3afe45b3d648076f205446def70005a895084c0335264a9c4cc71b09bfec463066047ba0c2a721b17ba12671e63a5639b03623c639d906817066a772cafe57560e153ce9dabb29461fe25b6db6c1285165e81b75b69f52b5439cc90a32e86b7d2f93c057caf1abad2c561b76bf80895f5528ec61159329de0241e0e5512da0aff3b23417dfc20fe5fffa360d387e3f6d3ae98dd1500e830fc9a1dd7ebb1507cf340a54f7b53b68e87c83c56a1ce034f289dab7f2dc41121199d20ea54c69bc7a8efe87f9f2d9d7afa732eb0a300784881325caa5f40a75f8a1294c1d8fbe946564a45e9eb4e22e3687f0b1dac945e4ab85279b5e364b34e9269c9ea573a7fc86d465543a45be514df31ed868f88db3117edb6a934a5f3daf929ac6c024c4c428b1781c19b06969a596d279d11caf3b8a14c523e210187f6050f18e79547b119709090c6cbc19b4f71ec88a98b05ffd77e798270fa11fb47bc7b7acb70c185665ff3adae0cee76cebe5c867fcf60e0e9a4befff62396bf1f6398d4b378131679b5cdd4d94d862ba64f74355a92daa78dac9953aadb315908901714ec29b155f0163f85a5cc077751349b3aec718d25772884ef65d51631d5f0ccce4fa2237536cc7d848cae45e285c58d811c3fe1b575803f6c3ca4504d49f9f490f9a1198836d4632b24b4950108ba980567181199f0f4962fc6b66245b15ff6a1d2e7d5d3c907bc26b1e1f1fc0a89228ee653a5c78bbff80e0b0f74da8c040a6b3a29a25e56cfa3fbdfb55fe84f7afa4ab9e31aafa0ddabaac77b81e32073ea1d41fb7fb56f4387277860a153ab2928059b2386a27e73d4fa2bd69ce071dc9ad68f8e43e62050cb695c51ecfc96a32da38ee3bc1d908806d31092d7412b9c49072217086f36c77f6dd5afc38fc53c5b425ac4a74349b1d216256ea0a7d4748fa581d2a543bd5cb658f60dcf3d22849e763f517239012cb3eee43da0b0345cef9af55e050a8206d97c4009c264202316637040f828c175c22812198928cff51f256ff829636c84070b5b6eed1a40a26628f382a1cc3aab05664c8f001410959c15a3f8ec547f7b6e951097810b8d8c84fbb6d10cd88cfbf1e21ba5899d110cae83a3738d2a761f17a99acf208a14dbba7db962248226df2d86bc68b9203546481411ebdf6dd593c6e56e3ee9cb2528bbbb6cb9fafac815059acdcd344eea285bd5c2b0f82f37595c2f61c4d07a3eae53918eb4a9b4aa1ca301a73e5a84768d12c33dc9aa0aee1fd45336b14240d1ef1cbc89ebe066c4409291409053ced7b72e260caf0852df4aa2e2ed2ff4677efee9ad0ea585e38a987c7b5e51abf7fe7f47110a16022dba024dda1e616a61986ccdbf41657b596a0d3263c2b6f060ae2c258257dbfe5b0cd092fb4d4112ba6e3df27353e351c753a3495ae69d7b0166864771569d23bf3f244f2ba9235d482be71b512fa1c2d1ad619093f9b0b10c5d57238c78d6439f7f9c6c91588d24a9be1063f523f53882965ac5747d5ba58c0e20107e867fab231c2ff469b5a511199f87e0fe477c1237e3ac41dbbbfdc0aa45d5eefa208f89ad635bf6e9f45f6721f89c8f4b53b1b5e251ae10dfd027161956f529c70545b44ea943b59870d4d5856215add0ca4e60e94b6ac908b333fbba7b4caf5b873322db9b780f8ae23c894b8c118ba2b614f81d0e4ed5135c0d1dfb28023ccfbd470a682bd6abe167bc15f21b4910f5b41830726b2cbd799f4285a73d582abb31a4c8a2f3ec723c01de86ba54f508c0e71c332657876984e5e5f2780d10984d20251bf64ce1c3340eef538c3c1d2963cd4211ad8ab5ed591fe43882119c234d1cdb41bc9025312fe021474d0eca2c071edd872a91c18298b80848db533f93ddebb86f01d191d4dfcedd2a3332c8943c7c22229e29515b5df19d751878f42dbcd3e53e11ea85c6bf8f300a29aba850303ff6c75ee57b38e26a8e60bcf990e75f263318be16e4a03026a8f3f8fbeec1454bfc642a76bf1cf0e3915509023f81eabf59a8328d6d222358cbf01e6c99323fa65b5c463cc8b32faf03201f296c8f21945def1de8dc8b8bf4c0a5b7d612cc22426ad79f7f4ee255fb8a2&quot;</span>, 0xa1c, 0xfe&#125;, &#123;&amp;(0x7f0000000b80)=<span class="string">&quot;c269601c6347bde108f675177b8153f40e93a911a94587ed28d8b94db94870c0630d0d13ea580232319af5&quot;</span>, 0x2b&#125;, &#123;&amp;(0x7f0000000bc0)=<span class="string">&quot;6f376e741eae53029a7a1502e00015dd6a2048c9d6a5b39d44488dd83f334086e1843dc78ab1f9d1129ccef4fc64bb2285a1e190f9ea6ecfefe26b25fc&quot;</span>, 0x3d&#125;, &#123;&amp;(0x7f0000000c00)=<span class="string">&quot;3f247115f8bb7c29&quot;</span>, 0x8, 0x4548e19cee878de2&#125;, &#123;&amp;(0x7f0000000c40)=<span class="string">&quot;2d99181de433187dfe75ec343796331bcac6d72028650cea6ac891a4a4e9ab3294&quot;</span>, 0x21, 0x7b1&#125;, &#123;&amp;(0x7f0000000c80)=<span class="string">&quot;&quot;</span>&#125;, &#123;&amp;(0x7f0000000c80)=<span class="string">&quot;b077687af86cd3bf422e338906ad72e337e88fb22e89a3c4c3a254bdc4013c57cfd5e1108064cfe6321fc972d866000106dae3814078f9689c019739b077c2b2442e910eb0ae03a72ed527da&quot;</span>, 0x4c&#125;, &#123;&amp;(0x7f0000000d00)=<span class="string">&quot;de22d24c937d0e6cdb6f5c32c10d1afe2d5ff59febc1c963e9febc5237b84001e7b1c4e8a259b071&quot;</span>, 0x28, 0x2&#125;, &#123;&amp;(0x7f0000000d40)=<span class="string">&quot;7ad4f0b3e417bf4e9efa50c80632b890&quot;</span>, 0x10, 0x234c653282dd698c&#125;], 0x800, &amp;(0x7f0000000d80)=&#123;[&#123;@hide&#125;, &#123;@map_normal&#125;]&#125;)</span><br><span class="line">r1 = socket<span class="variable">$isdn</span>(0x22, 0x3, 0x4)</span><br><span class="line">r2 = syz_mount_image<span class="variable">$btrfs</span>(&amp;(0x7f0000000dc0)=<span class="string">&#x27;btrfs\x00&#x27;</span>, &amp;(0x7f0000000e00)=<span class="string">&#x27;&#x27;</span>, 0x0, 0x90, &amp;(0x7f0000000e00)=[&#123;&amp;(0x7f0000000ec0)=<span class="string">&quot;6c948164a0b670f1e9886e5886646f6148a9df2298c0d53f7ec20744a49a8d00440c0b7aafcd48abe11e1c615d183252&quot;</span>, 0x30&#125;, &#123;&amp;(0x7f0000000f00)=<span class="string">&quot;0b504524de704bced6e5285d01c1ca054e2e6b785b95e78b239ca91ba649b0b20b6046b71adcc9f577b01d10c663fd388c8a20f867488aacb1&quot;</span>, 0x39, 0xc&#125;, &#123;&amp;(0x7f0000000f40)=<span class="string">&quot;&quot;</span>&#125;, &#123;&amp;(0x7f0000000f40)=<span class="string">&quot;e26991ba5b3e9a4f1141cbe8568ec3c0087da8dc95873c18b06d3135e3cf0a748f48b2b8aeaf5e4633cb128e3648a6ae1bc16d5f8086860933423be90c02eb796f5171ab6e4ce0b61676d6924ea5b7fb0810bd86f79b3ff70efe0f1cb860b9ee16031cf13bbf1a4db93013403fb98b42cf759b564f5423c7133c9072f565deb9d8515b9fef201df49a66a9fe9731a3889bd9ecbfb4d01a6baefcbf720099687f030e8f0794eb89b0efc8ca72d14710819b40067f5d8300bf958ecf6c3b8374a09431590a18c39e68e7e2d6b0278dd4b1dc8f3d99d3878bb3670a81738cb62b9f550486ef11b53af9a69c1001831f01e1bb395b5571738720a11f14a49c56f80c9a87067d6bb660fba539896ab7443e44dff40032e07265afcd8e5ecded93952b95fe2ed633698057af4c950d5c16a267add25b05a24b683058edd881ce94717e546460333505b99d02f048d1ebeecb538227f75ab351f498bfd780e4c7ea9317fc7bfa9f0064903ec588d339f796b5bb721e9179b2e891dcaa1cb2770991b9b7a777d5f29f98a4da1777b0dfeec351674940840d204207887764ea89113c55f8a606d834d4722e8834356e6637e8c55e95542ff437db65e9a75b91d1a7e0902956eb46cc3d6c1fb54ce9bd649114209cb985860c172ed41c13feba283c1192e0b8216c3ad80768d24301344be12ebaeb123bd4ef0872a8541f52bf7efa6b969c96da9f80749b1dbac1c7e0c8480027dd0c095839498b3119fee1a09b652caba6ea1a79256f01456aa3b454fa21a66a59984cd56ecfc14454b96556a320d12bd8ba198cc65bd35ebbdf8b9b09e745247b8d5f5d16b43c60d31c691a596a5befca32d619165c4d502f6a588b4ae0ecc72e33fa07d900638432231c266bff739d7fe3be54f58fa4374b95b77d5b55faf17ecee9ef5ae1ddb4cd64fa416f697d298fd7259a70a9287d133c3cafc1b6f0591be86d189d9660094525411f0dd288ae0d8a89f5533ff69550313a1c80cea3b4ea70f4ae6a4c409f5bab9f0f22c1e91f66ff15cd1ff1a37657cc9aa6ad6342d5881c7ac87764d133b53b489d9edf22cfaccc468b0ae195c867f283f6b8f2d9e81e28f7e04f3bdf6a880029cac1e0afd62694c0aa95e2d053ad6b73df0ce1332248aaaa6dd42ca3be21912ccd114661e9da7ec0b2b28d79f60e223370cf9bf354497a0d3eedcbcb21b258d064550a0bbd14ffdfbc58e6ecdf119b37f7f11dc61e4e8ec1441a4eb063e53b1c6f6088b8f68b4f1637b6e2c9df2e30a8571f6fe6333644bf6c60a17945e38a6c35381e7f1a9324b5a4d42cf8958525374345621c841a5b8514c229171766c3431de6a4392e5f1d16e2e871b02b37f61bbc7c383cfb5d73b9b90b6c69db1d669ce8d19fc6843656ecfaff39e120ddbe2dfae6ff63b864f8529216cbe611ed7fdf796b2aeb641150b59e1b5963404b13cb7e5ae0e6b7fe41ee1609e0901676953fb5353b48bc5914e11f3201533edaadec6bf2e9e6aa143ca11027f67c1f1f1f7c0021e35bce11a78a2157514a0e2eee0bcabd2f150fe1eda4292845272959afd5e7edc39e943075390c0100687cfc816b5961d87812645318ba3bac96a610d6a60a64a1d9b1e29656788124a73ae6ca798875a530ceb195ba28497416d13a2a5a293046415a0125812fad8cd0c55d563113e648fff08d03e5b32c68589f7f37a2f7c119620dceeef8446e24c1a665054558739be5be88644659c864c135ed3d63b8ee8456db39c3cb7a71fbb9115302c8d6ba91053bd2a1b2de575d5537d29d38522a3cc8122d4dbb9be7ea567db2460a439827c70f19442c5250703f75c80211f33ffec21f818e59a25746b5881430052caf2cf70650bebd8202df0fd87a67ec6d24a615dca93938abebcefe2ccda9771f3696c2ef71ed62e6c844f0a202bce6f2724b89b1aa0d2fe576a9ce64edae2a722961d2af4e5cb2ee88b8b2a69599cbc0e3c6569f7ebae9fb2ec66a457ad89453121cc36eb8ebec84bb5648a17778b759487367b25949afa88a09f61df108004f8426edbf426d167e87ab14bc4a16236981e89a265475764d17d98940920eb603c56742b216831822b0549ab972b140d9f28261e18717d50527d2d72d70559a5aff54fa2a39af5ba863716816519ee40713e6c2d109b165eea6c2415bf213e99ed65c7a991a4bf5ab8ce647ed84bf140ecc854b9047e4&quot;</span>, 0x621, 0xf8fcc2a4e31256dd&#125;, &#123;&amp;(0x7f0000001580)=<span class="string">&quot;06512e7f8c431f55cc984d2e3b97a09318b9370bd5e0296ca77125ffaa4107d41b3e7df0db1d6aee372bbd02f6af18ba52e47df0384cf1ea5a98ffbc21fa2d8ff08ebb6fc814d42742e169a48b533e065fca0c41a8f8c87bbc9c55578a51d99d0b09a4f8a802f0662b2c541ff48f5d8b18131d403b184b8b8c61e37e1337c2&quot;</span>, 0x7f, 0xb&#125;, &#123;0x0, 0x0, 0xf&#125;], 0x2000032, &amp;(0x7f0000001600)=&#123;[&#123;@subvolid&#125;, &#123;@nodatacow&#125;, &#123;@max_inline=&#123;<span class="string">&#x27;max_inline&#x27;</span>, 0x3d, [0x6b, 0x78, 0x34, 0x35]&#125;&#125;, &#123;@enospc_debug&#125;, &#123;&#125;, &#123;@compress_force_algo=&#123;<span class="string">&#x27;compress-force&#x27;</span>, 0x3d, <span class="string">&#x27;lzo&#x27;</span>&#125;&#125;], [&#123;@context=&#123;<span class="string">&#x27;context&#x27;</span>, 0x3d, <span class="string">&#x27;staff_u&#x27;</span>&#125;&#125;, &#123;@fsname=&#123;<span class="string">&#x27;fsname&#x27;</span>, 0x3d, <span class="string">&#x27;/dev/vcsa#\x00&#x27;</span>&#125;&#125;]&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="0x03-核心代码"><a href="#0x03-核心代码" class="headerlink" title="0x03 核心代码"></a>0x03 核心代码</h2><p>本部分将对 HEALER 的部分代码进行简要分析。本部分代码以 <a target="_blank" rel="noopener" href="https://github.com/SunHao-0/healer/tree/2efbb44c7dfaaa6749cd1541949b26fd1d2143fa">2022/02/23 2efbb44</a> 为样例。</p>
<h3 id="功能性代码"><a href="#功能性代码" class="headerlink" title="功能性代码"></a>功能性代码</h3><h4 id="minimize"><a href="#minimize" class="headerlink" title="minimize"></a>minimize</h4><p>工具接口位置 <code>healer/tools/minimize/src/main.rs</code> 。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// healer/tools/minimize/src/main.rs: line 1</span></span><br><span class="line"><span class="keyword">use</span> healer_core::gen::&#123;<span class="keyword">self</span>, minimize&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// line 61</span></span><br><span class="line">    <span class="title function_ invoke__">minimize</span>(&amp;target, &amp;<span class="keyword">mut</span> p, idx, |p, idx| &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&gt; current prog:\n&#123;&#125;&quot;</span>, p.<span class="title function_ invoke__">display</span>(&amp;target));</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;current idx: &#123;&#125;&quot;</span>, idx);</span><br><span class="line">        <span class="title function_ invoke__">read_line</span>().<span class="title function_ invoke__">to_ascii_lowercase</span>().<span class="title function_ invoke__">trim</span>() == <span class="string">&quot;y&quot;</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<p>代码实现位置 <code>healer/healer_core/src/gen/mod.rs</code> 。</p>
<p>实现上和文章中提到的一致，通过从最后一个系统调用往前枚举(<code>line 11</code>) 然后逐一移除前面的系统调用(<code>line 19</code>) ，判断是否发生覆盖率改变来确定系统调用是否可以移除(<code>line 20</code>)。 </p>
<p><code>fixup</code> (<code>line 27</code>) 定义在 <code>healer/healer_core/src/mutation/mod.rs: 182</code> 用于修正移除之后的一些地址值和重定向等。</p>
<blockquote>
<p>/// Fixup the addr of ptr value, re-order res id and re-collect generated res and used res of calls.</p>
</blockquote>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// healer/healer_core/src/gen/mod.rs: line 194</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">minimize</span>(</span><br><span class="line">    target: &amp;Target,</span><br><span class="line">    p: &amp;<span class="keyword">mut</span> Prog,</span><br><span class="line">    <span class="keyword">mut</span> idx: <span class="type">usize</span>,</span><br><span class="line">    <span class="keyword">mut</span> pred: <span class="keyword">impl</span> <span class="title class_">FnMut</span>(&amp;Prog, <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">bool</span>,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">    <span class="built_in">debug_assert!</span>(!p.calls.<span class="title function_ invoke__">is_empty</span>());</span><br><span class="line">    <span class="built_in">debug_assert!</span>(idx &lt; p.calls.<span class="title function_ invoke__">len</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> (<span class="number">0</span>..p.calls.<span class="title function_ invoke__">len</span>()).<span class="title function_ invoke__">rev</span>() &#123;</span><br><span class="line">        <span class="keyword">if</span> i == idx &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">new_idx</span> = idx;</span><br><span class="line">        <span class="keyword">if</span> i &lt; idx &#123;</span><br><span class="line">            new_idx -= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">new_p</span> = p.<span class="title function_ invoke__">remove_call</span>(i);</span><br><span class="line">        <span class="keyword">if</span> !<span class="title function_ invoke__">pred</span>(&amp;new_p, new_idx) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        *p = new_p;</span><br><span class="line">        idx = new_idx;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">fixup</span>(target, p.<span class="title function_ invoke__">calls_mut</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO Add args minimization</span></span><br><span class="line"></span><br><span class="line">    idx</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="generate"><a href="#generate" class="headerlink" title="generate"></a>generate</h4><h5 id="mod-rs"><a href="#mod-rs" class="headerlink" title="mod.rs"></a>mod.rs</h5><p>代码实现在 <code>healer/healer_core/src/gen/mod.rs</code> 。</p>
<p>该代码定义了和生成相关的功能和函数。</p>
<p><strong>next_prog_len</strong></p>
<p>该函数负责给出下一个 prog 中的系统调用的个数，即序列的长度。</p>
<p>获取上一次设定的长度作为当前 prog 的长度(<code>line 4</code>)，然后获取 prog 的长度范围之后，尝试设置下一个 prog 的长度为比当前长 1，如果其长度超过了 prog 的范围则设置下一个 prog 长度为允许的最短长度。</p>
<p>即每次获取的长度在 prog 允许的范围中进行循环遍历。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// healer/healer_core/src/gen/mod.rs: line 63</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">next_prog_len</span>() <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">    NEXT_PROG_LEN.<span class="title function_ invoke__">with</span>(|next_len| &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">len</span> = next_len.<span class="title function_ invoke__">get</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">r</span> = <span class="title function_ invoke__">prog_len_range</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">new_len</span> = len + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> new_len &gt;= r.end &#123;</span><br><span class="line">            new_len = FAVORED_MIN_PROG_LEN</span><br><span class="line">        &#125;;</span><br><span class="line">        next_len.<span class="title function_ invoke__">set</span>(new_len);</span><br><span class="line">        len</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>prog 允许的长度范围为手动指定，硬编码在代码中的(<code>line 2</code>)。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// healer/healer_core/src/gen/mod.rs: line 37</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> FAVORED_MIN_PROG_LEN: <span class="type">usize</span> = <span class="number">16</span>;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> FAVORED_MAX_PROG_LEN: <span class="type">usize</span> = <span class="number">25</span>;</span><br><span class="line"></span><br><span class="line">thread_local! &#123;</span><br><span class="line">    <span class="keyword">static</span> NEXT_PROG_LEN: Cell&lt;<span class="type">usize</span>&gt; = Cell::<span class="title function_ invoke__">new</span>(FAVORED_MIN_PROG_LEN);</span><br><span class="line">    <span class="keyword">static</span> PROG_LEN_RANGE: Cell&lt;(<span class="type">usize</span>, <span class="type">usize</span>)&gt; = Cell::<span class="title function_ invoke__">new</span>((FAVORED_MIN_PROG_LEN, FAVORED_MAX_PROG_LEN));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="comment">// healer/healer_core/src/gen/mod.rs: line 52</span></span><br><span class="line"><span class="comment">/// Get current prog length range</span></span><br><span class="line"><span class="meta">#[inline]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">prog_len_range</span>() <span class="punctuation">-&gt;</span> Range&lt;<span class="type">usize</span>&gt; &#123;</span><br><span class="line">    PROG_LEN_RANGE.<span class="title function_ invoke__">with</span>(|r| &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">v</span> = r.<span class="title function_ invoke__">get</span>();</span><br><span class="line">        Range &#123;</span><br><span class="line">            start: v.<span class="number">0</span>,</span><br><span class="line">            end: v.<span class="number">1</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Generate Prog</strong></p>
<p>负责从学习到的关系中不断随机选择一个系统调用(<code>line 18</code>)插入到当前上下文的输入序列中(<code>line 50</code>)，直到系统调用数量达到允许的最大值(<code>line 7</code>)。</p>
<p>而在函数 <code>gen_one_call</code> 中负责对一个实际的系统调用进行构造和设计。通过传入的系统调用序号(sid)来选择这个系统调用(<code>line 29</code>)，然后获取其对应的参数(<code>line 30</code>)，然后枚举其所有的参数，并将对应的参数设置好初始值(<code>line 31</code>)。</p>
<p>代码实现位置 <code>healer/healer_core/src/gen/mod.rs: line 76</code> 。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// healer/healer_core/src/gen/mod.rs: line 76</span></span><br><span class="line"><span class="comment">/// Generate prog based on `target` and `relation`.</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">gen_prog</span>(target: &amp;Target, relation: &amp;RelationWrapper, rng: &amp;<span class="keyword">mut</span> RngType) <span class="punctuation">-&gt;</span> Prog &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">ctx</span> = Context::<span class="title function_ invoke__">new</span>(target, relation);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">len</span> = <span class="title function_ invoke__">next_prog_len</span>();</span><br><span class="line">    debug_info!(<span class="string">&quot;prog len: &#123;&#125;&quot;</span>, len);</span><br><span class="line">    <span class="keyword">while</span> ctx.<span class="title function_ invoke__">calls</span>().<span class="title function_ invoke__">len</span>() &lt; len &#123;</span><br><span class="line">        <span class="title function_ invoke__">gen_call</span>(&amp;<span class="keyword">mut</span> ctx, rng);</span><br><span class="line">    &#125;</span><br><span class="line">    debug_info!(<span class="string">&quot;Context:\n&#123;&#125;&quot;</span>, ctx);</span><br><span class="line">    <span class="title function_ invoke__">fixup</span>(target, &amp;<span class="keyword">mut</span> ctx.calls);</span><br><span class="line">    ctx.<span class="title function_ invoke__">to_prog</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Add a syscall to `context`.</span></span><br><span class="line"><span class="meta">#[inline]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">gen_call</span>(ctx: &amp;<span class="keyword">mut</span> Context, rng: &amp;<span class="keyword">mut</span> RngType) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">sid</span> = <span class="title function_ invoke__">select</span>(ctx, rng);</span><br><span class="line">    <span class="title function_ invoke__">gen_one_call</span>(ctx, rng, sid)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// healer/healer_core/src/gen/mod.rs: line 119</span></span><br><span class="line"><span class="comment">/// Generate syscall `sid` to `context`.</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">gen_one_call</span>(ctx: &amp;<span class="keyword">mut</span> Context, rng: &amp;<span class="keyword">mut</span> RngType, sid: SyscallId) &#123;</span><br><span class="line">    <span class="title function_ invoke__">push_builder</span>(sid);</span><br><span class="line">    debug_info!(<span class="string">&quot;generating: &#123;&#125;&quot;</span>, ctx.<span class="title function_ invoke__">target</span>().<span class="title function_ invoke__">syscall_of</span>(sid));</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">syscall</span> = ctx.<span class="title function_ invoke__">target</span>().<span class="title function_ invoke__">syscall_of</span>(sid);</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">args</span> = <span class="type">Vec</span>::<span class="title function_ invoke__">with_capacity</span>(syscall.<span class="title function_ invoke__">params</span>().<span class="title function_ invoke__">len</span>());</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">param</span> <span class="keyword">in</span> syscall.<span class="title function_ invoke__">params</span>() &#123;</span><br><span class="line">        args.<span class="title function_ invoke__">push</span>(<span class="title function_ invoke__">gen_ty_value</span>(</span><br><span class="line">            ctx,</span><br><span class="line">            rng,</span><br><span class="line">            param.<span class="title function_ invoke__">ty</span>(),</span><br><span class="line">            param.<span class="title function_ invoke__">dir</span>().<span class="title function_ invoke__">unwrap_or</span>(Dir::In),</span><br><span class="line">        ));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="title function_ invoke__">need_calculate_len</span>() &#123;</span><br><span class="line">        <span class="title function_ invoke__">calculate_len_args</span>(ctx.<span class="title function_ invoke__">target</span>(), syscall.<span class="title function_ invoke__">params</span>(), &amp;<span class="keyword">mut</span> args);</span><br><span class="line">        <span class="title function_ invoke__">len_calculated</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ret</span> = syscall.<span class="title function_ invoke__">ret</span>().<span class="title function_ invoke__">map</span>(|ty| &#123;</span><br><span class="line">        <span class="built_in">assert!</span>(!ty.<span class="title function_ invoke__">optional</span>());</span><br><span class="line">        <span class="title function_ invoke__">gen_ty_value</span>(ctx, rng, ty, Dir::Out)</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">builder</span> = <span class="title function_ invoke__">pop_builder</span>();</span><br><span class="line">    builder.<span class="title function_ invoke__">args</span>(args).<span class="title function_ invoke__">ret</span>(ret);</span><br><span class="line">    ctx.<span class="title function_ invoke__">append_call</span>(builder.<span class="title function_ invoke__">build</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>gen_ty_value</strong></p>
<p>该函数是一个负责根据对应的类型生成相应的值的函数接口，负责根据传入的类型调用其他模块中实现的函数来处理数据。</p>
<p>代码实现位置 <code>healer/healer_core/src/gen/mod.rs: line 165</code> 。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// healer/healer_core/src/gen/mod.rs: line 146</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">type</span> <span class="title class_">Generator</span> = <span class="title function_ invoke__">fn</span>(&amp;<span class="keyword">mut</span> Context, &amp;<span class="keyword">mut</span> RngType, &amp;Type, Dir) <span class="punctuation">-&gt;</span> Value;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> GENERATOR: [Generator; <span class="number">15</span>] = [</span><br><span class="line">    gen_res,</span><br><span class="line">    gen_const,</span><br><span class="line">    gen_int,</span><br><span class="line">    gen_flags,</span><br><span class="line">    gen_len,</span><br><span class="line">    gen_proc,</span><br><span class="line">    gen_csum,</span><br><span class="line">    gen_vma,</span><br><span class="line">    gen_buffer_blob,</span><br><span class="line">    gen_buffer_string,</span><br><span class="line">    gen_buffer_filename,</span><br><span class="line">    gen_array,</span><br><span class="line">    gen_ptr,</span><br><span class="line">    gen_struct,</span><br><span class="line">    gen_union,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// healer/healer_core/src/gen/mod.rs: line 165</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">gen_ty_value</span>(ctx: &amp;<span class="keyword">mut</span> Context, rng: &amp;<span class="keyword">mut</span> RngType, ty: &amp;Type, dir: Dir) <span class="punctuation">-&gt;</span> Value &#123;</span><br><span class="line">    <span class="keyword">use</span> TypeKind::*;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> dir == Dir::Out &amp;&amp; matches!(ty.<span class="title function_ invoke__">kind</span>(), Const | Int | Flags | Proc | Vma) &#123;</span><br><span class="line">        ty.<span class="title function_ invoke__">default_value</span>(dir)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ty.<span class="title function_ invoke__">optional</span>() &amp;&amp; rng.<span class="title function_ invoke__">gen_ratio</span>(<span class="number">1</span>, <span class="number">5</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(ty) = ty.<span class="title function_ invoke__">as_res</span>() &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">v</span> = ty.<span class="title function_ invoke__">special_vals</span>().<span class="title function_ invoke__">choose</span>(rng).<span class="title function_ invoke__">copied</span>().<span class="title function_ invoke__">unwrap_or</span>(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">return</span> ResValue::<span class="title function_ invoke__">new_null</span>(ty.<span class="title function_ invoke__">id</span>(), dir, v).<span class="title function_ invoke__">into</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        ty.<span class="title function_ invoke__">default_value</span>(dir)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        GENERATOR[ty.<span class="title function_ invoke__">kind</span>() <span class="keyword">as</span> <span class="type">usize</span>](ctx, rng, ty, dir)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>147 行的 <code>GENERATOR</code> 则是对其他模块实现的函数进行封装的函数数组，对应各种类型的实现都在同目录下(<code>healer/healer_core/src/gen/</code>)，这里不再赘述。</p>
<h4 id="mutation"><a href="#mutation" class="headerlink" title="mutation"></a>mutation</h4><p>代码实现位置 <code>healer/healer_core/src/mutation/</code> ，该文件夹中多个文件分别对不同场景下的变异进行了实现。</p>
<h5 id="mod-rs-1"><a href="#mod-rs-1" class="headerlink" title="mod.rs"></a>mod.rs</h5><p>该代码实现在 <code>healer/healer_core/src/mutation/mod.rs</code> 。</p>
<p>这个代码中定义了函数 <code>mutate</code> (<code>healer/healer_core/src/mutation/mod.rs: 29</code>)  。</p>
<p>在这个函数中定义了4种变异操作：<code>insert_calls</code> , <code>mutate_call_args</code> , <code>splice</code> , <code>remove_call</code> (<code>line 11</code>)。</p>
<p>具体的变异规则为：</p>
<ol>
<li>最多尝试连续变异 128次，同时必须满足下面条件之一(<code>line 21</code>)：<ul>
<li>没有变异成功过</li>
<li>或者一个系统调用都没有（有可能一直在移除，把系统调用移除完了那也不行</li>
<li>或者满足一个实现设定的概率会继续变异</li>
</ul>
</li>
<li>进行变异时，按照设定的权重从四种变异方式中选择一种(<code>line 22</code>)。</li>
<li>如果变异之后系统调用数量太多了，超过了当前设定的长度，就会直接移除多余的系统调用。</li>
<li>最后进行一些收尾工作，释放空间、修复参数等。</li>
</ol>
<p>根据设定的权重从四种变异中选择一种。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// healer/healer_core/src/mutation/mod.rs: line 29</span></span><br><span class="line"><span class="comment">/// Muate input prog `p`</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">mutate</span>(</span><br><span class="line">    target: &amp;Target,</span><br><span class="line">    relation: &amp;RelationWrapper,</span><br><span class="line">    corpus: &amp;CorpusWrapper,</span><br><span class="line">    rng: &amp;<span class="keyword">mut</span> RngType,</span><br><span class="line">    p: &amp;<span class="keyword">mut</span> Prog,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">MutateOperation</span> = <span class="title function_ invoke__">fn</span>(&amp;<span class="keyword">mut</span> Context, &amp;CorpusWrapper, &amp;<span class="keyword">mut</span> RngType) <span class="punctuation">-&gt;</span> <span class="type">bool</span>;</span><br><span class="line">    <span class="keyword">const</span> OPERATIONS: [MutateOperation; <span class="number">4</span>] = [insert_calls, mutate_call_args, splice, remove_call];</span><br><span class="line">    <span class="keyword">const</span> WEIGHTS: [<span class="type">u64</span>; <span class="number">4</span>] = [<span class="number">400</span>, <span class="number">980</span>, <span class="number">999</span>, <span class="number">1000</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">calls</span> = std::mem::<span class="title function_ invoke__">take</span>(&amp;<span class="keyword">mut</span> p.calls);</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">ctx</span> = Context::<span class="title function_ invoke__">new</span>(target, relation);</span><br><span class="line">    <span class="title function_ invoke__">restore_partial_ctx</span>(&amp;<span class="keyword">mut</span> ctx, &amp;calls);</span><br><span class="line">    ctx.calls = calls;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">mutated</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">tries</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> tries &lt; <span class="number">128</span> &amp;&amp; (!mutated || ctx.calls.<span class="title function_ invoke__">is_empty</span>() || rng.<span class="title function_ invoke__">gen_ratio</span>(<span class="number">1</span>, <span class="number">2</span>)) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">idx</span> = <span class="title function_ invoke__">choose_weighted</span>(rng, &amp;WEIGHTS);</span><br><span class="line">        debug_info!(<span class="string">&quot;using strategy-&#123;&#125;&quot;</span>, idx);</span><br><span class="line">        mutated = OPERATIONS[idx](&amp;<span class="keyword">mut</span> ctx, corpus, rng);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ctx.calls.<span class="title function_ invoke__">len</span>() &gt;= <span class="title function_ invoke__">prog_len_range</span>().end &#123;</span><br><span class="line">            <span class="title function_ invoke__">remove_extra_calls</span>(&amp;<span class="keyword">mut</span> ctx);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// clear mem usage, fixup later</span></span><br><span class="line">        ctx.mem_allocator.<span class="title function_ invoke__">restore</span>();</span><br><span class="line">        <span class="comment">// clear newly added res</span></span><br><span class="line">        ctx.res_ids.<span class="title function_ invoke__">clear</span>();</span><br><span class="line">        ctx.res_kinds.<span class="title function_ invoke__">clear</span>();</span><br><span class="line"></span><br><span class="line">        tries += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> mutated &#123;</span><br><span class="line">        <span class="title function_ invoke__">fixup</span>(ctx.target, &amp;<span class="keyword">mut</span> ctx.calls);</span><br><span class="line">    &#125;</span><br><span class="line">    *p = ctx.<span class="title function_ invoke__">to_prog</span>();</span><br><span class="line"></span><br><span class="line">    mutated</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="seq-rs"><a href="#seq-rs" class="headerlink" title="seq.rs"></a>seq.rs</h5><p>该代码实现在 <code>healer/healer_core/src/mutation/seq.rs</code> 。</p>
<p>实现了三种变异操作： <code>insert_calls(line 37)</code>  , <code>splice(line 16)</code> , <code>remove_call(line 59)</code> 。</p>
<p><strong>insert_calls</strong></p>
<p>负责随机插入一些系统调用进去。</p>
<ol>
<li>如果系统调用的长度已经超过了当前要的系统调用长度则直接退出插入变异，变异失败(<code>line 4</code>)。</li>
<li>在已有的系统调用中随机选择一个位置(<code>line 8</code>)。</li>
<li>然后调用 <code>gen_one_call</code> 生成变异后的系统调用序列。</li>
</ol>
<p>代码实现在: <code>healer/healer_core/src/mutation/seq.rs: line 37</code> 。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// healer/healer_core/src/mutation/seq.rs: line 37</span></span><br><span class="line"><span class="comment">/// Insert calls to random location of ctx&#x27;s calls.</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">insert_calls</span>(ctx: &amp;<span class="keyword">mut</span> Context, _corpus: &amp;CorpusWrapper, rng: &amp;<span class="keyword">mut</span> RngType) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ctx.calls.<span class="title function_ invoke__">len</span>() &gt; <span class="title function_ invoke__">prog_len_range</span>().end &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">idx</span> = rng.<span class="title function_ invoke__">gen_range</span>(<span class="number">0</span>..=ctx.calls.<span class="title function_ invoke__">len</span>());</span><br><span class="line">    <span class="title function_ invoke__">restore_res_ctx</span>(ctx, idx); <span class="comment">// restore the resource information before call `idx`</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">sid</span> = <span class="title function_ invoke__">select_call_to</span>(ctx, rng, idx);</span><br><span class="line">    debug_info!(</span><br><span class="line">        <span class="string">&quot;insert_calls: inserting &#123;&#125; to location &#123;&#125;&quot;</span>,</span><br><span class="line">        ctx.target.<span class="title function_ invoke__">syscall_of</span>(sid).<span class="title function_ invoke__">name</span>(),</span><br><span class="line">        idx</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">calls_backup</span> = std::mem::<span class="title function_ invoke__">take</span>(&amp;<span class="keyword">mut</span> ctx.calls);</span><br><span class="line">    <span class="title function_ invoke__">gen_one_call</span>(ctx, rng, sid);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">new_calls</span> = std::mem::<span class="title function_ invoke__">take</span>(&amp;<span class="keyword">mut</span> ctx.calls);</span><br><span class="line">    debug_info!(<span class="string">&quot;insert_calls: &#123;&#125; call(s) inserted&quot;</span>, new_calls.<span class="title function_ invoke__">len</span>());</span><br><span class="line">    calls_backup.<span class="title function_ invoke__">splice</span>(idx..idx, new_calls);</span><br><span class="line">    ctx.calls = calls_backup;</span><br><span class="line">    <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>splice</strong></p>
<p>负责从 <code>corpus</code> 中随机选择一个，然后进行分割后与当前的系统调用进行拼接。</p>
<ol>
<li>如果当前没有系统调用或者系统调用长度超过了最大长度或者种子库为空，则这种拼接变异失败(<code>line 4</code>)。</li>
<li>然后随机从种子库中选择一个(<code>line 8</code>)，然后随机选择一个位置(<code>line 13</code>)进行拼接(<code>line 19</code>)。</li>
</ol>
<p>代码实现在: <code>healer/healer_core/src/mutation/seq.rs: line 16</code> 。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// healer/healer_core/src/mutation/seq.rs: line 16</span></span><br><span class="line"><span class="comment">/// Select a prog from `corpus` and splice it with calls in the `ctx` randomly.</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">splice</span>(ctx: &amp;<span class="keyword">mut</span> Context, corpus: &amp;CorpusWrapper, rng: &amp;<span class="keyword">mut</span> RngType) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ctx.calls.<span class="title function_ invoke__">is_empty</span>() || ctx.calls.<span class="title function_ invoke__">len</span>() &gt; <span class="title function_ invoke__">prog_len_range</span>().end || corpus.<span class="title function_ invoke__">is_empty</span>() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p</span> = corpus.<span class="title function_ invoke__">select_one</span>(rng).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">calls</span> = p.calls;</span><br><span class="line">    <span class="comment">// mapping resource id of `calls`, continue with current `ctx.next_res_id`</span></span><br><span class="line">    <span class="title function_ invoke__">mapping_res_id</span>(ctx, &amp;<span class="keyword">mut</span> calls);</span><br><span class="line">    <span class="title function_ invoke__">restore_partial_ctx</span>(ctx, &amp;calls);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">idx</span> = rng.<span class="title function_ invoke__">gen_range</span>(<span class="number">0</span>..=ctx.calls.<span class="title function_ invoke__">len</span>());</span><br><span class="line">    debug_info!(</span><br><span class="line">        <span class="string">&quot;splice: splicing &#123;&#125; call(s) to location &#123;&#125;&quot;</span>,</span><br><span class="line">        calls.<span class="title function_ invoke__">len</span>(),</span><br><span class="line">        idx</span><br><span class="line">    );</span><br><span class="line">    ctx.calls.<span class="title function_ invoke__">splice</span>(idx..idx, calls);</span><br><span class="line">    <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>remove_call</strong></p>
<p>该部分负责将从系统调用序列中随机一个位置移除后面的系统调用。</p>
<ol>
<li>如果当前一个系统调用都没有，则直接结束，变异失败 (<code>line 3</code>)。</li>
<li>否则就从系统调用序列中随机选择一个位置(<code>line 7</code>)，然后移除后面的系统调用(<code>line 11</code>)。</li>
</ol>
<p>代码实现在: <code>healer/healer_core/src/mutation/seq.rs: line 59</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// healer/healer_core/src/mutation/seq.rs: line 59</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">remove_call</span>(ctx: &amp;<span class="keyword">mut</span> Context, _corpus: &amp;CorpusWrapper, rng: &amp;<span class="keyword">mut</span> RngType) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ctx.calls.<span class="title function_ invoke__">is_empty</span>() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">idx</span> = rng.<span class="title function_ invoke__">gen_range</span>(<span class="number">0</span>..ctx.calls.<span class="title function_ invoke__">len</span>());</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">calls</span> = std::mem::<span class="title function_ invoke__">take</span>(&amp;<span class="keyword">mut</span> ctx.calls);</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">p</span> = Prog::<span class="title function_ invoke__">new</span>(calls);</span><br><span class="line">    debug_info!(<span class="string">&quot;remove_call: removing call-&#123;&#125;&quot;</span>, idx);</span><br><span class="line">    p.<span class="title function_ invoke__">remove_call_inplace</span>(idx);</span><br><span class="line">    ctx.calls = p.calls;</span><br><span class="line">    <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="call-rs"><a href="#call-rs" class="headerlink" title="call.rs"></a>call.rs</h5><p>该代码实现在 <code>healer/healer_core/src/mutation/call.rs</code> 。</p>
<p>实现了变异操作： <code>mutate_call_args(line 25)</code> 。</p>
<p><strong>mutate_call_args</strong></p>
<p>该部分负责选择一个系统调用，然后随机变异其参数。</p>
<ol>
<li>首先如果系统调用序列为空，则直接变异失败(<code>line 4</code>)。</li>
<li>然后调用 <code>do_mutate_call_args</code> 尝试判断是否有可进行随机变异的参数(<code>line 8</code>)。</li>
<li>否则变异失败，所以的系统调用都没有可以变异的参数。(<code>line 10</code>)</li>
</ol>
<p>代码实现在: <code>healer/healer_core/src/mutation/call.rs: line 25</code> 。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// healer/healer_core/src/mutation/call.rs: line 25</span></span><br><span class="line"><span class="comment">/// Select a call and mutate its args randomly.</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">mutate_call_args</span>(ctx: &amp;<span class="keyword">mut</span> Context, _corpus: &amp;CorpusWrapper, rng: &amp;<span class="keyword">mut</span> RngType) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ctx.calls.<span class="title function_ invoke__">is_empty</span>() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(idx) = <span class="title function_ invoke__">select_call</span>(ctx, rng) &#123;</span><br><span class="line">        <span class="title function_ invoke__">do_mutate_call_args</span>(ctx, rng, idx)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        debug_info!(<span class="string">&quot;mutate_call_args: all calls do not have mutable parameters&quot;</span>);</span><br><span class="line">        <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>do_mutate_call_args</strong></p>
<p>该部分是真正对某个系统调用进行参数变异的函数实现。</p>
<ol>
<li>最多尝试变异 128 次，同时要么还没有变异成功，要么以一个设定的概率进行再变异(<code>line 8</code>)。</li>
<li>然后会随机去选择这个系统调用的随机一个参数，选择失败则变异失败(<code>line 14</code>)。</li>
<li>如果当前这个参数是 <code>const</code> 则没法变异，于是 continue 等下重新挑选一个(<code>line 19</code>)。</li>
<li>然后记录一些用于 backup 的东西，开始对选中的值调用 <code>mutate_value</code> 进行变异(<code>line 26</code>)。</li>
<li>如果变异完发现系统调用序列不为空才对上下文进行覆写(<code>line 29</code>)。</li>
</ol>
<p>代码实现在: <code>healer/healer_core/src/mutation/call.rs: line 38</code> 。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// healer/healer_core/src/mutation/call.rs: line 38</span></span><br><span class="line"><span class="comment">/// Mutate the `idx` call in `ctx` based on value prio.</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">do_mutate_call_args</span>(ctx: &amp;<span class="keyword">mut</span> Context, rng: &amp;<span class="keyword">mut</span> RngType, <span class="keyword">mut</span> idx: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">tries</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">mutated</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">visited</span> = HashSet::<span class="title function_ invoke__">new</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> tries &lt; <span class="number">128</span> &amp;&amp; (!mutated || rng.<span class="title function_ invoke__">gen_ratio</span>(<span class="number">1</span>, <span class="number">2</span>)) &#123;</span><br><span class="line">        <span class="comment">// restore</span></span><br><span class="line">        ctx.res_ids.<span class="title function_ invoke__">clear</span>();</span><br><span class="line">        ctx.res_kinds.<span class="title function_ invoke__">clear</span>();</span><br><span class="line">        ctx.mem_allocator.<span class="title function_ invoke__">restore</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">arg</span> = <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(arg) = <span class="title function_ invoke__">select_arg</span>(ctx, rng, idx) &#123;</span><br><span class="line">            arg</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> !visited.<span class="title function_ invoke__">insert</span>(arg <span class="keyword">as</span> *<span class="keyword">const</span> _) &amp;&amp; rng.<span class="title function_ invoke__">gen_ratio</span>(<span class="number">9</span>, <span class="number">10</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">restore_res_ctx</span>(ctx, idx);</span><br><span class="line">        <span class="title function_ invoke__">record_call_res</span>(&amp;ctx.calls[idx]);</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">calls_backup</span> = std::mem::<span class="title function_ invoke__">take</span>(&amp;<span class="keyword">mut</span> ctx.calls);</span><br><span class="line">        mutated = <span class="title function_ invoke__">mutate_value</span>(ctx, rng, arg);</span><br><span class="line">        <span class="title function_ invoke__">restore_call_res</span>(&amp;<span class="keyword">mut</span> calls_backup[idx]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> !ctx.calls.<span class="title function_ invoke__">is_empty</span>() &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">new_calls</span> = std::mem::<span class="title function_ invoke__">take</span>(&amp;<span class="keyword">mut</span> ctx.calls);</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">new_idx</span> = idx + new_calls.<span class="title function_ invoke__">len</span>();</span><br><span class="line">            calls_backup.<span class="title function_ invoke__">splice</span>(idx..idx, new_calls);</span><br><span class="line">            idx = new_idx;</span><br><span class="line">        &#125;</span><br><span class="line">        ctx.calls = calls_backup;</span><br><span class="line"></span><br><span class="line">        tries += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> mutated &#123;</span><br><span class="line">        <span class="title function_ invoke__">calculate_len</span>(ctx.target, &amp;<span class="keyword">mut</span> ctx.calls[idx]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mutated</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>mutate_value</strong></p>
<p>这个函数只是一个接口，负责根据传入的参数的类型选择对应的变异函数来执行。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// healer/healer_core/src/mutation/call.rs: line 171</span></span><br><span class="line"><span class="comment">/// Mutate the given value</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">mutate_value</span>(ctx: &amp;<span class="keyword">mut</span> Context, rng: &amp;<span class="keyword">mut</span> RngType, val: &amp;<span class="keyword">mut</span> Value) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ty</span> = val.<span class="title function_ invoke__">ty</span>(ctx.target);</span><br><span class="line">    TYPE_MUTATORS[ty.<span class="title function_ invoke__">kind</span>() <span class="keyword">as</span> <span class="type">usize</span>](ctx, rng, val)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而在这个文件的上前方则定义了一个函数数组用于被调用。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// healer/healer_core/src/mutation/call.rs: line 151</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">TypeMutator</span> = <span class="title function_ invoke__">fn</span>(&amp;<span class="keyword">mut</span> Context, &amp;<span class="keyword">mut</span> RngType, &amp;<span class="keyword">mut</span> Value) <span class="punctuation">-&gt;</span> <span class="type">bool</span>;</span><br><span class="line"><span class="keyword">const</span> TYPE_MUTATORS: [TypeMutator; <span class="number">15</span>] = [</span><br><span class="line">    mutate_res,</span><br><span class="line">    mutate_const,</span><br><span class="line">    mutate_int,</span><br><span class="line">    mutate_flags,</span><br><span class="line">    mutate_len,</span><br><span class="line">    mutate_proc,</span><br><span class="line">    mutate_csum,</span><br><span class="line">    mutate_vma,</span><br><span class="line">    mutate_buffer_blob,</span><br><span class="line">    mutate_buffer_string,</span><br><span class="line">    mutate_buffer_filename,</span><br><span class="line">    mutate_array,</span><br><span class="line">    mutate_ptr,</span><br><span class="line">    mutate_struct,</span><br><span class="line">    mutate_union,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>这些函数的实现都可以在同文件夹中找到(<code>healer/healer_core/src/mutation/</code>)，这里不再一一列举。</p>
<p>例如函数 <code>mutate_ptr</code> 实现位置为 <code>healer/healer_core/src/mutation/ptr.rs: line 13</code> 。</p>
<h4 id="ty"><a href="#ty" class="headerlink" title="ty"></a>ty</h4><p>代码实现位置为: <code>healer/healer_core/src/ty/</code> 。</p>
<p>该部分实现的是从 Syzlang 类型系统的 AST 相关的代码。</p>
<p>在 <code>healer/healer_core/src/ty/mod.rs</code> 开头有如下注释:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// healer/healer_core/src/ty/mod.rs: line 1</span></span><br><span class="line"><span class="comment">//! AST of Syzlang type system</span></span><br><span class="line"><span class="comment">//!</span></span><br><span class="line"><span class="comment">//! Each type in syzlang has an corresponding type, while the top level `Type` wraps all of them.</span></span><br><span class="line"><span class="comment">//! Every type is constructed via builder pattern.</span></span><br><span class="line"><span class="comment">//! Everything is immutable so that value and type are always consistent.</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>我估计是处理 Syzlang 的模板来获取各种参数类型等用于引导后续生成系统调用构建参数、返回值等。</p>
<h4 id="relation"><a href="#relation" class="headerlink" title="relation"></a>relation</h4><p>代码实现位置: <code>healer/healer_core/src/relation.rs</code> 。</p>
<p>该部分是本文计算系统调用之间是否存在影响关系的相关代码。</p>
<p>使用了一个结构体来维护每个系统调用能影响的系统调用和能被那些系统调用影响。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// healer/healer_core/src/relation.rs: line 50</span></span><br><span class="line"><span class="comment">/// Influence relations between syscalls.</span></span><br><span class="line"><span class="meta">#[derive(Debug, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Relation</span> &#123;</span><br><span class="line">    influence: HashMap&lt;SyscallId, <span class="type">Vec</span>&lt;SyscallId&gt;&gt;,</span><br><span class="line">    influence_by: HashMap&lt;SyscallId, <span class="type">Vec</span>&lt;SyscallId&gt;&gt;,</span><br><span class="line">    n: <span class="type">usize</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接口 <code>Relation</code> 提供了相关的方法，并且代码中含有丰富的注释，所以应该是非常容易看懂的。</p>
<p>构造函数会通过目标初始化相关的信息确定当前系统调用能够影响和被影响的系统调用。</p>
<p>初始时，Static Learning 将会根据 Syzlang 描述所提供的信息来初始化 Relation Table。其中，参数类型和返回值类型对静态分析至关重要。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// healer/healer_core/src/relation.rs: line 58</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Create initial relations based on syscall type information.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(target: &amp;Target) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">influence</span>: HashMap&lt;SyscallId, <span class="type">Vec</span>&lt;SyscallId&gt;&gt; = target</span><br><span class="line">            .<span class="title function_ invoke__">enabled_syscalls</span>()</span><br><span class="line">            .<span class="title function_ invoke__">iter</span>()</span><br><span class="line">            .<span class="title function_ invoke__">map</span>(|syscall| (syscall.<span class="title function_ invoke__">id</span>(), <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>()))</span><br><span class="line">            .<span class="title function_ invoke__">collect</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">influence_by</span> = influence.<span class="title function_ invoke__">clone</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">r</span> = Relation &#123;</span><br><span class="line">            influence,</span><br><span class="line">            influence_by,</span><br><span class="line">            n: <span class="number">0</span>,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> target.<span class="title function_ invoke__">enabled_syscalls</span>().<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">map</span>(|s| s.<span class="title function_ invoke__">id</span>()) &#123;</span><br><span class="line">            <span class="keyword">for</span> <span class="variable">j</span> <span class="keyword">in</span> target.<span class="title function_ invoke__">enabled_syscalls</span>().<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">map</span>(|s| s.<span class="title function_ invoke__">id</span>()) &#123;</span><br><span class="line">                <span class="keyword">if</span> i != j &amp;&amp; <span class="keyword">Self</span>::<span class="title function_ invoke__">calculate_influence</span>(target, i, j) &#123;</span><br><span class="line">                    r.<span class="title function_ invoke__">push_ordered</span>(i, j);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        r</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>calculate_influence</strong></p>
<p>该函数用于计算两个系统调用是否有影响关系，实现位置在 <code>healer/healer_core/src/relation.rs: line 93</code> 。</p>
<p>动态学习可以使用 syzlang 无法表达的信息来更好的更新和细化关系表，以便于生成更高质量的测试用例。</p>
<p>如何判断影响关系已经写在注释中了。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// healer/healer_core/src/relation.rs: line 93</span></span><br><span class="line">    <span class="comment">/// Calculate if syscall `a` can influence the execution of syscall `b` based on</span></span><br><span class="line">    <span class="comment">/// input/output resources.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// Syscall `a` can influcen syscall `b` when any resource output by `a` is subtype</span></span><br><span class="line">    <span class="comment">/// of resources input by `b`. For example, syscall `a` outputs resource `sock`, syscall</span></span><br><span class="line">    <span class="comment">/// `b` takes resource `fd` as input, then `a` can influence `b`, because `sock` is</span></span><br><span class="line">    <span class="comment">/// subtype of `fd`. In contrast, if `b` takes `sock_ax25` as input, then the above</span></span><br><span class="line">    <span class="comment">/// conlusion maybe wrong (return false), because `sock` is not subtype of `sock_ax25` and</span></span><br><span class="line">    <span class="comment">/// the output resource of `a` maybe useless for `b`. For the latter case, the relation</span></span><br><span class="line">    <span class="comment">/// should be judged with dynamic method.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">calculate_influence</span>(target: &amp;Target, a: SyscallId, b: SyscallId) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">output_res_a</span> = target.<span class="title function_ invoke__">syscall_output_res</span>(a);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">input_res_b</span> = target.<span class="title function_ invoke__">syscall_input_res</span>(b);</span><br><span class="line"></span><br><span class="line">        !output_res_a.<span class="title function_ invoke__">is_empty</span>()</span><br><span class="line">            &amp;&amp; !input_res_b.<span class="title function_ invoke__">is_empty</span>()</span><br><span class="line">            &amp;&amp; input_res_b.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">any</span>(|input_res| &#123;</span><br><span class="line">                output_res_a</span><br><span class="line">                    .<span class="title function_ invoke__">iter</span>()</span><br><span class="line">                    .<span class="title function_ invoke__">any</span>(|output_res| target.<span class="title function_ invoke__">res_sub_tys</span>(input_res).<span class="title function_ invoke__">contains</span>(output_res))</span><br><span class="line">            &#125;)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><strong>try_update</strong></p>
<p>现在尝试通过移除来确定两个系统调用之间的关系，实现位置在 <code>healer/healer_core/src/relation.rs: line 115</code> 。</p>
<p>如何尝试移除已经写在注释中了。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// healer/healer_core/src/relation.rs: line 115</span></span><br><span class="line">    <span class="comment">/// Detect relations by removing calls dynamically.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// The algorithm removes call before call `idx `of `p` and calls the callback</span></span><br><span class="line">    <span class="comment">/// `changed` to verify if the removal changed the feedback of adjacent call.</span></span><br><span class="line">    <span class="comment">/// For example, for prog [open, read], the algorithm removes `open` first and calls `changed`</span></span><br><span class="line">    <span class="comment">/// with the index of `open` (0 in this case) and the `new_prog`. The index of `open` equals to</span></span><br><span class="line">    <span class="comment">/// the index of `read` in the new `prog` and the callback `changed` should judge the feedback</span></span><br><span class="line">    <span class="comment">/// changes of the `index` call after the execution of `new_prog`. Finally, `try_update` returns</span></span><br><span class="line">    <span class="comment">/// the number of detected new relations.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">try_update</span>&lt;T&gt;(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, p: &amp;Prog, idx: <span class="type">usize</span>, <span class="keyword">mut</span> pred: T) <span class="punctuation">-&gt;</span> <span class="type">bool</span></span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        T: <span class="title function_ invoke__">FnMut</span>(&amp;Prog, <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">bool</span>, <span class="comment">// fn(new_prog: &amp;Prog, index: usize) -&gt; bool</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">found_new</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> idx == <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> found_new;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">a</span> = &amp;p.calls[idx - <span class="number">1</span>];</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">b</span> = &amp;p.calls[idx];</span><br><span class="line">        <span class="keyword">if</span> !<span class="keyword">self</span>.<span class="title function_ invoke__">influence</span>(a.<span class="title function_ invoke__">sid</span>(), b.<span class="title function_ invoke__">sid</span>()) &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">new_p</span> = p.<span class="title function_ invoke__">remove_call</span>(idx - <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> <span class="title function_ invoke__">pred</span>(&amp;new_p, idx - <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">self</span>.<span class="title function_ invoke__">push_ordered</span>(a.<span class="title function_ invoke__">sid</span>(), b.<span class="title function_ invoke__">sid</span>());</span><br><span class="line">                found_new = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        found_new</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="fuzz-流程代码"><a href="#fuzz-流程代码" class="headerlink" title="fuzz 流程代码"></a>fuzz 流程代码</h3><p>在 <code>healer/healer_fuzzer</code> 中实现了 <code>healer</code> 其 fuzzer 的部分。</p>
<h4 id="main"><a href="#main" class="headerlink" title="main"></a>main</h4><p>fuzzer 的主入口文件是 <code>healer/headeler_fuzzer/src/main.rs</code> 在这个主程序中实现了 <code>main()</code> 函数，该文件主要负责从终端中获取与 fuzz 过程相关的参数，一些可选的参数则通过使用默认值来填充。在所有参数填充到 <code>config</code> 中之后，在 <code>line 129</code> 处通过调用函数 <code>boot(config)</code> 启动了 fuzz 。（<code>boot</code> 的实现位置为: <code>healer/healer_fuzzer/src/lib.rs: line 57</code> 。</p>
<h4 id="boot"><a href="#boot" class="headerlink" title="boot"></a>boot</h4><p>进入该函数后会对传入的 <code>config</code> 进行合法性检测，检测通过后，则会打印 “HEALER” 的 banner。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// healer/healer_fuzzer/src/lib.rs: line 57</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">boot</span>(<span class="keyword">mut</span> config: Config) <span class="punctuation">-&gt;</span> anyhow::<span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    config.<span class="title function_ invoke__">check</span>().<span class="title function_ invoke__">context</span>(<span class="string">&quot;config error&quot;</span>)?;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, HEALER);</span><br><span class="line">    <span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<h2 id="0x04-参考链接"><a href="#0x04-参考链接" class="headerlink" title="0x04 参考链接"></a>0x04 参考链接</h2><p><a target="_blank" rel="noopener" href="https://github.com/SunHao-0/healer">Healer</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/jack240541595/article/details/90203299">【Linux学习笔记】debootstrap的使用技巧</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Ron</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://lucxer.tech/2023/01/25/33.HEALER/">https://lucxer.tech/2023/01/25/33.HEALER/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://lucxer.tech" target="_blank">Ron's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Fuzz/">Fuzz</a><a class="post-meta__tags" href="/tags/Healer/">Healer</a><a class="post-meta__tags" href="/tags/Syzkaller/">Syzkaller</a></div><div class="post_share"><div class="addthis_inline_share_toolbox"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=5fb3e45d5f9ff11c" async="async"></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.png" target="_blank"><img class="post-qr-code-img" data-lazy-src="/img/wechat.png" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" data-lazy-src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/02/13/34.Syzkaller/"><img class="prev-cover" data-lazy-src="https://github.com/google/syzkaller/raw/f325deb023e4e2fb9197004be1b3da738680429c/docs/process_structure.png?raw=true" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Syzkaller部分功能点源码分析</div></div></a></div><div class="next-post pull-right"><a href="/2022/12/23/32.LLVM%E5%8F%8Aclang%E5%85%A5%E9%97%A8/"><img class="next-cover" data-lazy-src="https://cdn.jsdelivr.net/gh/qriosa/picgo-blog/img/llvm_logo.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">LLVM及clang入门</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/02/13/34.Syzkaller/" title="Syzkaller部分功能点源码分析"><img class="cover" data-lazy-src="https://github.com/google/syzkaller/raw/f325deb023e4e2fb9197004be1b3da738680429c/docs/process_structure.png?raw=true" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-13</div><div class="title">Syzkaller部分功能点源码分析</div></div></a></div><div><a href="/2023/04/10/35.kcov与分析/" title="Syzkaller 中用到 kcov 记录覆盖分析"><img class="cover" data-lazy-src="https://cdn.jsdelivr.net/gh/qriosa/picgo-blog/img/kcov-mhtf.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-10</div><div class="title">Syzkaller 中用到 kcov 记录覆盖分析</div></div></a></div><div><a href="/2022/12/23/32.LLVM及clang入门/" title="LLVM及clang入门"><img class="cover" data-lazy-src="https://cdn.jsdelivr.net/gh/qriosa/picgo-blog/img/llvm_logo.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-23</div><div class="title">LLVM及clang入门</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" data-lazy-src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Ron</div><div class="author-info__description">(retired) OI/Crypto, Fuzzing</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">39</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">68</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/qriosa"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/qriosa" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:chegnxiang@163.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">号外！号外！评论系统已开放！</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00-%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2"><span class="toc-number">1.</span> <span class="toc-text">0x00 写在前面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-%E6%96%B9%E6%B3%95%E5%8E%9F%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">0x01 方法原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">2.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">2.2.</span> <span class="toc-text">工作流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E7%B3%BB%E5%AD%A6%E4%B9%A0%E6%A8%A1%E5%9D%97"><span class="toc-number">2.3.</span> <span class="toc-text">关系学习模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E5%AD%A6%E4%B9%A0"><span class="toc-number">2.3.1.</span> <span class="toc-text">静态学习</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E5%AD%A6%E4%B9%A0"><span class="toc-number">2.3.2.</span> <span class="toc-text">动态学习</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%98%E5%BC%82%E8%A7%84%E5%88%99"><span class="toc-number">2.4.</span> <span class="toc-text">变异规则</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">3.</span> <span class="toc-text">0x02 环境配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96%E5%BA%93%E5%AE%89%E8%A3%85"><span class="toc-number">3.1.</span> <span class="toc-text">依赖库安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Prerequisites"><span class="toc-number">3.1.1.</span> <span class="toc-text">Prerequisites</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Kernel"><span class="toc-number">3.1.2.</span> <span class="toc-text">Kernel</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Linux-%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E4%B8%8B%E8%BD%BD"><span class="toc-number">3.1.2.1.</span> <span class="toc-text">Linux 内核源码下载</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">3.1.2.2.</span> <span class="toc-text">生成默认配置文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%93%E5%BC%80%E9%9C%80%E8%A6%81%E7%9A%84%E9%85%8D%E7%BD%AE%E9%80%89%E9%A1%B9"><span class="toc-number">3.1.2.3.</span> <span class="toc-text">打开需要的配置选项</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E5%86%85%E6%A0%B8"><span class="toc-number">3.1.2.4.</span> <span class="toc-text">构建内核</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Image"><span class="toc-number">3.1.3.</span> <span class="toc-text">Image</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-debootstrap"><span class="toc-number">3.1.3.1.</span> <span class="toc-text">安装 debootstrap</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-Debian-Stretch-Linux-image"><span class="toc-number">3.1.3.2.</span> <span class="toc-text">创建 Debian Stretch Linux image</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#QEMU"><span class="toc-number">3.2.</span> <span class="toc-text">QEMU</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-QEMU"><span class="toc-number">3.2.1.</span> <span class="toc-text">安装 QEMU</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E6%B5%8B%E8%AF%95"><span class="toc-number">3.2.2.</span> <span class="toc-text">验证测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E5%88%B0%E4%B8%80%E4%B8%AA-QEMU-%E5%AE%9E%E4%BE%8B%E4%B8%AD"><span class="toc-number">3.2.3.</span> <span class="toc-text">连接到一个 QEMU 实例中</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Healer"><span class="toc-number">3.3.</span> <span class="toc-text">Healer</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Rust-%E5%AE%89%E8%A3%85"><span class="toc-number">3.3.1.</span> <span class="toc-text">Rust 安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E8%AF%91-Healer"><span class="toc-number">3.3.2.</span> <span class="toc-text">编译 Healer</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%A7%8B-Fuzz-Linux-Kernel"><span class="toc-number">3.4.</span> <span class="toc-text">开始 Fuzz Linux Kernel</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E7%9B%AE%E5%BD%95%E5%87%86%E5%A4%87"><span class="toc-number">3.4.1.</span> <span class="toc-text">工作目录准备</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%A7%8B-fuzz"><span class="toc-number">3.4.2.</span> <span class="toc-text">开始 fuzz</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fuzzing"><span class="toc-number">3.4.3.</span> <span class="toc-text">fuzzing</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#corpus"><span class="toc-number">3.4.4.</span> <span class="toc-text">corpus</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81"><span class="toc-number">4.</span> <span class="toc-text">0x03 核心代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E6%80%A7%E4%BB%A3%E7%A0%81"><span class="toc-number">4.1.</span> <span class="toc-text">功能性代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#minimize"><span class="toc-number">4.1.1.</span> <span class="toc-text">minimize</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#generate"><span class="toc-number">4.1.2.</span> <span class="toc-text">generate</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#mod-rs"><span class="toc-number">4.1.2.1.</span> <span class="toc-text">mod.rs</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mutation"><span class="toc-number">4.1.3.</span> <span class="toc-text">mutation</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#mod-rs-1"><span class="toc-number">4.1.3.1.</span> <span class="toc-text">mod.rs</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#seq-rs"><span class="toc-number">4.1.3.2.</span> <span class="toc-text">seq.rs</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#call-rs"><span class="toc-number">4.1.3.3.</span> <span class="toc-text">call.rs</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ty"><span class="toc-number">4.1.4.</span> <span class="toc-text">ty</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#relation"><span class="toc-number">4.1.5.</span> <span class="toc-text">relation</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fuzz-%E6%B5%81%E7%A8%8B%E4%BB%A3%E7%A0%81"><span class="toc-number">4.2.</span> <span class="toc-text">fuzz 流程代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#main"><span class="toc-number">4.2.1.</span> <span class="toc-text">main</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#boot"><span class="toc-number">4.2.2.</span> <span class="toc-text">boot</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">5.</span> <span class="toc-text">0x04 参考链接</span></a></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/11/19/39.CVE-2024-2961%20%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%BF%87%E7%A8%8B/" title="CVE-2024-2961 调试复现分析"><img data-lazy-src="https://cdn.jsdelivr.net/gh/qriosa/picgo-blog/img/CVE-2024-2961-heap-page.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CVE-2024-2961 调试复现分析"/></a><div class="content"><a class="title" href="/2024/11/19/39.CVE-2024-2961%20%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%BF%87%E7%A8%8B/" title="CVE-2024-2961 调试复现分析">CVE-2024-2961 调试复现分析</a><time datetime="2024-11-19T13:12:11.000Z" title="发表于 2024-11-19 21:12:11">2024-11-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/10/18/38.CVE-2018-1160%20%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/" title="CVE-2018-1160 调试复现分析"><img data-lazy-src="https://cdn.jsdelivr.net/gh/qriosa/picgo-blog/img/CVE-2018-1160-control_flow_hijack_chart.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CVE-2018-1160 调试复现分析"/></a><div class="content"><a class="title" href="/2023/10/18/38.CVE-2018-1160%20%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/" title="CVE-2018-1160 调试复现分析">CVE-2018-1160 调试复现分析</a><time datetime="2023-10-18T12:42:19.000Z" title="发表于 2023-10-18 20:42:19">2023-10-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/09/21/37.CVE-2021-30145%20%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/" title="CVE-2021-30145 调试复现分析"><img data-lazy-src="https://cdn.jsdelivr.net/gh/qriosa/picgo-blog/img/CVE-2021-30145-process.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CVE-2021-30145 调试复现分析"/></a><div class="content"><a class="title" href="/2023/09/21/37.CVE-2021-30145%20%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/" title="CVE-2021-30145 调试复现分析">CVE-2021-30145 调试复现分析</a><time datetime="2023-09-21T04:11:11.000Z" title="发表于 2023-09-21 12:11:11">2023-09-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/08/12/36.CVE-2018-6789%20%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/" title="CVE-2018-6789 调试复现分析"><img data-lazy-src="https://cdn.jsdelivr.net/gh/qriosa/picgo-blog/img/CVE-2018-6789-process.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CVE-2018-6789 调试复现分析"/></a><div class="content"><a class="title" href="/2023/08/12/36.CVE-2018-6789%20%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/" title="CVE-2018-6789 调试复现分析">CVE-2018-6789 调试复现分析</a><time datetime="2023-08-12T13:12:41.000Z" title="发表于 2023-08-12 21:12:41">2023-08-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/04/10/35.kcov%E4%B8%8E%E5%88%86%E6%9E%90/" title="Syzkaller 中用到 kcov 记录覆盖分析"><img data-lazy-src="https://cdn.jsdelivr.net/gh/qriosa/picgo-blog/img/kcov-mhtf.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Syzkaller 中用到 kcov 记录覆盖分析"/></a><div class="content"><a class="title" href="/2023/04/10/35.kcov%E4%B8%8E%E5%88%86%E6%9E%90/" title="Syzkaller 中用到 kcov 记录覆盖分析">Syzkaller 中用到 kcov 记录覆盖分析</a><time datetime="2023-04-10T14:12:12.000Z" title="发表于 2023-04-10 22:12:12">2023-04-10</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Ron</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to <a href="https://lucxer.tech">Ron's home</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="algolia-search"><div class="search-dialog"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.spacingElementById('content-inner')
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.spacingElementById('content-inner')
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/algolia.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> {preloader.endLoading()})</script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    loader: {
      source: {
        '[tex]/amsCd': '[tex]/amscd'
      }
    },
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        addClass: [200,() => {
          document.querySelectorAll('mjx-container:not([display=\'true\']').forEach( node => {
            const target = node.parentNode
            if (!target.classList.contains('has-jax')) {
              target.classList.add('mathjax-overflow')
            }
          })
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>function loadValine () {
  function initValine () {
    let initData = {
      el: '#vcomment',
      appId: 'kvdp8zac8n33pNjoPPrELp1b-MdYXbMMI',
      appKey: 't7PV1NwrBX5XxIJWIt4SBNak',
      placeholder: 'Please leave your footprints',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'en',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
    }

    if (true) { 
      initData.requiredFields= ('nick'.split(','))
    }
    
    if (false) {
      const otherData = false
      initData = Object.assign({}, initData, otherData)
    }
    
    const valine = new Valine(initData)
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.querySelector('#vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  '#config_change',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '.js-pjax'
]

if (false) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  if (typeof gtag === 'function') {
    gtag('config', '', {'page_path': window.location.pathname});
  }

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // Analytics
  if (false) {
    MtaH5.pgv()
  }

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})


document.addEventListener('pjax:send', function () {
  typeof preloader === 'object' && preloader.initLoading()
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})</script><script>(function(){
  const bp = document.createElement('script');
  const curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https') {
    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  bp.dataset.pjax = ''
  const s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})()</script></div></body></html>