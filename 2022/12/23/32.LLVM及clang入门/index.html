<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>LLVM及clang入门 | Ron's Blog</title><meta name="keywords" content="Fuzz,静态分析,程序分析,LLVM"><meta name="author" content="Ron"><meta name="copyright" content="Ron"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="LLVM项目及clang相关学习">
<meta property="og:type" content="article">
<meta property="og:title" content="LLVM及clang入门">
<meta property="og:url" content="http://lucxer.tech/2022/12/23/32.LLVM%E5%8F%8Aclang%E5%85%A5%E9%97%A8/index.html">
<meta property="og:site_name" content="Ron&#39;s Blog">
<meta property="og:description" content="LLVM项目及clang相关学习">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/qriosa/picgo-blog/img/llvm_logo.png">
<meta property="article:published_time" content="2022-12-23T13:12:49.000Z">
<meta property="article:modified_time" content="2024-07-10T11:32:27.394Z">
<meta property="article:author" content="Ron">
<meta property="article:tag" content="Fuzz">
<meta property="article:tag" content="静态分析">
<meta property="article:tag" content="程序分析">
<meta property="article:tag" content="LLVM">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/qriosa/picgo-blog/img/llvm_logo.png"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="http://lucxer.tech/2022/12/23/32.LLVM%E5%8F%8Aclang%E5%85%A5%E9%97%A8/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="preconnect" href="//zz.bdstatic.com"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.js" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"KUPKZYGXJZ","apiKey":"c694052eee4849f0ddc6a25bc8e40d6c","indexName":"blog","hits":{"per_page":6},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isanchor: true
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}

// https://stackoverflow.com/questions/16839698/jquery-getscript-alternative-in-native-javascript
const getScript = url => new Promise((resolve, reject) => {
  const script = document.createElement('script')
  script.src = url
  script.async = true
  script.onerror = reject
  script.onload = script.onreadystatechange = function() {
    const loadState = this.readyState
    if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
    script.onload = script.onreadystatechange = null
    resolve()
  }
  document.head.appendChild(script)
})</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2024-07-10 19:32:27'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = '1'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}const fontSizeVal = saveToLocal.get('global-font-size')
if (fontSizeVal !== undefined) {
  document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
}})()</script><meta name="generator" content="Hexo 5.4.2"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" data-lazy-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">39</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">68</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://cdn.jsdelivr.net/gh/qriosa/picgo-blog/img/llvm_logo.png)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Ron's Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">LLVM及clang入门</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-12-23T13:12:49.000Z" title="发表于 2022-12-23 21:12:49">2022-12-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-07-10T11:32:27.394Z" title="更新于 2024-07-10 19:32:27">2024-07-10</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%A8%A1%E7%B3%8A%E6%B5%8B%E8%AF%95/">模糊测试</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">10.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>44分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="0x01-写在前面"><a href="#0x01-写在前面" class="headerlink" title="0x01 写在前面"></a>0x01 写在前面</h1><p><code>LLVM</code> <del>在我的理解上</del>是一种编译框架的作用，一种可以取代 <code>GCC</code> 框架的编译工具。设计出来的初衷，我不得而知，但是相比于 <code>GCC</code> 他拥有较多的好处。最直接一点是，他通过将不同的前端将高级语言转化成统一的 <code>LLVM</code> 中间语言（<code>IR</code>），然后可以使用统一的优化代码 （<code>Pass</code>） 来对进行代码优化，而程序分析着也可以在这个阶段对目标程序进行源代码静态分析，然后 <code>LLVM</code> 再将 <code>IR</code> 通过不同的后端编译成对应目标平台的可执行程序，因此具有很不错的跨平台性和跨语言性。</p>
<p><code>clang</code> 是 <code>LLVM</code> 针对 <code>C</code> 语言及其家族语言的前端。它的主要目标是提供一个 <code>GNU</code> 编译器套装（<code>GCC</code>）的替代品，支持 <code>GNU</code> 编译器大多数编译设置以及非官方语言拓展，项目包括 <code>Clang</code> 前端和 <code>Clang</code> 静态分析器。</p>
<p>以下所有的配置和分析均在 <code>LLVM-13.0</code> 的基础上进行的，不同版本略微语法有所不同。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/qriosa/picgo-blog/img/LLVM_compile.png" alt="LLVM编译过程"></p>
<h1 id="0x02-clang"><a href="#0x02-clang" class="headerlink" title="0x02 clang"></a>0x02 clang</h1><h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><p>根据官方指导的教程即可，可以直接安装，也可以从源码编译。</p>
<h2 id="编译程序"><a href="#编译程序" class="headerlink" title="编译程序"></a>编译程序</h2><p>首先简单创建一个目标程序:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hello world!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="直接编译"><a href="#直接编译" class="headerlink" title="直接编译"></a>直接编译</h3><p>可以直接用类似于 <code>gcc</code> 的模式来进行编译:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang helloworld.c -o hello </span><br></pre></td></tr></table></figure>
<h3 id="分步编译"><a href="#分步编译" class="headerlink" title="分步编译"></a>分步编译</h3><h4 id="生成预处理文件"><a href="#生成预处理文件" class="headerlink" title="生成预处理文件"></a>生成预处理文件</h4><p>处理 <code>define</code> , <code>include</code> 等。</p>
<p>使用下面的命令会生成预处理文件 <code>helloworld.i</code> :</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -E helloworld.c -o helloworld.i</span><br></pre></td></tr></table></figure>
<h4 id="生成汇编文件"><a href="#生成汇编文件" class="headerlink" title="生成汇编文件"></a>生成汇编文件</h4><p>先转化为中间代码 <code>IR</code> 这个过程中会有优化，然后再生成汇编代码。</p>
<p>使用下面的命令会生成汇编文件 <code>helloworld.s</code> :</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -S helloworld.i</span><br></pre></td></tr></table></figure>
<h4 id="生成目标文件"><a href="#生成目标文件" class="headerlink" title="生成目标文件"></a>生成目标文件</h4><p>使用下面的命令会生成目标文件 <code>helloworld.o</code> :</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -c helloworld.s</span><br></pre></td></tr></table></figure>
<h4 id="生成可执行文件"><a href="#生成可执行文件" class="headerlink" title="生成可执行文件"></a>生成可执行文件</h4><p>使用下面的命令会生成可执行文件 <code>helloworld</code> :</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -o helloworld helloworld.s</span><br></pre></td></tr></table></figure>
<h4 id="查看编译过程"><a href="#查看编译过程" class="headerlink" title="查看编译过程"></a>查看编译过程</h4><p>使用下面的命令可以看到编译过程中的各阶段:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">clang -ccc-print-phases helloworld.c</span><br><span class="line"></span><br><span class="line">            +- 0: input, <span class="string">&quot;helloworld.c&quot;</span>, c</span><br><span class="line">         +- 1: preprocessor, &#123;0&#125;, cpp-output</span><br><span class="line">      +- 2: compiler, &#123;1&#125;, ir</span><br><span class="line">   +- 3: backend, &#123;2&#125;, assembler</span><br><span class="line">+- 4: assembler, &#123;3&#125;, object</span><br><span class="line">5: linker, &#123;4&#125;, image</span><br></pre></td></tr></table></figure>
<h3 id="生成-IR-文件"><a href="#生成-IR-文件" class="headerlink" title="生成 IR 文件"></a>生成 IR 文件</h3><p>在 <code>clang</code> 中加入参数：</p>
<ul>
<li><code>-emit-llvm</code> 生成IR文件(ll)</li>
<li><code>-cc1</code> 只调用前端</li>
<li><code>-ast-dump</code> 输出 AST</li>
<li><code>-E</code> only run preprocessor</li>
<li><code>-S</code> only run preprocess and complication steps (.ll)</li>
<li><code>-c</code> only run preprocess, compile, and assemble steps (.bc) </li>
</ul>
<h3 id="opt指令"><a href="#opt指令" class="headerlink" title="opt指令"></a>opt指令</h3><p>看起来好像这个指令是一个优化指令，和三个参数有关，一个是需要处理的 <code>ll</code> 文件，一个是处理 <code>ll</code> 文件的 <code>pass</code> ，最后是输出 <code>pass</code> 优化处理后的 <code>ll</code> 文件。所以中间我们观测的值是通过 <code>stderr</code> 来进行输出的。</p>
<h2 id="进行分析"><a href="#进行分析" class="headerlink" title="进行分析"></a>进行分析</h2><p>分析之前我们都从简单的例子入手方便进行理解和分析，这时候前面的 <code>helloworld.c</code> 其实都太复杂了，因为 <code>include</code> 了头文件太多了，这里我们不追求能跑起来东西，所以简单的写个例子意思一下就好了:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="词法分析"><a href="#词法分析" class="headerlink" title="词法分析"></a>词法分析</h3><blockquote>
<p>词法分析（英語：lexical analysis）是<strong>计算机科学中将字符序列转换为记号（token）序列的过程</strong>。 进行词法分析的程序或者函数叫作词法分析器（lexical analyzer，简称lexer），也叫扫描器（scanner）。 词法分析器一般以函数的形式存在，供语法分析器调用。</p>
<p>词法分析阶段是编译过程的第一个阶段。这个阶段的任务是从左到右一个字符一个字符地读入源程序，即对构成源程序的字符流进行扫描然后根据构词规则识别单词(也称单词符号或符号)。词法分析程序实现这个任务。词法分析程序可以使用lex等工具自动生成。</p>
<p>词法分析要解决的问题是：如何将输入的字符序列转换成 token 序列,</p>
<p>Token = &lt;种别码, 属性值&gt;</p>
</blockquote>
<p>使用命令如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">clang -fmodules -E -Xclang -dump-tokens test.c</span><br><span class="line">int <span class="string">&#x27;int&#x27;</span>        [StartOfLine]  Loc=&lt;test.c:1:1&gt;</span><br><span class="line">identifier <span class="string">&#x27;add&#x27;</span>         [LeadingSpace] Loc=&lt;test.c:1:5&gt;</span><br><span class="line">l_paren <span class="string">&#x27;(&#x27;</span>             Loc=&lt;test.c:1:8&gt;</span><br><span class="line">int <span class="string">&#x27;int&#x27;</span>               Loc=&lt;test.c:1:9&gt;</span><br><span class="line">identifier <span class="string">&#x27;a&#x27;</span>   [LeadingSpace] Loc=&lt;test.c:1:13&gt;</span><br><span class="line">comma <span class="string">&#x27;,&#x27;</span>               Loc=&lt;test.c:1:14&gt;</span><br><span class="line">int <span class="string">&#x27;int&#x27;</span>        [LeadingSpace] Loc=&lt;test.c:1:16&gt;</span><br><span class="line">identifier <span class="string">&#x27;b&#x27;</span>   [LeadingSpace] Loc=&lt;test.c:1:20&gt;</span><br><span class="line">r_paren <span class="string">&#x27;)&#x27;</span>             Loc=&lt;test.c:1:21&gt;</span><br><span class="line">l_brace <span class="string">&#x27;&#123;&#x27;</span>             Loc=&lt;test.c:1:22&gt;</span><br><span class="line"><span class="built_in">return</span> <span class="string">&#x27;return&#x27;</span>  [StartOfLine] [LeadingSpace]   Loc=&lt;test.c:2:5&gt;</span><br><span class="line">identifier <span class="string">&#x27;a&#x27;</span>   [LeadingSpace] Loc=&lt;test.c:2:12&gt;</span><br><span class="line">plus <span class="string">&#x27;+&#x27;</span>         [LeadingSpace] Loc=&lt;test.c:2:14&gt;</span><br><span class="line">identifier <span class="string">&#x27;b&#x27;</span>   [LeadingSpace] Loc=&lt;test.c:2:16&gt;</span><br><span class="line">semi <span class="string">&#x27;;&#x27;</span>                Loc=&lt;test.c:2:17&gt;</span><br><span class="line">r_brace <span class="string">&#x27;&#125;&#x27;</span>      [StartOfLine]  Loc=&lt;test.c:3:1&gt;</span><br><span class="line">eof <span class="string">&#x27;&#x27;</span>          Loc=&lt;test.c:3:2&gt;</span><br></pre></td></tr></table></figure>
<h3 id="语法分析"><a href="#语法分析" class="headerlink" title="语法分析"></a>语法分析</h3><blockquote>
<p>语法分析是编译过程的一个逻辑阶段。语法分析的任务是在词法分析的基础上将单词序列组合成各类语法短语，如“程序”，“语句”，“表达式”等等.语法分析程序判断源程序在结构上是否正确.源程序的结构由上下文无关文法描述.</p>
</blockquote>
<p>使用命令如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">clang -fmodules -fsyntax-only -Xclang -ast-dump test.c</span><br><span class="line">TranslationUnitDecl 0x109b6b8 &lt;&lt;<span class="string">invalid sloc&gt;&gt; &lt;invalid</span> sloc&gt;</span><br><span class="line">|-TypedefDecl 0x109bf50 &lt;&lt;<span class="string">invalid sloc&gt;&gt; &lt;invalid</span> sloc&gt; implicit __int128_t <span class="string">&#x27;__int128&#x27;</span></span><br><span class="line">| `-BuiltinType 0x109bc50 <span class="string">&#x27;__int128&#x27;</span></span><br><span class="line">|-TypedefDecl 0x109bfc0 &lt;&lt;<span class="string">invalid sloc&gt;&gt; &lt;invalid</span> sloc&gt; implicit __uint128_t <span class="string">&#x27;unsigned __int128&#x27;</span></span><br><span class="line">| `-BuiltinType 0x109bc70 <span class="string">&#x27;unsigned __int128&#x27;</span></span><br><span class="line">|-TypedefDecl 0x109c2d8 &lt;&lt;<span class="string">invalid sloc&gt;&gt; &lt;invalid</span> sloc&gt; implicit __NSConstantString <span class="string">&#x27;struct __NSConstantString_tag&#x27;</span></span><br><span class="line">| `-RecordType 0x109c0b0 <span class="string">&#x27;struct __NSConstantString_tag&#x27;</span></span><br><span class="line">|   `-Record 0x109c018 <span class="string">&#x27;__NSConstantString_tag&#x27;</span></span><br><span class="line">|-TypedefDecl 0x109c370 &lt;&lt;<span class="string">invalid sloc&gt;&gt; &lt;invalid</span> sloc&gt; implicit __builtin_ms_va_list <span class="string">&#x27;char *&#x27;</span></span><br><span class="line">| `-PointerType 0x109c330 <span class="string">&#x27;char *&#x27;</span></span><br><span class="line">|   `-BuiltinType 0x109b750 <span class="string">&#x27;char&#x27;</span></span><br><span class="line">|-TypedefDecl 0x10df000 &lt;&lt;<span class="string">invalid sloc&gt;&gt; &lt;invalid</span> sloc&gt; implicit __builtin_va_list <span class="string">&#x27;struct __va_list_tag [1]&#x27;</span></span><br><span class="line">| `-ConstantArrayType 0x109c620 <span class="string">&#x27;struct __va_list_tag [1]&#x27;</span> 1 </span><br><span class="line">|   `-RecordType 0x109c460 <span class="string">&#x27;struct __va_list_tag&#x27;</span></span><br><span class="line">|     `-Record 0x109c3c8 <span class="string">&#x27;__va_list_tag&#x27;</span></span><br><span class="line">`-FunctionDecl 0x10df200 &lt;test.c:1:1, line:3:1&gt; line:1:5 add <span class="string">&#x27;int (int, int)&#x27;</span></span><br><span class="line">  |-ParmVarDecl 0x10df070 &lt;col:9, col:13&gt; col:13 used a <span class="string">&#x27;int&#x27;</span></span><br><span class="line">  |-ParmVarDecl 0x10df0f0 &lt;col:16, col:20&gt; col:20 used b <span class="string">&#x27;int&#x27;</span></span><br><span class="line">  `-CompoundStmt 0x10df3b0 &lt;col:22, line:3:1&gt;</span><br><span class="line">    `-ReturnStmt 0x10df3a0 &lt;line:2:5, col:16&gt;</span><br><span class="line">      `-BinaryOperator 0x10df380 &lt;col:12, col:16&gt; <span class="string">&#x27;int&#x27;</span> <span class="string">&#x27;+&#x27;</span></span><br><span class="line">        |-ImplicitCastExpr 0x10df350 &lt;col:12&gt; <span class="string">&#x27;int&#x27;</span> &lt;LValueToRValue&gt;</span><br><span class="line">        | `-DeclRefExpr 0x10df310 &lt;col:12&gt; <span class="string">&#x27;int&#x27;</span> lvalue ParmVar 0x10df070 <span class="string">&#x27;a&#x27;</span> <span class="string">&#x27;int&#x27;</span></span><br><span class="line">        `-ImplicitCastExpr 0x10df368 &lt;col:16&gt; <span class="string">&#x27;int&#x27;</span> &lt;LValueToRValue&gt;</span><br><span class="line">          `-DeclRefExpr 0x10df330 &lt;col:16&gt; <span class="string">&#x27;int&#x27;</span> lvalue ParmVar 0x10df0f0 <span class="string">&#x27;b&#x27;</span> <span class="string">&#x27;int&#x27;</span></span><br></pre></td></tr></table></figure>
<p>这个语法分析得到的图是有彩色的:</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/qriosa/picgo-blog/img/grammar_analysis.png" alt="语法分析图"></p>
<h3 id="语义分析"><a href="#语义分析" class="headerlink" title="语义分析"></a>语义分析</h3><blockquote>
<p>语义分析是编译过程的一个逻辑阶段， 语义分析的任务是对结构上正确的源程序进行上下文有关性质的审查，进行类型审查。语义分析是审查源程序有无语义错误，为代码生成阶段收集类型信息。比如语义分析的一个工作是进行类型审查，审查每个算符是否具有语言规范允许的运算对象，当不符合语言规范时，编译程序应报告错误。如有的编译程序要对实数用作数组下标的情况报告错误。又比如某些程序规定运算对象可被强制，那么当二目运算施于一整型和一实型对象时，编译程序应将整型转换为实型而不能认为是源程序的错误。</p>
</blockquote>
<p>这里主要是生成 <code>LLVM IR</code> ，主要有三种存在的形式，但是我们主要是看 <code>text</code> 的格式就好。</p>
<p>执行下面的命令，会将中间语言 <code>IR</code> 存在文件 <code>test.ll</code> 中。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -S -emit-llvm test.c</span><br></pre></td></tr></table></figure>
<p>文件内容如下：</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; ModuleID = &#x27;test.c&#x27;</span></span><br><span class="line">source_filename <span class="operator">=</span> <span class="string">&quot;test.c&quot;</span></span><br><span class="line"><span class="keyword">target</span> <span class="keyword">datalayout</span> <span class="operator">=</span> <span class="string">&quot;e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128&quot;</span></span><br><span class="line"><span class="keyword">target</span> <span class="keyword">triple</span> <span class="operator">=</span> <span class="string">&quot;x86_64-pc-linux-gnu&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Function Attrs: noinline nounwind optnone uwtable</span></span><br><span class="line"><span class="keyword">define</span> dso_local <span class="type">i32</span> <span class="title">@add</span>(<span class="type">i32</span> <span class="variable">%0</span><span class="punctuation">,</span> <span class="type">i32</span> <span class="variable">%1</span>) <span class="variable">#0</span> &#123;</span><br><span class="line">  <span class="variable">%3</span> <span class="operator">=</span> <span class="keyword">alloca</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">4</span></span><br><span class="line">  <span class="variable">%4</span> <span class="operator">=</span> <span class="keyword">alloca</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">4</span></span><br><span class="line">  <span class="keyword">store</span> <span class="type">i32</span> <span class="variable">%0</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%3</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">4</span></span><br><span class="line">  <span class="keyword">store</span> <span class="type">i32</span> <span class="variable">%1</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%4</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">4</span></span><br><span class="line">  <span class="variable">%5</span> <span class="operator">=</span> <span class="keyword">load</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%3</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">4</span></span><br><span class="line">  <span class="variable">%6</span> <span class="operator">=</span> <span class="keyword">load</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%4</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">4</span></span><br><span class="line">  <span class="variable">%7</span> <span class="operator">=</span> <span class="keyword">add</span> <span class="keyword">nsw</span> <span class="type">i32</span> <span class="variable">%5</span><span class="punctuation">,</span> <span class="variable">%6</span></span><br><span class="line">  <span class="keyword">ret</span> <span class="type">i32</span> <span class="variable">%7</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">attributes</span> <span class="variable">#0</span> <span class="operator">=</span> &#123; <span class="keyword">noinline</span> <span class="keyword">nounwind</span> <span class="keyword">optnone</span> <span class="keyword">uwtable</span> <span class="string">&quot;correctly-rounded-divide-sqrt-fp-math&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;disable-tail-calls&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;frame-pointer&quot;</span><span class="operator">=</span><span class="string">&quot;all&quot;</span> <span class="string">&quot;less-precise-fpmad&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;min-legal-vector-width&quot;</span><span class="operator">=</span><span class="string">&quot;0&quot;</span> <span class="string">&quot;no-infs-fp-math&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;no-jump-tables&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;no-nans-fp-math&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;no-signed-zeros-fp-math&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;no-trapping-math&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;stack-protector-buffer-size&quot;</span><span class="operator">=</span><span class="string">&quot;8&quot;</span> <span class="string">&quot;target-cpu&quot;</span><span class="operator">=</span><span class="string">&quot;x86-64&quot;</span> <span class="string">&quot;target-features&quot;</span><span class="operator">=</span><span class="string">&quot;+cx8,+fxsr,+mmx,+sse,+sse2,+x87&quot;</span> <span class="string">&quot;unsafe-fp-math&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;use-soft-float&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="title">!llvm.module.flags</span> <span class="operator">=</span> !&#123;<span class="title">!0</span>&#125;</span><br><span class="line"><span class="title">!llvm.ident</span> <span class="operator">=</span> !&#123;<span class="title">!1</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="title">!0</span> <span class="operator">=</span> !&#123;<span class="type">i32</span> <span class="number">1</span><span class="punctuation">,</span> !<span class="string">&quot;wchar_size&quot;</span><span class="punctuation">,</span> <span class="type">i32</span> <span class="number">4</span>&#125;</span><br><span class="line"><span class="title">!1</span> <span class="operator">=</span> !&#123;!<span class="string">&quot;clang version 10.0.0-4ubuntu1 &quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<p>上述默认是优化之后的形式，我们还可以打出没有优化过的形式:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang test.c -S -emit-llvm -o - -O3</span><br></pre></td></tr></table></figure>
<p>会得到下面的代码，发现确实是有些不同的：</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; ModuleID = &#x27;test.c&#x27;</span></span><br><span class="line">source_filename <span class="operator">=</span> <span class="string">&quot;test.c&quot;</span></span><br><span class="line"><span class="keyword">target</span> <span class="keyword">datalayout</span> <span class="operator">=</span> <span class="string">&quot;e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128&quot;</span></span><br><span class="line"><span class="keyword">target</span> <span class="keyword">triple</span> <span class="operator">=</span> <span class="string">&quot;x86_64-pc-linux-gnu&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Function Attrs: norecurse nounwind readnone uwtable</span></span><br><span class="line"><span class="keyword">define</span> dso_local <span class="type">i32</span> <span class="title">@add</span>(<span class="type">i32</span> <span class="variable">%0</span><span class="punctuation">,</span> <span class="type">i32</span> <span class="variable">%1</span>) local_unnamed_addr <span class="variable">#0</span> &#123;</span><br><span class="line">  <span class="variable">%3</span> <span class="operator">=</span> <span class="keyword">add</span> <span class="keyword">nsw</span> <span class="type">i32</span> <span class="variable">%1</span><span class="punctuation">,</span> <span class="variable">%0</span></span><br><span class="line">  <span class="keyword">ret</span> <span class="type">i32</span> <span class="variable">%3</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">attributes</span> <span class="variable">#0</span> <span class="operator">=</span> &#123; norecurse <span class="keyword">nounwind</span> <span class="keyword">readnone</span> <span class="keyword">uwtable</span> <span class="string">&quot;correctly-rounded-divide-sqrt-fp-math&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;disable-tail-calls&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;frame-pointer&quot;</span><span class="operator">=</span><span class="string">&quot;none&quot;</span> <span class="string">&quot;less-precise-fpmad&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;min-legal-vector-width&quot;</span><span class="operator">=</span><span class="string">&quot;0&quot;</span> <span class="string">&quot;no-infs-fp-math&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;no-jump-tables&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;no-nans-fp-math&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;no-signed-zeros-fp-math&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;no-trapping-math&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;stack-protector-buffer-size&quot;</span><span class="operator">=</span><span class="string">&quot;8&quot;</span> <span class="string">&quot;target-cpu&quot;</span><span class="operator">=</span><span class="string">&quot;x86-64&quot;</span> <span class="string">&quot;target-features&quot;</span><span class="operator">=</span><span class="string">&quot;+cx8,+fxsr,+mmx,+sse,+sse2,+x87&quot;</span> <span class="string">&quot;unsafe-fp-math&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;use-soft-float&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="title">!llvm.module.flags</span> <span class="operator">=</span> !&#123;<span class="title">!0</span>&#125;</span><br><span class="line"><span class="title">!llvm.ident</span> <span class="operator">=</span> !&#123;<span class="title">!1</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="title">!0</span> <span class="operator">=</span> !&#123;<span class="type">i32</span> <span class="number">1</span><span class="punctuation">,</span> !<span class="string">&quot;wchar_size&quot;</span><span class="punctuation">,</span> <span class="type">i32</span> <span class="number">4</span>&#125;</span><br><span class="line"><span class="title">!1</span> <span class="operator">=</span> !&#123;!<span class="string">&quot;clang version 10.0.0-4ubuntu1 &quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<h2 id="几种关系图"><a href="#几种关系图" class="headerlink" title="几种关系图"></a>几种关系图</h2><h3 id="CFG-控制流图-basic-blocks"><a href="#CFG-控制流图-basic-blocks" class="headerlink" title="CFG 控制流图 (basic blocks)"></a>CFG 控制流图 (basic blocks)</h3><h4 id="基本块-basic-blocks"><a href="#基本块-basic-blocks" class="headerlink" title="基本块 basic blocks"></a>基本块 basic blocks</h4><p>基本块是满足下面属性的最大的连续指令序列：</p>
<ul>
<li>控制流只能从基本块的第一行开始执行（不能有 <code>jump</code> 执行块中间的某行代码）</li>
<li>除非是基本块的最后一条指令，否则不允许包含离开基本块的分支或者挂机指令</li>
</ul>
<p>基本块的 <code>leader</code> :</p>
<ul>
<li>代码的第一行是基本块首领 (<code>leader</code>)</li>
<li>任何条件或者非条件跳转指令的目标行是基本块首领</li>
<li>任意条件或者非条件跳转指令的下一行是基本块首领</li>
</ul>
<p>基本块的界定方法:</p>
<ul>
<li>基本块的首领是基本块的一部分</li>
<li>基本块首领到下一个基本块的首领直接的代码，属于该基本块</li>
</ul>
<h4 id="画图"><a href="#画图" class="headerlink" title="画图"></a>画图</h4><p>控制流图我们代码就写到一个函数中来看调用情况：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cfg.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fact</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="type">int</span> ans = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (n &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        ans *= n;</span><br><span class="line">        n--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输入的命令如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -S -emit-llvm cfg.c -o - | opt -analyze -dot-cfg</span><br></pre></td></tr></table></figure>
<p>会对每个函数生成一个隐藏文件 <code>.function_name.dot</code> </p>
<p>然后我们再转化为对应的图像:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dot .fact.dot -Tpng -o cfg.fact.png</span><br></pre></td></tr></table></figure>
<p>对应的图如下（其实可以染色的，但我还不会）</p>
<blockquote>
<p>LLVM IR为我们提供的条件跳转指令是<code>br</code>，其接受三个参数，第一个参数是<code>i1</code>类型的值，用于作判断；第二和第三个参数分别是值为<code>true</code>和<code>false</code>时需要跳转到的标签。</p>
</blockquote>
<p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/qriosa/picgo-blog/img/cfg.fact.png" alt="CFG"></p>
<h3 id="CallGraph-函数调用图"><a href="#CallGraph-函数调用图" class="headerlink" title="CallGraph 函数调用图"></a>CallGraph 函数调用图</h3><blockquote>
<p>Clang对于函数调用的处理不够完整，对于特殊情况的函数调用处理不好，如:</p>
<ol>
<li>extern 函数调用，无法获知函数体，不会创建到 CallGraph 中</li>
<li>函数指针调用，无法获知函数体，不会创建到 CallGraph 中</li>
<li>模板函数调用，在编译期可以获知进行模板实例化，会添加到 CallGaph 中,且调用图上没有在别的c文件中定义的函数（.h中声明的），即没有正文的函数</li>
</ol>
</blockquote>
<p>为了比较好体现下面的函数调用图，代码不能太简单，至少逻辑上得出来这几种关系。</p>
<p>示例代码如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// callgraph.c</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">level</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret = rand() % <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">level2</span><span class="params">(<span class="type">int</span> input)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret = rand() % input;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> a = level();</span><br><span class="line">    <span class="type">int</span> b = level2(a);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输入命令如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -S -emit-llvm callgraph.c -o - | opt -analyze -dot-callgraph</span><br></pre></td></tr></table></figure>
<p>会将数据写到 <code>callgraph.dot</code> 中。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dot -Tpng -ocallgraph.png callgraph.dot</span><br></pre></td></tr></table></figure>
<p>会将得到的数据做成图片: <code>callgraph.png</code></p>
<p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/qriosa/picgo-blog/img/callgraph.png" alt="callgraph.png"></p>
<h3 id="AST图"><a href="#AST图" class="headerlink" title="AST图"></a>AST图</h3><p>略，暂时用不上，就没搞。</p>
<h1 id="0x03-LLVM-Pass"><a href="#0x03-LLVM-Pass" class="headerlink" title="0x03 LLVM Pass"></a>0x03 LLVM Pass</h1><h2 id="简单尝试"><a href="#简单尝试" class="headerlink" title="简单尝试"></a>简单尝试</h2><h3 id="先跑"><a href="#先跑" class="headerlink" title="先跑"></a>先跑</h3><p>这个地方尝试 <code>LLVM pass</code> 参考项目: <a target="_blank" rel="noopener" href="https://github.com/abenkhadra/llvm-pass-tutorial">https://github.com/abenkhadra/llvm-pass-tutorial</a></p>
<p>但是经过后面的探索，上述应该是来自 <a target="_blank" rel="noopener" href="https://github.com/sampsyo/llvm-pass-skeleton">这里</a> 。</p>
<p>我不想从源码编译，直接跳到了第二步，Building a trivial LLVM pass</p>
<p>在执行命令之前，需要先配置一下环境变量不然会报错。</p>
<p>下面设置的就是他 <code>cmake</code> 需要的环境变量 <code>$LLVN_HOME</code> 而 <code>/usr/local</code> 是 <code>LLVM</code> 的默认安装位置。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> LLVM_HOME=/usr/local</span><br></pre></td></tr></table></figure>
<p>然后再按教程跑就可以成功编译了（但是不知道没有去编译 <code>LLVM</code> 能不能行）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="comment"># pwd (build)</span></span><br><span class="line">$ cmake ..</span><br><span class="line">$ make</span><br></pre></td></tr></table></figure>
<p>然后我们简单创建一个测试的 c 文件，放置在项目根文件下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">f</span><span class="params">()</span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;hello world!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">	f();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在项目根目录运行下面的命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ clang -Xclang -load -Xclang build/skeleton/libSkeletonPass.* test.c -o <span class="built_in">test</span></span><br></pre></td></tr></table></figure>
<p>输出为:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">I saw a function called f!</span><br><span class="line">I saw a function called main!</span><br></pre></td></tr></table></figure>
<p>这个项目的作用就是观测测试程序中有哪些函数的。（前一个学习的知识告诉我们 <code>clang</code> 都能画出函数调用图了，所以显然是完全能知道各个函数的名字的呀。</p>
<h3 id="分析一下"><a href="#分析一下" class="headerlink" title="分析一下"></a>分析一下</h3><p>其实这个和 <a target="_blank" rel="noopener" href="https://llvm.org/docs/WritingAnLLVMPass.html#introduction-what-is-a-pass">官方教程</a> (<a target="_blank" rel="noopener" href="https://bsauce.github.io/2019/05/30/how-to-write-a-pass/">翻译版</a>) 差不多(简单分析了一下，代码应该是一模一样的意思)，但是感觉官方的解释不是很友好，我并不想从头编译，也不知道 LLVM 源代码目录在哪里，所以。。。</p>
<p>在 pass 中可以写两行代码来确定使用 pass 的方式: <code>clang</code> 和 <code>opt</code> 都行。</p>
<p>这个的过程也比较清晰: <a target="_blank" rel="noopener" href="http://www.helloted.com/ios/2020/06/28/clang/">http://www.helloted.com/ios/2020/06/28/clang/</a></p>
<p>这篇 <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/122522485">知乎</a> 给了一个如何从头学习的路线，具有一定的参考价值，但此时我已经踩完坑了。</p>
<h3 id="修改一下"><a href="#修改一下" class="headerlink" title="修改一下"></a>修改一下</h3><p>简单修改了一下 <code>CmakeList.txt</code> 不然每次重开都要设置环境变量，让他自己去找系统默认 <code>/usr/local</code> 的就好了</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.4</span>)</span><br><span class="line"><span class="keyword">project</span>(llvm-pass-tutorial)</span><br><span class="line"></span><br><span class="line"><span class="comment"># we need LLVM_HOME in order to automatically set LLVM_DIR</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">NOT</span> <span class="keyword">DEFINED</span> ENV&#123;LLVM_HOME&#125;)</span><br><span class="line">    <span class="keyword">message</span>(WARNING <span class="string">&quot;$LLVM_HOME is not defined, try to use &#x27;/usr/local/&#x27; [defaul]&quot;</span>)</span><br><span class="line">    <span class="keyword">set</span>(ENV&#123;LLVM_DIR&#125; /usr/local/lib/cmake/llvm)</span><br><span class="line"><span class="keyword">else</span> ()</span><br><span class="line">    <span class="keyword">set</span>(ENV&#123;LLVM_DIR&#125; $ENV&#123;LLVM_HOME&#125;/lib/cmake/llvm)</span><br><span class="line"><span class="keyword">endif</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">find_package</span>(LLVM REQUIRED CONFIG)</span><br><span class="line"><span class="keyword">add_definitions</span>(<span class="variable">$&#123;LLVM_DEFINITIONS&#125;</span>)</span><br><span class="line"><span class="keyword">include_directories</span>(<span class="variable">$&#123;LLVM_INCLUDE_DIRS&#125;</span>)</span><br><span class="line"><span class="keyword">link_directories</span>(<span class="variable">$&#123;LLVM_LIBRARY_DIRS&#125;</span>)</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$&#123;LLVM_VERSION_MAJOR&#125;</span> <span class="keyword">VERSION_GREATER_EQUAL</span> <span class="number">10</span>)</span><br><span class="line">    <span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">14</span>)</span><br><span class="line"><span class="keyword">endif</span> ()</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_subdirectory</span>(skeleton)  <span class="comment"># Use your pass name here.</span></span><br><span class="line"><span class="keyword">message</span>(<span class="string">&quot;Success!&quot;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="学习-IR-amp-pass"><a href="#学习-IR-amp-pass" class="headerlink" title="学习 IR &amp; pass"></a>学习 IR &amp; pass</h2><p>GitHub 上也有别人关于 <a target="_blank" rel="noopener" href="https://github.com/Evian-Zhang/llvm-ir-tutorial">LLVM-IR</a> 的学习引导。</p>
<p>找到了某个大学(cornell.edu)介绍的 <a target="_blank" rel="noopener" href="https://www.cs.cornell.edu/~asampson/blog/llvm.html">实验流程</a>。还对应给了一个 GitHub 仓库 <a target="_blank" rel="noopener" href="https://github.com/sampsyo/llvm-pass-skeleton">llvm-pass-skeleton </a>实现了对应的 pass 。</p>
<p>分析 <code>Skeleton.cpp</code> </p>
<ul>
<li>That <code>errs()</code> thing is an LLVM-provided C++ output stream we can use to print to the console.</li>
<li>The function returns <code>false</code> to indicate that it didn’t modify <code>F</code>. Later, when we actually transform the program, we’ll need to return <code>true</code>.</li>
</ul>
<h3 id="LLVM-IR"><a href="#LLVM-IR" class="headerlink" title="LLVM IR"></a>LLVM IR</h3><p>LLVM 中各个组件部分的关系:</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://www.cs.cornell.edu/~asampson/media/llvm/llvm-containers.svg" alt="components of LLVM"></p>
<p><a target="_blank" rel="noopener" href="https://llvm.org/doxygen/classllvm_1_1Module.html">Module</a> 包括了 <a target="_blank" rel="noopener" href="https://llvm.org/doxygen/classllvm_1_1Function.html">Function</a>， <code>Function</code> 包括了 <a target="_blank" rel="noopener" href="https://llvm.org/doxygen/classllvm_1_1BasicBlock.html">BasicBlock</a>， <code>BasicBlock</code> 包括了 <a target="_blank" rel="noopener" href="https://www.llvm.org/doxygen/classllvm_1_1Instruction.html">Instruction</a> ，但是除了 <code>Module</code> 之外的所有东西都来自 <code>Value</code>。</p>
<ul>
<li><code>Module</code> 是一堆粗糙的源代码或者说 <code>translate unit</code> ，所有的东西都包括在其中。</li>
<li><code>Module</code> 包含 <code>Function</code> ：命名的可执行代码块。（包括 C++ 中的 <code>Function</code> 和 <code>Method</code>）</li>
<li>除了声明其名称和参数之外，<code>Function</code> 主要是 <code>BasicBlock</code> 的容器。 <code>BasicBlock</code> 是编译器熟悉的概念，但就我们的目的而言，它只是一段连续的指令。</li>
<li>指令是单个代码操作。 例如，指令可能是整数加法、浮点除法或内存存储。</li>
</ul>
<p>LLVM 中的大多数东西——包括 <code>Function</code> 、<code>BasicBlock</code> 和 <code>Instruction</code> ——都是从名为 <code>Value</code> 的杂食基类继承的 C++ 类。 <code>Value</code> 是可以在计算中使用的任何数据——例如，数字或某些代码的地址； 全局变量和常量。</p>
<h3 id="IR-中的部分符号"><a href="#IR-中的部分符号" class="headerlink" title="IR 中的部分符号"></a>IR 中的部分符号</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">%a -- 表示寄存器</span><br><span class="line">@a -- 表示全局变量/函数名字</span><br><span class="line">!0 -- 表示元变量 用于帮助后端进行优化啥的</span><br><span class="line">#0 -- 表示属性组 用于修饰函数、变量啥的可见域、是否优化等</span><br><span class="line">$a -- 应该是表示的函数的参数？</span><br></pre></td></tr></table></figure>
<h3 id="Instruction"><a href="#Instruction" class="headerlink" title="Instruction"></a>Instruction</h3><p>例如下面这个指令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%5 = add i32 %4, 2</span><br></pre></td></tr></table></figure>
<p>这个指令表示将寄存器 <code>%4</code> 中的值与数字 <code>2</code> 相加，然后将结果存储到寄存器 <code>%5</code> 中。</p>
<p>寄存器的数量可以有无限多</p>
<blockquote>
<p>同样的指令在编译器内部表示为 C++ 类 <code>Instruction</code> 的一个实例。 该对象有一个操作码(opcode)，表明它是一个加法、一个类型和一个操作数(operands)列表，这些操作数是指向其他 <code>Value</code> 对象的指针。</p>
<p>也就是说这个指令其实是一个C++类的实例，这个指令是一个操作码(add) 然后后面跟上一个类型 ( <code>i32</code> ) 然后会跟上一串操作数的列表 ( <code>%4</code> , <code>2</code>) 这些操作数列表具体是指向其他 <code>Value</code> 这个类的某个实例对象。</p>
<p>在我们的例子中，它指向一个代表数字 <code>2</code> 的常量对象和另一个对应于寄存器 <code>%4</code> 的指令。 （由于 LLVM IR 是静态单一赋值形式，寄存器和指令实际上是相同的。寄存器编号仅仅为了方便进行文本表示。）</p>
</blockquote>
<p>可以通过下面的命令查看自己编写的代码对应的 LLVM 的 IR 语言样儿（前面已经学过了</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ clang -emit-llvm -S -o - something.c</span><br></pre></td></tr></table></figure>
<h4 id="LoadInst"><a href="#LoadInst" class="headerlink" title="LoadInst"></a>LoadInst</h4><p>长相如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%6 = load i32*, i32** %4, align 4</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这个例子的意思是从 %4 这个地址读取一个 int32* 的数据，值存在寄存器 %6 里</p>
</blockquote>
<p>这是一个一元指令，即只有一个操作数。在 llvm 中获取其操作数时命令为:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// LoadInst *LI;</span><br><span class="line">Value *OP = LI-&gt;getOperand(0); // 等价于 LI-&gt;getPointerOperand()</span><br></pre></td></tr></table></figure>
<p>此时你可能会好奇，这个值不是读取了存到了寄存器 <code>%6</code> 中间了吗？应该怎么获取这个值存储的位置 <code>%6</code> 呢。其实这个存储的值的位置就是这个指令本身。至于怎么构建连接，请看下文 StoreInst 中的例子。</p>
<h4 id="StoreInst"><a href="#StoreInst" class="headerlink" title="StoreInst"></a>StoreInst</h4><p>长相如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">store i32 %0, i32* %6, align 4</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这个例子的意思是将 %0 里面的 int32 值存储在 %6 这个寄存器制定的地址中。</p>
</blockquote>
<p>这是一个二元指令，有两个操作数。在 llvm 中获取其操作数时命令为:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// StoreInst *SI;</span><br><span class="line">Value *OP0 = SI-&gt;getOperand(0); // 等价于 SI-&gt;getValueOperand()</span><br><span class="line">Value *OP1 = SI-&gt;getOperand(1); // 等价于 SI-&gt;getPointerOperand()</span><br></pre></td></tr></table></figure>
<p>这时我们发现对于其中的 <code>%0</code> 和 <code>%6</code> ，我们都可以获取到。</p>
<p>但是如果是上文中一个 <code>LoadInst</code> 指令读取了一个值到 <code>%6</code> 中，此时这个 <code>StoreInst</code> 的位置不是就会被其影响吗？那应该怎么定位它呢？方法很简单，即 <code>%6</code> 这个 <code>Value*</code> 就是这个 <code>LoadInst</code> 本身。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">// StoreInst *SI;</span><br><span class="line"></span><br><span class="line">Value *OP0 = SI-&gt;getOperand(0); // 等价于 SI-&gt;getValueOperand()</span><br><span class="line">Value *OP1 = SI-&gt;getOperand(1); // 等价于 SI-&gt;getPointerOperand()</span><br><span class="line"></span><br><span class="line">if(LoadInst *LI = dyn_cast&lt;LoadInst&gt;(OP0))&#123;</span><br><span class="line">	// 即此时这个 LI 所读取的数据就会在当前 StoreInst 准备存的值。</span><br><span class="line">	errs() &lt;&lt; &quot;This StoreInst &#x27;&quot;;</span><br><span class="line">	SI-&gt;print(errs());</span><br><span class="line">	errs() &lt;&lt; &quot;&#x27; is affected by this LoadInst &#x27;&quot;;</span><br><span class="line">	LI-&gt;print(errs());</span><br><span class="line">	errs() &lt;&lt; &quot;&#x27;!\n&quot;;</span><br><span class="line">&#125;</span><br><span class="line">if(LoadInst *LI = dyn_cast&lt;LoadInst&gt;(OP1))&#123;</span><br><span class="line">	// 即此时这个 LI 所读取的数据就会在当前 StoreInst 准备存往的地址。</span><br><span class="line">	errs() &lt;&lt; &quot;This StoreInst &#x27;&quot;;</span><br><span class="line">	SI-&gt;print(errs());</span><br><span class="line">	errs() &lt;&lt; &quot;&#x27; is affected by this LoadInst &#x27;&quot;;</span><br><span class="line">	LI-&gt;print(errs());</span><br><span class="line">	errs() &lt;&lt; &quot;&#x27;!\n&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="GEPI"><a href="#GEPI" class="headerlink" title="GEPI"></a>GEPI</h4><p>对这个指令的理解终于是透彻了。</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;result&gt; <span class="operator">=</span> <span class="keyword">getelementptr</span> <span class="keyword">inbounds</span> &lt;ty&gt;<span class="punctuation">,</span> &lt;ty&gt;* &lt;ptrval&gt;&#123;<span class="punctuation">,</span> [inrange] &lt;ty&gt; &lt;idx&gt;&#125;*</span><br></pre></td></tr></table></figure>
<p>一句话解释从操作数指针位置通过一系列偏移计算得到一个指向其中某个域的指针。<br>其中就第一个有效地址是想操作的地址，通常是结构体或数组的<strong>指针</strong>，他是指向一个结构体的。（但是我不好说是指向结构体类型还是实例，应该是一个实例。<br>第二个参数通常是 0，表示从起始地址计算多少的偏移，这个起始就是按照数组的理解，一个数组 <code>int a[10]</code>，其实 <code>&amp;a[0]</code> 和 <code>a</code> 本身是等价的，同时 <code>a[1]</code> 增加的偏移是 <code>sizeof(TYPE)</code> 。所以当第一个偏移参数是 <code>i</code> 时，它其实就是从传递的指针开始，计算数组偏移，<code>i</code> 个单位，一个单位是这个类型的结构所占据的空间。但是没有关系，下一个位置开始还是被理解成这样的结构体数据结构，只是实例数据位置变了，但还是这个结构体或者这个数组。后面的参数依次表示其中的第几项，是递归进去，层层的第几项。</p>
<p>所以要是分析结构体中某些域是否被访问，可以直接忽略第一个偏移的参数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">; %5 %8 %15 %23 %32 都是函数参数进来的</span><br><span class="line">; int ga[10];</span><br><span class="line">; struct structTy</span><br><span class="line">; &#123;</span><br><span class="line">;     int a;</span><br><span class="line">;     long long b;</span><br><span class="line">;     char c[10];</span><br><span class="line">;     int* ptr;</span><br><span class="line">; &#125;gs[10];</span><br><span class="line"></span><br><span class="line">; int x = ga[a];</span><br><span class="line">%6 = getelementptr inbounds [10 x i32], [10 x i32]* @ga, i64 0, i64 %5</span><br><span class="line">%7 = load i32, i32* %6, align 4 </span><br><span class="line">; 可以看到 对于数组类型 getelementptr 后，就是我们要获取的值的地址，即数组名+偏移是一个地址</span><br><span class="line"></span><br><span class="line">; int x = gs[a].a;</span><br><span class="line">%9 = getelementptr inbounds [10 x %struct.structTy], [10 x %struct.structTy]* @gs, i64 0, i64 %8</span><br><span class="line">; 此时也是一个数组 getelementptr 后是一个地址, 存的值是一个 结构体类型的地址</span><br><span class="line">%10 = getelementptr inbounds %struct.structTy, %struct.structTy* %9, i32 0, i32 0</span><br><span class="line">; 然后从这个结构体中获取时就是一个获取了结构体类型对应的偏移的东西的地址</span><br><span class="line">%11 = load i32, i32* %10, align 8</span><br><span class="line">; 然后就是读取了这个地址的值</span><br><span class="line"></span><br><span class="line">; int y = gs[a].b;</span><br><span class="line">%16 = getelementptr inbounds [10 x %struct.structTy], [10 x %struct.structTy]* @gs, i64 0, i64 %15</span><br><span class="line">%17 = getelementptr inbounds %struct.structTy, %struct.structTy* %16, i32 0, i32 1</span><br><span class="line">%18 = load i64, i64* %17, align 8</span><br><span class="line">%19 = trunc i64 %18 to i32</span><br><span class="line"></span><br><span class="line">; int z = gs[a].c[4];</span><br><span class="line">%24 = getelementptr inbounds [10 x %struct.structTy], [10 x %struct.structTy]* @gs, i64 0, i64 %23</span><br><span class="line">; 从数组中获取的是一个结构体变量的地址</span><br><span class="line">%25 = getelementptr inbounds %struct.structTy, %struct.structTy* %24, i32 0, i32 2</span><br><span class="line">; 根据结构体内部的偏移 获取到具体这个值的地址</span><br><span class="line">%26 = getelementptr inbounds [10 x i8], [10 x i8]* %25, i64 0, i64 4</span><br><span class="line">; 然后又是一个数组 再通过偏移拿到一个这个值的地址</span><br><span class="line">%27 = load i8, i8* %26, align 4</span><br><span class="line">; 然后从地址读取了这个值</span><br><span class="line"></span><br><span class="line">; int* p = gs[a].ptr;</span><br><span class="line">%33 = getelementptr inbounds [10 x %struct.structTy], [10 x %struct.structTy]* @gs, i64 0, i64 %32</span><br><span class="line">; 从结构体数组中通过偏移拿到结构体变量的地址</span><br><span class="line">%34 = getelementptr inbounds %struct.structTy, %struct.structTy* %33, i32 0, i32 3</span><br><span class="line">; 结合结构体内部的偏移,从地址中取了个内部值的地址.</span><br><span class="line">%35 = load i32*, i32** %34, align 8</span><br><span class="line">; 然后从地址中读取了值</span><br></pre></td></tr></table></figure>
<h3 id="在-Pass-中检查-IR"><a href="#在-Pass-中检查-IR" class="headerlink" title="在 Pass 中检查 IR"></a>在 Pass 中检查 IR</h3><p>我们可以通过 <code>&lt;&lt;</code> 使用 C++ 的 <code>ostream</code> 将所有我们认为重要的 <code>IR</code> 对象打出来看看。</p>
<p>因为前面的 pass 是处理 <code>Function</code> 的，所以我们可以对 <code>Function</code> 的 <code>BasicBlock</code>  进行迭代，然后遍历每个 <code>BasicBlock</code> 的 <code>Instruction</code> 。</p>
<p>就是对上面的函数进行一个简单的修改就能进行一个遍历:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">runOnFunction</span><span class="params">(Function &amp;F)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;In a function called &quot;</span> &lt;&lt; F.<span class="built_in">getName</span>() &lt;&lt; <span class="string">&quot;!\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;Function body:\n&quot;</span>;</span><br><span class="line">  <span class="comment">//F.dump(); Out-of-Date: no more dump support in modern llvm unless you enable it at compile time.</span></span><br><span class="line">  F.<span class="built_in">print</span>(llvm::<span class="built_in">errs</span>());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;B : F) &#123;</span><br><span class="line">    <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;Basic block:\n&quot;</span>;</span><br><span class="line">    B.<span class="built_in">print</span>(llvm::<span class="built_in">errs</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;I : B) &#123;</span><br><span class="line">      <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;Instruction: \n&quot;</span>;</span><br><span class="line">      I.<span class="built_in">print</span>(llvm::<span class="built_in">errs</span>(), <span class="literal">true</span>);</span><br><span class="line">      <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>然后对下面的 <code>test.c</code> 运行试试看:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// text.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">f</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hello world!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    f();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后运行的输出为：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">$ clang -Xclang -load -Xclang build/skeleton/libSkeletonPass.* test.c </span><br><span class="line">In a <span class="keyword">function</span> called f!</span><br><span class="line">Function body:</span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local void @f() <span class="comment">#0 &#123;</span></span><br><span class="line">  %1 = call i32 (i8*, ...) @<span class="built_in">printf</span>(i8* getelementptr inbounds ([14 x i8], [14 x i8]* @.str, i64 0, i64 0))</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br><span class="line">Basic block:</span><br><span class="line"></span><br><span class="line">  %1 = call i32 (i8*, ...) @<span class="built_in">printf</span>(i8* getelementptr inbounds ([14 x i8], [14 x i8]* @.str, i64 0, i64 0))</span><br><span class="line">  ret void</span><br><span class="line">Instruction: </span><br><span class="line">  %1 = call i32 (i8*, ...) @<span class="built_in">printf</span>(i8* getelementptr inbounds ([14 x i8], [14 x i8]* @.str, i64 0, i64 0))</span><br><span class="line">Instruction: </span><br><span class="line">  ret void</span><br><span class="line">In a <span class="keyword">function</span> called main!</span><br><span class="line">Function body:</span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local i32 @main() <span class="comment">#0 &#123;</span></span><br><span class="line">  %1 = alloca i32, align 4</span><br><span class="line">  store i32 0, i32* %1, align 4</span><br><span class="line">  call void @f()</span><br><span class="line">  ret i32 0</span><br><span class="line">&#125;</span><br><span class="line">Basic block:</span><br><span class="line"></span><br><span class="line">  %1 = alloca i32, align 4</span><br><span class="line">  store i32 0, i32* %1, align 4</span><br><span class="line">  call void @f()</span><br><span class="line">  ret i32 0</span><br><span class="line">Instruction: </span><br><span class="line">  %1 = alloca i32, align 4</span><br><span class="line">Instruction: </span><br><span class="line">  store i32 0, i32* %1, align 4</span><br><span class="line">Instruction: </span><br><span class="line">  call void @f()</span><br><span class="line">Instruction: </span><br><span class="line">  ret i32 0</span><br></pre></td></tr></table></figure>
<p>再来对 <code>if</code> 进行一个测试:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// iftest.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* code */</span></span><br><span class="line">	<span class="keyword">if</span>(argc == <span class="number">0</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;argc = %d\n&quot;</span>, argc);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(argc == <span class="number">1</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;illegal!\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个输出就太多了，这就有更多的基本块了:</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line">In a function called main!</span><br><span class="line">Function body:</span><br><span class="line"><span class="comment">; Function Attrs: noinline nounwind optnone uwtable</span></span><br><span class="line"><span class="keyword">define</span> dso_local <span class="type">i32</span> <span class="title">@main</span>(<span class="type">i32</span> <span class="variable">%0</span><span class="punctuation">,</span> <span class="type">i8</span>** <span class="variable">%1</span>) <span class="variable">#0</span> &#123;</span><br><span class="line">  <span class="variable">%3</span> <span class="operator">=</span> <span class="keyword">alloca</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">4</span></span><br><span class="line">  <span class="variable">%4</span> <span class="operator">=</span> <span class="keyword">alloca</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">4</span></span><br><span class="line">  <span class="variable">%5</span> <span class="operator">=</span> <span class="keyword">alloca</span> <span class="type">i8</span>**<span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">  <span class="keyword">store</span> <span class="type">i32</span> <span class="number">0</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%3</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">4</span></span><br><span class="line">  <span class="keyword">store</span> <span class="type">i32</span> <span class="variable">%0</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%4</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">4</span></span><br><span class="line">  <span class="keyword">store</span> <span class="type">i8</span>** <span class="variable">%1</span><span class="punctuation">,</span> <span class="type">i8</span>*** <span class="variable">%5</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">  <span class="variable">%6</span> <span class="operator">=</span> <span class="keyword">load</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%4</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">4</span></span><br><span class="line">  <span class="variable">%7</span> <span class="operator">=</span> <span class="keyword">icmp</span> <span class="keyword">eq</span> <span class="type">i32</span> <span class="variable">%6</span><span class="punctuation">,</span> <span class="number">0</span></span><br><span class="line">  <span class="keyword">br</span> <span class="type">i1</span> <span class="variable">%7</span><span class="punctuation">,</span> <span class="type">label</span> <span class="variable">%8</span><span class="punctuation">,</span> <span class="type">label</span> <span class="variable">%11</span></span><br><span class="line"></span><br><span class="line"><span class="number">8</span>:                                                <span class="comment">; preds = %2</span></span><br><span class="line">  <span class="variable">%9</span> <span class="operator">=</span> <span class="keyword">load</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%4</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">4</span></span><br><span class="line">  <span class="variable">%10</span> <span class="operator">=</span> <span class="keyword">call</span> <span class="type">i32</span> (<span class="type">i8</span>*<span class="punctuation">,</span> ...) <span class="title">@printf</span>(<span class="type">i8</span>* <span class="keyword">getelementptr</span> <span class="keyword">inbounds</span> ([<span class="number">11</span> <span class="keyword">x</span> <span class="type">i8</span>]<span class="punctuation">,</span> [<span class="number">11</span> <span class="keyword">x</span> <span class="type">i8</span>]* <span class="title">@.str</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span>)<span class="punctuation">,</span> <span class="type">i32</span> <span class="variable">%9</span>)</span><br><span class="line">  <span class="keyword">br</span> <span class="type">label</span> <span class="variable">%22</span></span><br><span class="line"></span><br><span class="line"><span class="number">11</span>:                                               <span class="comment">; preds = %2</span></span><br><span class="line">  <span class="variable">%12</span> <span class="operator">=</span> <span class="keyword">load</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%4</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">4</span></span><br><span class="line">  <span class="variable">%13</span> <span class="operator">=</span> <span class="keyword">icmp</span> <span class="keyword">eq</span> <span class="type">i32</span> <span class="variable">%12</span><span class="punctuation">,</span> <span class="number">1</span></span><br><span class="line">  <span class="keyword">br</span> <span class="type">i1</span> <span class="variable">%13</span><span class="punctuation">,</span> <span class="type">label</span> <span class="variable">%14</span><span class="punctuation">,</span> <span class="type">label</span> <span class="variable">%19</span></span><br><span class="line"></span><br><span class="line"><span class="number">14</span>:                                               <span class="comment">; preds = %11</span></span><br><span class="line">  <span class="variable">%15</span> <span class="operator">=</span> <span class="keyword">load</span> <span class="type">i8</span>**<span class="punctuation">,</span> <span class="type">i8</span>*** <span class="variable">%5</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">  <span class="variable">%16</span> <span class="operator">=</span> <span class="keyword">getelementptr</span> <span class="keyword">inbounds</span> <span class="type">i8</span>*<span class="punctuation">,</span> <span class="type">i8</span>** <span class="variable">%15</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span></span><br><span class="line">  <span class="variable">%17</span> <span class="operator">=</span> <span class="keyword">load</span> <span class="type">i8</span>*<span class="punctuation">,</span> <span class="type">i8</span>** <span class="variable">%16</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">  <span class="variable">%18</span> <span class="operator">=</span> <span class="keyword">call</span> <span class="type">i32</span> (<span class="type">i8</span>*<span class="punctuation">,</span> ...) <span class="title">@printf</span>(<span class="type">i8</span>* <span class="keyword">getelementptr</span> <span class="keyword">inbounds</span> ([<span class="number">3</span> <span class="keyword">x</span> <span class="type">i8</span>]<span class="punctuation">,</span> [<span class="number">3</span> <span class="keyword">x</span> <span class="type">i8</span>]* <span class="title">@.str.1</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span>)<span class="punctuation">,</span> <span class="type">i8</span>* <span class="variable">%17</span>)</span><br><span class="line">  <span class="keyword">br</span> <span class="type">label</span> <span class="variable">%21</span></span><br><span class="line"></span><br><span class="line"><span class="number">19</span>:                                               <span class="comment">; preds = %11</span></span><br><span class="line">  <span class="variable">%20</span> <span class="operator">=</span> <span class="keyword">call</span> <span class="type">i32</span> (<span class="type">i8</span>*<span class="punctuation">,</span> ...) <span class="title">@printf</span>(<span class="type">i8</span>* <span class="keyword">getelementptr</span> <span class="keyword">inbounds</span> ([<span class="number">10</span> <span class="keyword">x</span> <span class="type">i8</span>]<span class="punctuation">,</span> [<span class="number">10</span> <span class="keyword">x</span> <span class="type">i8</span>]* <span class="title">@.str.2</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span>))</span><br><span class="line">  <span class="keyword">br</span> <span class="type">label</span> <span class="variable">%21</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:                                               <span class="comment">; preds = %19, %14</span></span><br><span class="line">  <span class="keyword">br</span> <span class="type">label</span> <span class="variable">%22</span></span><br><span class="line"></span><br><span class="line"><span class="number">22</span>:                                               <span class="comment">; preds = %21, %8</span></span><br><span class="line">  <span class="keyword">ret</span> <span class="type">i32</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line">Basic block:</span><br><span class="line"></span><br><span class="line">  <span class="variable">%3</span> <span class="operator">=</span> <span class="keyword">alloca</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">4</span></span><br><span class="line">  <span class="variable">%4</span> <span class="operator">=</span> <span class="keyword">alloca</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">4</span></span><br><span class="line">  <span class="variable">%5</span> <span class="operator">=</span> <span class="keyword">alloca</span> <span class="type">i8</span>**<span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">  <span class="keyword">store</span> <span class="type">i32</span> <span class="number">0</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%3</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">4</span></span><br><span class="line">  <span class="keyword">store</span> <span class="type">i32</span> <span class="variable">%0</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%4</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">4</span></span><br><span class="line">  <span class="keyword">store</span> <span class="type">i8</span>** <span class="variable">%1</span><span class="punctuation">,</span> <span class="type">i8</span>*** <span class="variable">%5</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">  <span class="variable">%6</span> <span class="operator">=</span> <span class="keyword">load</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%4</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">4</span></span><br><span class="line">  <span class="variable">%7</span> <span class="operator">=</span> <span class="keyword">icmp</span> <span class="keyword">eq</span> <span class="type">i32</span> <span class="variable">%6</span><span class="punctuation">,</span> <span class="number">0</span></span><br><span class="line">  <span class="keyword">br</span> <span class="type">i1</span> <span class="variable">%7</span><span class="punctuation">,</span> <span class="type">label</span> <span class="variable">%8</span><span class="punctuation">,</span> <span class="type">label</span> <span class="variable">%11</span></span><br><span class="line">Instruction: </span><br><span class="line">  <span class="variable">%3</span> <span class="operator">=</span> <span class="keyword">alloca</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">4</span></span><br><span class="line">Instruction: </span><br><span class="line">  <span class="variable">%4</span> <span class="operator">=</span> <span class="keyword">alloca</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">4</span></span><br><span class="line">Instruction: </span><br><span class="line">  <span class="variable">%5</span> <span class="operator">=</span> <span class="keyword">alloca</span> <span class="type">i8</span>**<span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">Instruction: </span><br><span class="line">  <span class="keyword">store</span> <span class="type">i32</span> <span class="number">0</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%3</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">4</span></span><br><span class="line">Instruction: </span><br><span class="line">  <span class="keyword">store</span> <span class="type">i32</span> <span class="variable">%0</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%4</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">4</span></span><br><span class="line">Instruction: </span><br><span class="line">  <span class="keyword">store</span> <span class="type">i8</span>** <span class="variable">%1</span><span class="punctuation">,</span> <span class="type">i8</span>*** <span class="variable">%5</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">Instruction: </span><br><span class="line">  <span class="variable">%6</span> <span class="operator">=</span> <span class="keyword">load</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%4</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">4</span></span><br><span class="line">Instruction: </span><br><span class="line">  <span class="variable">%7</span> <span class="operator">=</span> <span class="keyword">icmp</span> <span class="keyword">eq</span> <span class="type">i32</span> <span class="variable">%6</span><span class="punctuation">,</span> <span class="number">0</span></span><br><span class="line">Instruction: </span><br><span class="line">  <span class="keyword">br</span> <span class="type">i1</span> <span class="variable">%7</span><span class="punctuation">,</span> <span class="type">label</span> <span class="variable">%8</span><span class="punctuation">,</span> <span class="type">label</span> <span class="variable">%11</span></span><br><span class="line">Basic block:</span><br><span class="line"></span><br><span class="line"><span class="number">8</span>:                                                <span class="comment">; preds = %2</span></span><br><span class="line">  <span class="variable">%9</span> <span class="operator">=</span> <span class="keyword">load</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%4</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">4</span></span><br><span class="line">  <span class="variable">%10</span> <span class="operator">=</span> <span class="keyword">call</span> <span class="type">i32</span> (<span class="type">i8</span>*<span class="punctuation">,</span> ...) <span class="title">@printf</span>(<span class="type">i8</span>* <span class="keyword">getelementptr</span> <span class="keyword">inbounds</span> ([<span class="number">11</span> <span class="keyword">x</span> <span class="type">i8</span>]<span class="punctuation">,</span> [<span class="number">11</span> <span class="keyword">x</span> <span class="type">i8</span>]* <span class="title">@.str</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span>)<span class="punctuation">,</span> <span class="type">i32</span> <span class="variable">%9</span>)</span><br><span class="line">  <span class="keyword">br</span> <span class="type">label</span> <span class="variable">%22</span></span><br><span class="line">Instruction: </span><br><span class="line">  <span class="variable">%9</span> <span class="operator">=</span> <span class="keyword">load</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%4</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">4</span></span><br><span class="line">Instruction: </span><br><span class="line">  <span class="variable">%10</span> <span class="operator">=</span> <span class="keyword">call</span> <span class="type">i32</span> (<span class="type">i8</span>*<span class="punctuation">,</span> ...) <span class="title">@printf</span>(<span class="type">i8</span>* <span class="keyword">getelementptr</span> <span class="keyword">inbounds</span> ([<span class="number">11</span> <span class="keyword">x</span> <span class="type">i8</span>]<span class="punctuation">,</span> [<span class="number">11</span> <span class="keyword">x</span> <span class="type">i8</span>]* <span class="title">@.str</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span>)<span class="punctuation">,</span> <span class="type">i32</span> <span class="variable">%9</span>)</span><br><span class="line">Instruction: </span><br><span class="line">  <span class="keyword">br</span> <span class="type">label</span> <span class="variable">%22</span></span><br><span class="line">Basic block:</span><br><span class="line"></span><br><span class="line"><span class="number">11</span>:                                               <span class="comment">; preds = %2</span></span><br><span class="line">  <span class="variable">%12</span> <span class="operator">=</span> <span class="keyword">load</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%4</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">4</span></span><br><span class="line">  <span class="variable">%13</span> <span class="operator">=</span> <span class="keyword">icmp</span> <span class="keyword">eq</span> <span class="type">i32</span> <span class="variable">%12</span><span class="punctuation">,</span> <span class="number">1</span></span><br><span class="line">  <span class="keyword">br</span> <span class="type">i1</span> <span class="variable">%13</span><span class="punctuation">,</span> <span class="type">label</span> <span class="variable">%14</span><span class="punctuation">,</span> <span class="type">label</span> <span class="variable">%19</span></span><br><span class="line">Instruction: </span><br><span class="line">  <span class="variable">%12</span> <span class="operator">=</span> <span class="keyword">load</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%4</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">4</span></span><br><span class="line">Instruction: </span><br><span class="line">  <span class="variable">%13</span> <span class="operator">=</span> <span class="keyword">icmp</span> <span class="keyword">eq</span> <span class="type">i32</span> <span class="variable">%12</span><span class="punctuation">,</span> <span class="number">1</span></span><br><span class="line">Instruction: </span><br><span class="line">  <span class="keyword">br</span> <span class="type">i1</span> <span class="variable">%13</span><span class="punctuation">,</span> <span class="type">label</span> <span class="variable">%14</span><span class="punctuation">,</span> <span class="type">label</span> <span class="variable">%19</span></span><br><span class="line">Basic block:</span><br><span class="line"></span><br><span class="line"><span class="number">14</span>:                                               <span class="comment">; preds = %11</span></span><br><span class="line">  <span class="variable">%15</span> <span class="operator">=</span> <span class="keyword">load</span> <span class="type">i8</span>**<span class="punctuation">,</span> <span class="type">i8</span>*** <span class="variable">%5</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">  <span class="variable">%16</span> <span class="operator">=</span> <span class="keyword">getelementptr</span> <span class="keyword">inbounds</span> <span class="type">i8</span>*<span class="punctuation">,</span> <span class="type">i8</span>** <span class="variable">%15</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span></span><br><span class="line">  <span class="variable">%17</span> <span class="operator">=</span> <span class="keyword">load</span> <span class="type">i8</span>*<span class="punctuation">,</span> <span class="type">i8</span>** <span class="variable">%16</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">  <span class="variable">%18</span> <span class="operator">=</span> <span class="keyword">call</span> <span class="type">i32</span> (<span class="type">i8</span>*<span class="punctuation">,</span> ...) <span class="title">@printf</span>(<span class="type">i8</span>* <span class="keyword">getelementptr</span> <span class="keyword">inbounds</span> ([<span class="number">3</span> <span class="keyword">x</span> <span class="type">i8</span>]<span class="punctuation">,</span> [<span class="number">3</span> <span class="keyword">x</span> <span class="type">i8</span>]* <span class="title">@.str.1</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span>)<span class="punctuation">,</span> <span class="type">i8</span>* <span class="variable">%17</span>)</span><br><span class="line">  <span class="keyword">br</span> <span class="type">label</span> <span class="variable">%21</span></span><br><span class="line">Instruction: </span><br><span class="line">  <span class="variable">%15</span> <span class="operator">=</span> <span class="keyword">load</span> <span class="type">i8</span>**<span class="punctuation">,</span> <span class="type">i8</span>*** <span class="variable">%5</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">Instruction: </span><br><span class="line">  <span class="variable">%16</span> <span class="operator">=</span> <span class="keyword">getelementptr</span> <span class="keyword">inbounds</span> <span class="type">i8</span>*<span class="punctuation">,</span> <span class="type">i8</span>** <span class="variable">%15</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span></span><br><span class="line">Instruction: </span><br><span class="line">  <span class="variable">%17</span> <span class="operator">=</span> <span class="keyword">load</span> <span class="type">i8</span>*<span class="punctuation">,</span> <span class="type">i8</span>** <span class="variable">%16</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">Instruction: </span><br><span class="line">  <span class="variable">%18</span> <span class="operator">=</span> <span class="keyword">call</span> <span class="type">i32</span> (<span class="type">i8</span>*<span class="punctuation">,</span> ...) <span class="title">@printf</span>(<span class="type">i8</span>* <span class="keyword">getelementptr</span> <span class="keyword">inbounds</span> ([<span class="number">3</span> <span class="keyword">x</span> <span class="type">i8</span>]<span class="punctuation">,</span> [<span class="number">3</span> <span class="keyword">x</span> <span class="type">i8</span>]* <span class="title">@.str.1</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span>)<span class="punctuation">,</span> <span class="type">i8</span>* <span class="variable">%17</span>)</span><br><span class="line">Instruction: </span><br><span class="line">  <span class="keyword">br</span> <span class="type">label</span> <span class="variable">%21</span></span><br><span class="line">Basic block:</span><br><span class="line"></span><br><span class="line"><span class="number">19</span>:                                               <span class="comment">; preds = %11</span></span><br><span class="line">  <span class="variable">%20</span> <span class="operator">=</span> <span class="keyword">call</span> <span class="type">i32</span> (<span class="type">i8</span>*<span class="punctuation">,</span> ...) <span class="title">@printf</span>(<span class="type">i8</span>* <span class="keyword">getelementptr</span> <span class="keyword">inbounds</span> ([<span class="number">10</span> <span class="keyword">x</span> <span class="type">i8</span>]<span class="punctuation">,</span> [<span class="number">10</span> <span class="keyword">x</span> <span class="type">i8</span>]* <span class="title">@.str.2</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span>))</span><br><span class="line">  <span class="keyword">br</span> <span class="type">label</span> <span class="variable">%21</span></span><br><span class="line">Instruction: </span><br><span class="line">  <span class="variable">%20</span> <span class="operator">=</span> <span class="keyword">call</span> <span class="type">i32</span> (<span class="type">i8</span>*<span class="punctuation">,</span> ...) <span class="title">@printf</span>(<span class="type">i8</span>* <span class="keyword">getelementptr</span> <span class="keyword">inbounds</span> ([<span class="number">10</span> <span class="keyword">x</span> <span class="type">i8</span>]<span class="punctuation">,</span> [<span class="number">10</span> <span class="keyword">x</span> <span class="type">i8</span>]* <span class="title">@.str.2</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span><span class="punctuation">,</span> <span class="type">i64</span> <span class="number">0</span>))</span><br><span class="line">Instruction: </span><br><span class="line">  <span class="keyword">br</span> <span class="type">label</span> <span class="variable">%21</span></span><br><span class="line">Basic block:</span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:                                               <span class="comment">; preds = %19, %14</span></span><br><span class="line">  <span class="keyword">br</span> <span class="type">label</span> <span class="variable">%22</span></span><br><span class="line">Instruction: </span><br><span class="line">  <span class="keyword">br</span> <span class="type">label</span> <span class="variable">%22</span></span><br><span class="line">Basic block:</span><br><span class="line"></span><br><span class="line"><span class="number">22</span>:                                               <span class="comment">; preds = %21, %8</span></span><br><span class="line">  <span class="keyword">ret</span> <span class="type">i32</span> <span class="number">0</span></span><br><span class="line">Instruction: </span><br><span class="line">  <span class="keyword">ret</span> <span class="type">i32</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>
<h3 id="在-pass-做一些有趣的事情"><a href="#在-pass-做一些有趣的事情" class="headerlink" title="在 pass 做一些有趣的事情"></a>在 pass 做一些有趣的事情</h3><p>下面这个例子会将所有的二进制操作中的第一个 operator (+,-, etc.) 替换为 乘。</p>
<p>完整代码在 <a target="_blank" rel="noopener" href="https://github.com/sampsyo/llvm-pass-skeleton/tree/mutate">这里</a> 核心代码如下:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span>&amp; B : F) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; I : B) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">auto</span>* op = <span class="built_in">dyn_cast</span>&lt;BinaryOperator&gt;(&amp;I)) &#123; <span class="comment">// 它检查操作数是否属于指定类型，如果是，则返回指向它的指针（此运算符不适用于引用），否则返回 NULL。具体这里就是检查 I 是不是 BinaryOperator 类型的，如果不是就会 NULL，如果是就返回这个指令对应的指针。</span></span><br><span class="line">      <span class="comment">// Insert at the point where the instruction `op` appears.</span></span><br><span class="line">      IRBuilder&lt;&gt; <span class="built_in">builder</span>(op); <span class="comment">// IRBuilder 用于构建代码，我们要的任何类型的指令都能构造</span></span><br><span class="line">      <span class="comment">// 我猜此处的意思应该是 builder 是 IRBuilder 类的实例，然后是在 op 这个地址上创建一个指令</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// Make a multiply with the same operands as `op`.</span></span><br><span class="line">      Value* lhs = op-&gt;<span class="built_in">getOperand</span>(<span class="number">0</span>); <span class="comment">// 获取原来指令的两个操作数</span></span><br><span class="line">      Value* rhs = op-&gt;<span class="built_in">getOperand</span>(<span class="number">1</span>);</span><br><span class="line">      Value* mul = builder.<span class="built_in">CreateMul</span>(lhs, rhs); <span class="comment">// 使用 IRBuilder 来创建一个乘法</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// Everywhere the old instruction was used as an operand, use our</span></span><br><span class="line">      <span class="comment">// new multiply instruction instead.</span></span><br><span class="line">      <span class="comment">// 任何旧指令被用来作为 operand 的都用我们的新指令进行替换</span></span><br><span class="line">      <span class="comment">// 这里还不理解</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; U : op-&gt;<span class="built_in">uses</span>()) &#123;</span><br><span class="line">        User* user = U.<span class="built_in">getUser</span>();  <span class="comment">// A User is anything with operands.</span></span><br><span class="line">        user-&gt;<span class="built_in">setOperand</span>(U.<span class="built_in">getOperandNo</span>(), mul);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// We modified the code.</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后对下面的 <code>a_add_b.c</code> 进行测试:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span>** argv)</span> &#123;</span><br><span class="line">    <span class="type">int</span> num;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%i&quot;</span>, &amp;num);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%i\n&quot;</span>, num + <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后插桩编译和不插桩编译会有两种情况的结果:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ clang a_add_b.c</span><br><span class="line">$ ./a.out</span><br><span class="line">4</span><br><span class="line">6</span><br><span class="line"></span><br><span class="line">$ clang -Xclang -load -Xclang build/skeleton/libSkeletonPass.* a_add_b.c</span><br><span class="line">$ ./a.out</span><br><span class="line">4</span><br><span class="line">8</span><br></pre></td></tr></table></figure>
<h3 id="dyn-cast-和-isa"><a href="#dyn-cast-和-isa" class="headerlink" title="dyn_cast 和 isa"></a>dyn_cast 和 isa</h3><p><code>dyn_cast&lt;CallInst&gt;(&amp;I)</code>  和 <code>isa&lt;CallInst&gt;(&amp;I)</code> 有什么区别?</p>
<p><code>dyn_cast&lt;CallInst&gt;(&amp;I)</code> 和 <code>isa&lt;CallInst&gt;(&amp;I)</code> 都是 <code>LLVM</code> 中用于检查对象类型的函数，但它们的行为略有不同。</p>
<p><code>isa&lt;CallInst&gt;(&amp;I)</code> 函数是一个模板函数，用于检查指定的对象是否是特定类的实例。如果指定的对象是该类的实例，则该函数返回 true，否则返回 false。例如，<code>isa&lt;CallInst&gt;(&amp;I)</code> 用于检查指令 <code>I</code> 是否是 <code>CallInst</code> 类的实例。</p>
<p><code>dyn_cast&lt;CallInst&gt;(&amp;I)</code> 函数也是一个模板函数，用于将指定的对象转换为特定类的实例。如果指定的对象可以转换为该类的实例，则该函数返回该实例的指针，否则返回空指针。例如，<code>dyn_cast&lt;CallInst&gt;(&amp;I)</code> 用于将指令 <code>I</code> 转换为 <code>CallInst</code> 类的实例，如果指令 <code>I</code> 不是 <code>CallInst</code> 类的实例，则返回空指针。</p>
<p>因此，<code>isa&lt;CallInst&gt;(&amp;I)</code> 函数只是用于检查对象类型，而 <code>dyn_cast&lt;CallInst&gt;(&amp;I)</code> 函数则可以将对象转换为特定类型的实例。在使用这些函数时，应当根据需要选择使用哪个函数。如果只需要检查对象是否是某个特定类的实例，则使用 <code>isa&lt;&gt;()</code> 函数；如果需要将对象转换为某个特定类的实例，则使用 <code>dyn_cast&lt;&gt;()</code> 函数。</p>
<h3 id="CallGraphSCCPass"><a href="#CallGraphSCCPass" class="headerlink" title="CallGraphSCCPass"></a>CallGraphSCCPass</h3><p><code>CallGraphSCCPass</code> 是 <code>LLVM</code> 中的一个 <code>Pass</code>，用于对函数调用图（<code>`Call Graph</code>）进行处理。在 <code>CallGraphSCCPass</code> 中，可以使用 <code>CallGraphSCC</code> 类来表示函数调用图中的一个强连通分量（<code>Strongly Connected Component</code>），其中包含了多个函数。</p>
<p>您可以使用 <code>CallGraphSCCPass</code> 的 <code>runOnSCC()</code> 函数来遍历每个强连通分量，并对其中的每个函数进行处理。在 <code>runOnSCC()</code> 函数中，可以使用 <code>auto</code> 关键字来遍历 <code>CallGraphSCC</code> 中的每个函数。以下是一个示例代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Pass.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Analysis/CallGraphSCCPass.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Function.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Support/raw_ostream.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> llvm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">MyCallGraphSCCPass</span> : <span class="keyword">public</span> CallGraphSCCPass &#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">char</span> ID;</span><br><span class="line">    <span class="built_in">MyCallGraphSCCPass</span>() : <span class="built_in">CallGraphSCCPass</span>(ID) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">runOnSCC</span><span class="params">(CallGraphSCC &amp;SCC)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">      <span class="comment">// Traverse functions in SCC</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;I : SCC) &#123;</span><br><span class="line">        Function *F = I-&gt;<span class="built_in">getFunction</span>();</span><br><span class="line">        <span class="keyword">if</span> (F) &#123;</span><br><span class="line">          <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;Processing function: &quot;</span> &lt;&lt; F-&gt;<span class="built_in">getName</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">          <span class="comment">// Process the function here</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> MyCallGraphSCCPass::ID = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="type">static</span> RegisterPass&lt;MyCallGraphSCCPass&gt; <span class="title">X</span><span class="params">(<span class="string">&quot;mycallgraphsccpass&quot;</span>, <span class="string">&quot;My CallGraphSCC Pass&quot;</span>, <span class="literal">false</span>, <span class="literal">false</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="Linking-With-a-Runtime-Library"><a href="#Linking-With-a-Runtime-Library" class="headerlink" title="Linking With a Runtime Library"></a>Linking With a Runtime Library</h3><p>当您需要检测代码来做一些重要的事情时，使用 <code>IRBuilder</code> 生成 LLVM 指令来完成它可能会很痛苦。那就想或许可以写一个 C 的运行时库，在运行时给链接上去，然后记录日志啥的。下面就教你如何编写一个运行时库 log 每个指令操作的结果。</p>
<p>通过这样的方式，我们不用每次都去改 <code>Pass</code> 然后重新编译程序进行插桩/替换啥的，而是直接告诉他我要固定调用某个运行时库中的函数，这样我们可以每次只修改外部的函数的具体实现，而不用再重新编译原来的程序了。</p>
<p>代码如下:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Pass.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Function.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Support/raw_ostream.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/LegacyPassManager.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/InstrTypes.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Transforms/IPO/PassManagerBuilder.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/IRBuilder.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Transforms/Utils/BasicBlockUtils.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Module.h&quot;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> llvm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">SkeletonPass</span> : <span class="keyword">public</span> FunctionPass &#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">char</span> ID;</span><br><span class="line">    <span class="built_in">SkeletonPass</span>() : <span class="built_in">FunctionPass</span>(ID) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">runOnFunction</span><span class="params">(Function &amp;F)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Get the function to call from our runtime library.</span></span><br><span class="line">        LLVMContext &amp;Ctx = F.<span class="built_in">getContext</span>();</span><br><span class="line">        std::vector&lt;Type*&gt; paramTypes = &#123;Type::<span class="built_in">getInt32Ty</span>(Ctx)&#125;;</span><br><span class="line">        Type *retType = Type::<span class="built_in">getVoidTy</span>(Ctx);</span><br><span class="line">        FunctionType *logFuncType = FunctionType::<span class="built_in">get</span>(retType, paramTypes, <span class="literal">false</span>);</span><br><span class="line">        <span class="comment">// Module::getOrInsertFunction 为你的运行时函数 logop 添加了一个声明，类似于 C 源代码中有函数体的声明 “void logop(int i); ”</span></span><br><span class="line">        <span class="comment">// 该指令代码与定义该 logop 函数的运行时库（存储库中的 rtlib.c）配对</span></span><br><span class="line">        <span class="comment">// rtlib.c</span></span><br><span class="line">        <span class="comment">// #include &lt;stdio.h&gt;</span></span><br><span class="line">        <span class="comment">// void logop(int i) &#123;</span></span><br><span class="line">        <span class="comment">//   printf(&quot;computed: %i\n&quot;, i);</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      FunctionCallee logFunc = </span><br><span class="line">       F.<span class="built_in">getParent</span>()-&gt;<span class="built_in">getOrInsertFunction</span>(<span class="string">&quot;logop&quot;</span>, logFuncType);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;B : F) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;I : B) &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">auto</span> *op = <span class="built_in">dyn_cast</span>&lt;BinaryOperator&gt;(&amp;I)) &#123;</span><br><span class="line">            <span class="comment">// Insert *after* `op`.</span></span><br><span class="line">            IRBuilder&lt;&gt; <span class="built_in">builder</span>(op);</span><br><span class="line">            builder.<span class="built_in">SetInsertPoint</span>(&amp;B, ++builder.<span class="built_in">GetInsertPoint</span>());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Insert a call to our function.</span></span><br><span class="line">            Value* args[] = &#123;op&#125;;</span><br><span class="line">            builder.<span class="built_in">CreateCall</span>(logFunc, args);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> SkeletonPass::ID = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Automatically enable the pass.</span></span><br><span class="line"><span class="comment">// http://adriansampson.net/blog/clangpass.html</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">registerSkeletonPass</span><span class="params">(<span class="type">const</span> PassManagerBuilder &amp;,</span></span></span><br><span class="line"><span class="params"><span class="function">                         legacy::PassManagerBase &amp;PM)</span> </span>&#123;</span><br><span class="line">  PM.<span class="built_in">add</span>(<span class="keyword">new</span> <span class="built_in">SkeletonPass</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">static</span> RegisterStandardPasses</span></span><br><span class="line"><span class="function">  <span class="title">RegisterMyPass</span><span class="params">(PassManagerBuilder::EP_EarlyAsPossible,</span></span></span><br><span class="line"><span class="params"><span class="function">                 registerSkeletonPass)</span></span>;</span><br></pre></td></tr></table></figure>
<p>外部的动态链接库 <code>rtlib.c</code> 代码为:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// rtlib.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">logop</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;computed: %i\n&quot;</span>, i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后编译该库:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ cc -c rtlib.c</span><br><span class="line">$ clang -Xclang -load -Xclang build/skeleton/libSkeletonPass.so -c a_add_b.c</span><br><span class="line">$ cc a_add_b.o rtlib.o</span><br><span class="line">$ ./a.out</span><br><span class="line">15</span><br><span class="line">computed: 17</span><br><span class="line">17</span><br></pre></td></tr></table></figure>
<p>这时候我们简单修改一下 <code>rtlib.c</code> 试试:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// rtlib.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">logop</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;computed: %i\n&quot;</span>, i);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;new rtlib.c\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再重新编译、链接一下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ cc -c rtlib.c</span><br><span class="line">$ cc a_add_b.o rtlib.o</span><br><span class="line">$ ./a.out</span><br><span class="line">3</span><br><span class="line">computed: 5</span><br><span class="line">new rtlib.c</span><br><span class="line">5</span><br></pre></td></tr></table></figure>
<h3 id="Annotations-注释信息"><a href="#Annotations-注释信息" class="headerlink" title="Annotations 注释信息"></a>Annotations 注释信息</h3><p>大多数项目最终都需要与程序员进行交互。 您最终会希望某种将额外信息从程序传递到您的 LLVM pass 的方法。 有几种方法可以建立注释系统：</p>
<ul>
<li><p>实用的方法是使用魔法函数。 在头文件中使用特殊的、可能唯一的名称声明一些空函数。 将该文件包含在您的源代码中并调用那些不执行任何操作的函数。 然后，在 pass 中，查找调用您的函数的 <code>CallInst</code> 指令并使用它们来触发您的魔法函数。 例如，您可以使用 __enable_instrumentation() 和 __disable_instrumentation() 之类的调用来让程序将您的代码修改限制在特定区域。</p>
</li>
<li><p>如果您需要让程序员将标记添加到函数或变量声明中，Clang 的 __attribute__((annotate(“foo”))) 语法将发出带有您可以在传递中处理的任意字符串的 <a target="_blank" rel="noopener" href="http://llvm.org/docs/LangRef.html#metadata">metadata </a>。 Brandon Holt again has <a target="_blank" rel="noopener" href="http://bholt.org/posts/llvm-quick-tricks.html">some background on this technique</a>。 如果您需要标记表达式而不是声明，则未没有文档的且是有限的 __builtin_annotation(e, “foo”) 内在函数可能会起作用。</p>
</li>
</ul>
<h2 id="插桩条件分支语句"><a href="#插桩条件分支语句" class="headerlink" title="插桩条件分支语句"></a>插桩条件分支语句</h2><p>在学习了上述的部分基础之后再看之前看雪中的 <a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-271739.htm">编译时插桩</a> 代码好像就容易懂一些其位置了。但是此时我才明白这个中提到的插桩是插入 <code>if-else</code> 逻辑的代码到源代码中，而不是对源代码中的 <code>if-else</code> 逻辑进行插桩。</p>
<p>于是简单看了看官方文档中关于 <a target="_blank" rel="noopener" href="https://www.llvm.org/doxygen/classllvm_1_1Instruction.html">Instruction</a> 的函数都有啥，于是就发现了以下几个有趣的函数:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">llvm::Value::<span class="built_in">getValueID</span>()</span><br><span class="line"><span class="built_in">getOpcode</span>() <span class="type">unsigned</span> llvm::Instruction::<span class="built_in">getOpcode</span>   (       )   <span class="function"><span class="type">const</span></span></span><br><span class="line"><span class="function"><span class="title">getOpcodeName</span><span class="params">()</span> <span class="type">const</span> <span class="type">char</span> * <span class="title">Instruction::getOpcodeName</span> <span class="params">(   <span class="type">unsigned</span>    OpCode  )</span>   </span></span><br><span class="line"><span class="function"><span class="title">getOpcodeName</span><span class="params">()</span> <span class="type">const</span> <span class="type">char</span>* llvm::<span class="title">Instruction::getOpcodeName</span> <span class="params">(       )</span>   <span class="type">const</span></span></span><br></pre></td></tr></table></figure>
<p>于是我们简单写一个下面的 pass 进行测试，把上面的函数都用一次看看:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">runOnFunction</span><span class="params">(Function &amp;F)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;In a function called &quot;</span> &lt;&lt; F.<span class="built_in">getName</span>() &lt;&lt; <span class="string">&quot;!\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;B : F) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;I : B) &#123;</span><br><span class="line">            <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;Instruction: \n&quot;</span>;</span><br><span class="line">            I.<span class="built_in">print</span>(llvm::<span class="built_in">errs</span>(), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;, &quot;</span>;</span><br><span class="line">            <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;getValueID() = &quot;</span>;</span><br><span class="line">            <span class="built_in">errs</span>() &lt;&lt; I.<span class="built_in">getValueID</span>();</span><br><span class="line"></span><br><span class="line">            <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;, &quot;</span>;</span><br><span class="line">            <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;getOpcode() = &quot;</span>;</span><br><span class="line">            <span class="built_in">errs</span>() &lt;&lt; I.<span class="built_in">getOpcode</span>();</span><br><span class="line"></span><br><span class="line">            <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;, &quot;</span>;</span><br><span class="line">            <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;getOpcodeName() = &quot;</span>;</span><br><span class="line">            <span class="built_in">errs</span>() &lt;&lt; I.<span class="built_in">getOpcodeName</span>();</span><br><span class="line"></span><br><span class="line">            <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;, &quot;</span>;</span><br><span class="line">            <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;getOpcodeName(unsigned OpCode) = &quot;</span>;</span><br><span class="line">            <span class="built_in">errs</span>() &lt;&lt; I.<span class="built_in">getOpcodeName</span>(I.<span class="built_in">getOpcode</span>());</span><br><span class="line"></span><br><span class="line">            <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们简单对 <code>iftest.c</code> 进行一个测试, 得到的输出如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">$ clang -Xclang -load -Xclang build/skeleton/libSkeletonPass.* iftest.c</span><br><span class="line">In a <span class="keyword">function</span> called main!</span><br><span class="line">Instruction: </span><br><span class="line">  %3 = alloca i32, align 4, getValueID() = 55, getOpcode() = 31, getOpcodeName() = alloca, getOpcodeName(unsigned OpCode) = alloca</span><br><span class="line">Instruction: </span><br><span class="line">  %4 = alloca i32, align 4, getValueID() = 55, getOpcode() = 31, getOpcodeName() = alloca, getOpcodeName(unsigned OpCode) = alloca</span><br><span class="line">Instruction: </span><br><span class="line">  %5 = alloca i8**, align 8, getValueID() = 55, getOpcode() = 31, getOpcodeName() = alloca, getOpcodeName(unsigned OpCode) = alloca</span><br><span class="line">Instruction: </span><br><span class="line">  store i32 0, i32* %3, align 4, getValueID() = 57, getOpcode() = 33, getOpcodeName() = store, getOpcodeName(unsigned OpCode) = store</span><br><span class="line">Instruction: </span><br><span class="line">  store i32 %0, i32* %4, align 4, getValueID() = 57, getOpcode() = 33, getOpcodeName() = store, getOpcodeName(unsigned OpCode) = store</span><br><span class="line">Instruction: </span><br><span class="line">  store i8** %1, i8*** %5, align 8, getValueID() = 57, getOpcode() = 33, getOpcodeName() = store, getOpcodeName(unsigned OpCode) = store</span><br><span class="line">Instruction: </span><br><span class="line">  %6 = load i32, i32* %4, align 4, getValueID() = 56, getOpcode() = 32, getOpcodeName() = load, getOpcodeName(unsigned OpCode) = load</span><br><span class="line">Instruction: </span><br><span class="line">  %7 = icmp eq i32 %6, 0, getValueID() = 77, getOpcode() = 53, getOpcodeName() = icmp, getOpcodeName(unsigned OpCode) = icmp</span><br><span class="line">Instruction: </span><br><span class="line">  br i1 %7, label %8, label %11, getValueID() = 26, getOpcode() = 2, getOpcodeName() = br, getOpcodeName(unsigned OpCode) = br</span><br><span class="line">Instruction: </span><br><span class="line">  %9 = load i32, i32* %4, align 4, getValueID() = 56, getOpcode() = 32, getOpcodeName() = load, getOpcodeName(unsigned OpCode) = load</span><br><span class="line">Instruction: </span><br><span class="line">  %10 = call i32 (i8*, ...) @<span class="built_in">printf</span>(i8* getelementptr inbounds ([11 x i8], [11 x i8]* @.str, i64 0, i64 0), i32 %9), getValueID() = 80, getOpcode() = 56, getOpcodeName() = call, getOpcodeName(unsigned OpCode) = call</span><br><span class="line">Instruction: </span><br><span class="line">  br label %22, getValueID() = 26, getOpcode() = 2, getOpcodeName() = br, getOpcodeName(unsigned OpCode) = br</span><br><span class="line">Instruction: </span><br><span class="line">  %12 = load i32, i32* %4, align 4, getValueID() = 56, getOpcode() = 32, getOpcodeName() = load, getOpcodeName(unsigned OpCode) = load</span><br><span class="line">Instruction: </span><br><span class="line">  %13 = icmp eq i32 %12, 1, getValueID() = 77, getOpcode() = 53, getOpcodeName() = icmp, getOpcodeName(unsigned OpCode) = icmp</span><br><span class="line">Instruction: </span><br><span class="line">  br i1 %13, label %14, label %19, getValueID() = 26, getOpcode() = 2, getOpcodeName() = br, getOpcodeName(unsigned OpCode) = br</span><br><span class="line">Instruction: </span><br><span class="line">  %15 = load i8**, i8*** %5, align 8, getValueID() = 56, getOpcode() = 32, getOpcodeName() = load, getOpcodeName(unsigned OpCode) = load</span><br><span class="line">Instruction: </span><br><span class="line">  %16 = getelementptr inbounds i8*, i8** %15, i64 0, getValueID() = 58, getOpcode() = 34, getOpcodeName() = getelementptr, getOpcodeName(unsigned OpCode) = getelementptr</span><br><span class="line">Instruction: </span><br><span class="line">  %17 = load i8*, i8** %16, align 8, getValueID() = 56, getOpcode() = 32, getOpcodeName() = load, getOpcodeName(unsigned OpCode) = load</span><br><span class="line">Instruction: </span><br><span class="line">  %18 = call i32 (i8*, ...) @<span class="built_in">printf</span>(i8* getelementptr inbounds ([3 x i8], [3 x i8]* @.str.1, i64 0, i64 0), i8* %17), getValueID() = 80, getOpcode() = 56, getOpcodeName() = call, getOpcodeName(unsigned OpCode) = call</span><br><span class="line">Instruction: </span><br><span class="line">  br label %21, getValueID() = 26, getOpcode() = 2, getOpcodeName() = br, getOpcodeName(unsigned OpCode) = br</span><br><span class="line">Instruction: </span><br><span class="line">  %20 = call i32 (i8*, ...) @<span class="built_in">printf</span>(i8* getelementptr inbounds ([10 x i8], [10 x i8]* @.str.2, i64 0, i64 0)), getValueID() = 80, getOpcode() = 56, getOpcodeName() = call, getOpcodeName(unsigned OpCode) = call</span><br><span class="line">Instruction: </span><br><span class="line">  br label %21, getValueID() = 26, getOpcode() = 2, getOpcodeName() = br, getOpcodeName(unsigned OpCode) = br</span><br><span class="line">Instruction: </span><br><span class="line">  br label %22, getValueID() = 26, getOpcode() = 2, getOpcodeName() = br, getOpcodeName(unsigned OpCode) = br</span><br><span class="line">Instruction: </span><br><span class="line">  ret i32 0, getValueID() = 25, getOpcode() = 1, getOpcodeName() = ret, getOpcodeName(unsigned OpCode) = ret</span><br></pre></td></tr></table></figure>
<p>可以看到其中确实出现了我们想要的，如果我们对指令名字进行一个判断，就可以精确确定这些存在条件分支的地方的指令了（IR 中条件比较都是用的 <code>icmp</code> 和 <code>fcmp</code>）(对于 <code>switch</code> 和 <code>phi</code> 指令应该另外考虑)，然后再进一步去监控相关的变量应该就可以了？</p>
<p>现在我们简单修改，只打印和 <code>icmp</code> 相关的指令部分，修改 pass 如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (I.<span class="built_in">getOpcode</span>() != <span class="number">53</span>)</span><br><span class="line">    <span class="keyword">continue</span>;</span><br></pre></td></tr></table></figure>
<p>得到的运行输出为:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ clang -Xclang -load -Xclang build/skeleton/libSkeletonPass.* iftest.c</span><br><span class="line">In a <span class="keyword">function</span> called main!</span><br><span class="line">Instruction: </span><br><span class="line">  %7 = icmp eq i32 %6, 0, getValueID() = 77, getOpcode() = 53, getOpcodeName() = icmp, getOpcodeName(unsigned OpCode) = icmp</span><br><span class="line">Instruction: </span><br><span class="line">  %13 = icmp eq i32 %12, 1, getValueID() = 77, getOpcode() = 53, getOpcodeName() = icmp, getOpcodeName(unsigned OpCode) = icmp</span><br></pre></td></tr></table></figure>
<p>接下来应该考虑怎么去获取</p>
<ol>
<li>某个指令的操作数 —&gt; 直接查阅官方文档即可</li>
<li>如果是寄存器应该怎么把值拖出来—&gt;这个我还不会</li>
</ol>
<h2 id="0x04-参考链接"><a href="#0x04-参考链接" class="headerlink" title="0x04 参考链接"></a>0x04 参考链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/lfri/p/15383628.html">LLVM 1:Clang入门</a></li>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1849687">快速生成函数调用关系图</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zhouronghua/p/16220701.html">控制流图</a> <a target="_blank" rel="noopener" href="https://www.cnblogs.com/zhouronghua/p/16279465.html">数据流分析</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/hatter110/article/details/107282596">AST 学习</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cs.cornell.edu/~asampson/blog/llvm.html">IR实验流程</a></li>
<li><a target="_blank" rel="noopener" href="https://llvm.org/docs/GetElementPtr.html#why-is-the-extra-0-index-required">LLVM官网-GEPI</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/woiyyn/article/details/118670736">GEPI博客</a></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Ron</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://lucxer.tech/2022/12/23/32.LLVM%E5%8F%8Aclang%E5%85%A5%E9%97%A8/">http://lucxer.tech/2022/12/23/32.LLVM%E5%8F%8Aclang%E5%85%A5%E9%97%A8/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://lucxer.tech" target="_blank">Ron's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Fuzz/">Fuzz</a><a class="post-meta__tags" href="/tags/%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90/">静态分析</a><a class="post-meta__tags" href="/tags/%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90/">程序分析</a><a class="post-meta__tags" href="/tags/LLVM/">LLVM</a></div><div class="post_share"><div class="addthis_inline_share_toolbox"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=5fb3e45d5f9ff11c" async="async"></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.png" target="_blank"><img class="post-qr-code-img" data-lazy-src="/img/wechat.png" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.png" target="_blank"><img class="post-qr-code-img" data-lazy-src="/img/alipay.png" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/01/25/33.HEALER/"><img class="prev-cover" data-lazy-src="https://kiprey.github.io/2021/11/healer/image-20211129200131315.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">论文Healer分析和复现</div></div></a></div><div class="next-post pull-right"><a href="/2021/10/05/31.%E4%B8%A4%E4%B8%AA%E5%AF%86%E7%A0%81%E9%A2%98/"><img class="next-cover" data-lazy-src="https://cdn.jsdelivr.net/gh/qriosa/picgo-blog/img/practice_3_crypto.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">两个有意思的题</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/04/10/35.kcov与分析/" title="Syzkaller 中用到 kcov 记录覆盖分析"><img class="cover" data-lazy-src="https://cdn.jsdelivr.net/gh/qriosa/picgo-blog/img/kcov-mhtf.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-10</div><div class="title">Syzkaller 中用到 kcov 记录覆盖分析</div></div></a></div><div><a href="/2023/01/25/33.HEALER/" title="论文Healer分析和复现"><img class="cover" data-lazy-src="https://kiprey.github.io/2021/11/healer/image-20211129200131315.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-25</div><div class="title">论文Healer分析和复现</div></div></a></div><div><a href="/2023/02/13/34.Syzkaller/" title="Syzkaller部分功能点源码分析"><img class="cover" data-lazy-src="https://github.com/google/syzkaller/raw/f325deb023e4e2fb9197004be1b3da738680429c/docs/process_structure.png?raw=true" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-13</div><div class="title">Syzkaller部分功能点源码分析</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" data-lazy-src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Ron</div><div class="author-info__description">(retired) OI/Crypto, Fuzzing</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">39</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">68</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/qriosa"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/qriosa" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:chegnxiang@163.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">号外！号外！评论系统已开放！</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2"><span class="toc-number">1.</span> <span class="toc-text">0x01 写在前面</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-clang"><span class="toc-number">2.</span> <span class="toc-text">0x02 clang</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.</span> <span class="toc-text">环境配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E7%A8%8B%E5%BA%8F"><span class="toc-number">2.2.</span> <span class="toc-text">编译程序</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%E7%BC%96%E8%AF%91"><span class="toc-number">2.2.1.</span> <span class="toc-text">直接编译</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%AD%A5%E7%BC%96%E8%AF%91"><span class="toc-number">2.2.2.</span> <span class="toc-text">分步编译</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E9%A2%84%E5%A4%84%E7%90%86%E6%96%87%E4%BB%B6"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">生成预处理文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E6%B1%87%E7%BC%96%E6%96%87%E4%BB%B6"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">生成汇编文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E7%9B%AE%E6%A0%87%E6%96%87%E4%BB%B6"><span class="toc-number">2.2.2.3.</span> <span class="toc-text">生成目标文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6"><span class="toc-number">2.2.2.4.</span> <span class="toc-text">生成可执行文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8B"><span class="toc-number">2.2.2.5.</span> <span class="toc-text">查看编译过程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90-IR-%E6%96%87%E4%BB%B6"><span class="toc-number">2.2.3.</span> <span class="toc-text">生成 IR 文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#opt%E6%8C%87%E4%BB%A4"><span class="toc-number">2.2.4.</span> <span class="toc-text">opt指令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E8%A1%8C%E5%88%86%E6%9E%90"><span class="toc-number">2.3.</span> <span class="toc-text">进行分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%8D%E6%B3%95%E5%88%86%E6%9E%90"><span class="toc-number">2.3.1.</span> <span class="toc-text">词法分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%AD%E6%B3%95%E5%88%86%E6%9E%90"><span class="toc-number">2.3.2.</span> <span class="toc-text">语法分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%AD%E4%B9%89%E5%88%86%E6%9E%90"><span class="toc-number">2.3.3.</span> <span class="toc-text">语义分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%A0%E7%A7%8D%E5%85%B3%E7%B3%BB%E5%9B%BE"><span class="toc-number">2.4.</span> <span class="toc-text">几种关系图</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CFG-%E6%8E%A7%E5%88%B6%E6%B5%81%E5%9B%BE-basic-blocks"><span class="toc-number">2.4.1.</span> <span class="toc-text">CFG 控制流图 (basic blocks)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E5%9D%97-basic-blocks"><span class="toc-number">2.4.1.1.</span> <span class="toc-text">基本块 basic blocks</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%BB%E5%9B%BE"><span class="toc-number">2.4.1.2.</span> <span class="toc-text">画图</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CallGraph-%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E5%9B%BE"><span class="toc-number">2.4.2.</span> <span class="toc-text">CallGraph 函数调用图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AST%E5%9B%BE"><span class="toc-number">2.4.3.</span> <span class="toc-text">AST图</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-LLVM-Pass"><span class="toc-number">3.</span> <span class="toc-text">0x03 LLVM Pass</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E5%B0%9D%E8%AF%95"><span class="toc-number">3.1.</span> <span class="toc-text">简单尝试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%88%E8%B7%91"><span class="toc-number">3.1.1.</span> <span class="toc-text">先跑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E4%B8%80%E4%B8%8B"><span class="toc-number">3.1.2.</span> <span class="toc-text">分析一下</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E4%B8%80%E4%B8%8B"><span class="toc-number">3.1.3.</span> <span class="toc-text">修改一下</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0-IR-amp-pass"><span class="toc-number">3.2.</span> <span class="toc-text">学习 IR &amp; pass</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#LLVM-IR"><span class="toc-number">3.2.1.</span> <span class="toc-text">LLVM IR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IR-%E4%B8%AD%E7%9A%84%E9%83%A8%E5%88%86%E7%AC%A6%E5%8F%B7"><span class="toc-number">3.2.2.</span> <span class="toc-text">IR 中的部分符号</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Instruction"><span class="toc-number">3.2.3.</span> <span class="toc-text">Instruction</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LoadInst"><span class="toc-number">3.2.3.1.</span> <span class="toc-text">LoadInst</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#StoreInst"><span class="toc-number">3.2.3.2.</span> <span class="toc-text">StoreInst</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GEPI"><span class="toc-number">3.2.3.3.</span> <span class="toc-text">GEPI</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8-Pass-%E4%B8%AD%E6%A3%80%E6%9F%A5-IR"><span class="toc-number">3.2.4.</span> <span class="toc-text">在 Pass 中检查 IR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8-pass-%E5%81%9A%E4%B8%80%E4%BA%9B%E6%9C%89%E8%B6%A3%E7%9A%84%E4%BA%8B%E6%83%85"><span class="toc-number">3.2.5.</span> <span class="toc-text">在 pass 做一些有趣的事情</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dyn-cast-%E5%92%8C-isa"><span class="toc-number">3.2.6.</span> <span class="toc-text">dyn_cast 和 isa</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CallGraphSCCPass"><span class="toc-number">3.2.7.</span> <span class="toc-text">CallGraphSCCPass</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linking-With-a-Runtime-Library"><span class="toc-number">3.2.8.</span> <span class="toc-text">Linking With a Runtime Library</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Annotations-%E6%B3%A8%E9%87%8A%E4%BF%A1%E6%81%AF"><span class="toc-number">3.2.9.</span> <span class="toc-text">Annotations 注释信息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%92%E6%A1%A9%E6%9D%A1%E4%BB%B6%E5%88%86%E6%94%AF%E8%AF%AD%E5%8F%A5"><span class="toc-number">3.3.</span> <span class="toc-text">插桩条件分支语句</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">3.4.</span> <span class="toc-text">0x04 参考链接</span></a></li></ol></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/10/18/38.CVE-2018-1160%20%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/" title="CVE-2018-1160 调试复现分析"><img data-lazy-src="https://cdn.jsdelivr.net/gh/qriosa/picgo-blog/img/CVE-2018-1160-control_flow_hijack_chart.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CVE-2018-1160 调试复现分析"/></a><div class="content"><a class="title" href="/2023/10/18/38.CVE-2018-1160%20%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/" title="CVE-2018-1160 调试复现分析">CVE-2018-1160 调试复现分析</a><time datetime="2023-10-18T12:42:19.000Z" title="发表于 2023-10-18 20:42:19">2023-10-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/10/18/39.CVE-2024-2961%20%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%BF%87%E7%A8%8B/" title="CVE-2024-2961 调试复现分析"><img data-lazy-src="https://cdn.jsdelivr.net/gh/qriosa/picgo-blog/img/CVE-2024-2961.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CVE-2024-2961 调试复现分析"/></a><div class="content"><a class="title" href="/2023/10/18/39.CVE-2024-2961%20%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%BF%87%E7%A8%8B/" title="CVE-2024-2961 调试复现分析">CVE-2024-2961 调试复现分析</a><time datetime="2023-10-18T12:42:19.000Z" title="发表于 2023-10-18 20:42:19">2023-10-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/09/21/37.CVE-2021-30145%20%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/" title="CVE-2021-30145 调试复现分析"><img data-lazy-src="https://cdn.jsdelivr.net/gh/qriosa/picgo-blog/img/CVE-2021-30145-process.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CVE-2021-30145 调试复现分析"/></a><div class="content"><a class="title" href="/2023/09/21/37.CVE-2021-30145%20%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/" title="CVE-2021-30145 调试复现分析">CVE-2021-30145 调试复现分析</a><time datetime="2023-09-21T04:11:11.000Z" title="发表于 2023-09-21 12:11:11">2023-09-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/08/12/36.CVE-2018-6789%20%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/" title="CVE-2018-6789 调试复现分析"><img data-lazy-src="https://cdn.jsdelivr.net/gh/qriosa/picgo-blog/img/CVE-2018-6789-process.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CVE-2018-6789 调试复现分析"/></a><div class="content"><a class="title" href="/2023/08/12/36.CVE-2018-6789%20%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/" title="CVE-2018-6789 调试复现分析">CVE-2018-6789 调试复现分析</a><time datetime="2023-08-12T13:12:41.000Z" title="发表于 2023-08-12 21:12:41">2023-08-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/04/10/35.kcov%E4%B8%8E%E5%88%86%E6%9E%90/" title="Syzkaller 中用到 kcov 记录覆盖分析"><img data-lazy-src="https://cdn.jsdelivr.net/gh/qriosa/picgo-blog/img/kcov-mhtf.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Syzkaller 中用到 kcov 记录覆盖分析"/></a><div class="content"><a class="title" href="/2023/04/10/35.kcov%E4%B8%8E%E5%88%86%E6%9E%90/" title="Syzkaller 中用到 kcov 记录覆盖分析">Syzkaller 中用到 kcov 记录覆盖分析</a><time datetime="2023-04-10T14:12:12.000Z" title="发表于 2023-04-10 22:12:12">2023-04-10</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Ron</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to <a target="_blank" rel="noopener" href="https://qriosa.github.io">Ron's home</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="algolia-search"><div class="search-dialog"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.spacingElementById('content-inner')
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.spacingElementById('content-inner')
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/algolia.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> {preloader.endLoading()})</script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    loader: {
      source: {
        '[tex]/amsCd': '[tex]/amscd'
      }
    },
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        addClass: [200,() => {
          document.querySelectorAll('mjx-container:not([display=\'true\']').forEach( node => {
            const target = node.parentNode
            if (!target.classList.contains('has-jax')) {
              target.classList.add('mathjax-overflow')
            }
          })
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>function loadValine () {
  function initValine () {
    let initData = {
      el: '#vcomment',
      appId: 'kvdp8zac8n33pNjoPPrELp1b-MdYXbMMI',
      appKey: 't7PV1NwrBX5XxIJWIt4SBNak',
      placeholder: 'Please leave your footprints',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'en',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
    }

    if (true) { 
      initData.requiredFields= ('nick'.split(','))
    }
    
    if (false) {
      const otherData = false
      initData = Object.assign({}, initData, otherData)
    }
    
    const valine = new Valine(initData)
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.querySelector('#vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  '#config_change',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '.js-pjax'
]

if (false) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  if (typeof gtag === 'function') {
    gtag('config', '', {'page_path': window.location.pathname});
  }

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // Analytics
  if (false) {
    MtaH5.pgv()
  }

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})


document.addEventListener('pjax:send', function () {
  typeof preloader === 'object' && preloader.initLoading()
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})</script><script>(function(){
  const bp = document.createElement('script');
  const curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https') {
    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  bp.dataset.pjax = ''
  const s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})()</script></div></body></html>